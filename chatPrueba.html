<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Supabase Avanzado</title>
<style>

        * { box-sizing: border-box; }
    body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    margin: 0; 
    padding: 0; 
    background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%); 
    color: #333; 
    overflow: hidden; /* Prevenir scroll en toda la p√°gina */
    height: 100vh;
  }

  /* LOGIN STYLES */
  #loginContainer {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 20px;
  }

  #loginBox {
    background: rgba(255, 255, 255, 0.95);
    padding: 40px;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    width: 100%;
    max-width: 420px;
    animation: slideIn 0.4s ease-out;
  }

  

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

    #loginBox h2 {
    text-align: center;
    margin-bottom: 10px;
    color: #8B4513;
    font-size: 28px;
  }

  body.dark #loginBox h2 {
    color: #8b9bff;
  }

  #loginBox p {
    text-align: center;
    margin-bottom: 30px;
    opacity: 0.8;
    font-size: 14px;
  }

  .inputGroup {
    margin-bottom: 20px;
  }

  .inputGroup label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 14px;
  }

  .inputGroup input {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 15px;
    transition: all 0.3s;
  }

  

  .inputGroup input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .passwordWrapper {
    position: relative;
  }

  .passwordWrapper input {
    padding-right: 45px;
  }

  .togglePassword {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    font-size: 18px;
    user-select: none;
  }

  .passwordRequirements {
    margin-top: 8px;
    padding: 10px;
    background: rgba(0, 0, 0, 0.05);
    border-radius: 8px;
    font-size: 12px;
  }

  

  .requirement {
    display: flex;
    align-items: center;
    margin: 5px 0;
  }

  .requirement.valid {
    color: #10b981;
  }

  .requirement.invalid {
    color: #ef4444;
    opacity: 0.6;
  }

  .checkboxGroup {
    display: flex;
    align-items: center;
    margin: 20px 0;
  }

  .checkboxGroup input[type="checkbox"] {
    width: 18px;
    height: 18px;
    margin-right: 10px;
    cursor: pointer;
  }

  .checkboxGroup label {
    cursor: pointer;
    font-size: 14px;
    margin: 0;
  }

    .loginButton {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(139, 69, 19, 0.4);
  }

  .loginButton:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
  }

  .loginButton:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .errorMessage {
    background: #fee;
    color: #c33;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 14px;
    display: none;
  }

  

  #container { 
    display: flex; 
    height: 100vh;
    overflow: hidden; /* Evitar scroll en el contenedor principal */
  }

            #sidebar {
    width: 230px; background: brown;
    padding: 15px; overflow-y: auto;
    border-right: 1px solid rgba(255, 255, 255, 0.5);
    box-sizing: border-box;
    min-height: 0; /* Importante para scroll en flex container */
  }


    .userItem {
    display: flex; align-items: center;
    margin-bottom: 12px; padding: 10px;
    border-radius: 12px;
    background: rgba(210, 180, 140, 0.3);
    transition: all 0.3s;
    border: 1px solid rgba(139, 69, 19, 0.1);
  }
  
  .userItem:hover {
    background: rgba(210, 180, 140, 0.5);
    transform: translateX(5px);
  }


      .avatar {
    width: 40px; height: 40px; border-radius: 50%;
    background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
    display: flex;
    align-items: center; justify-content: center;
    color: #fff; font-weight: bold; margin-right: 12px;
    font-size: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .avatar-top {
    width: 80px; height: 80px; border-radius: 50%;
    background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
    display: flex;
    align-items: center; justify-content: center;
    color: #fff; font-weight: bold;
    font-size: 18px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  }

      #chatArea { 
    flex: 1; 
    display: flex; 
    flex-direction: column; 
    min-height: 0; /* Importante para scroll interno */
    overflow: hidden; /* Contener el contenido */
  }

    #topBar {
    padding: 15px 20px; 
    border-bottom: 1px solid rgba(139, 69, 19, 0.2);
    display: flex; 
    justify-content: space-between;
    align-items: center;
    background: rgba(245, 222, 179, 0.3);
  }
  
  #usernameDisplay {
    font-weight: 600;
    color: white;
    font-size: 20px;
  }

  #chat { 
    padding: 20px; 
    flex: 1; 
    overflow-y: auto; 
    overflow-x: hidden; /* Eliminar scroll horizontal */
    background: rgb(100,30,30);
    display: flex;
    flex-direction: column;
    gap: 10px;
    min-height: 0; /* Importante para que el scroll funcione en flex containers */
  }
  
      .msg {
    margin-bottom: 15px;
    padding: 14px 16px 16px 16px;
    border-radius: 18px;
    max-width: 70%;
    min-width: 120px;
    position: relative;
    word-wrap: break-word;
    line-height: 1.4;
    box-sizing: border-box;
    overflow: visible;
  }
  
    .msg.own {
    background: transparent;
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 4px;
  }
  
  .msg.other {
    background: transparent;
    color: white;
    margin-right: auto;
    border-bottom-left-radius: 4px;
  }
  
  .msg-time {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.9);
    margin-top: 8px;
    text-align: right;
    opacity: 0.95;
    display: block;
    clear: both;
    font-weight: 500;
    letter-spacing: 0.3px;
  }
  
  .msg-user {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 4px;
    color: white;
  }
  
  /* Estilos para contenedor de mensaje con avatar */
  .msg-container {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    position: relative;
  }
  
  .msg-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 14px;
    flex-shrink: 0;
    margin-top: 4px;
  }
  
  .msg-content-wrapper {
    flex: 1;
    min-width: 0;
  }
  
  .msg-bubble {
    background: brown;
    padding: 10px 14px;
    border-radius: 18px;
    position: relative;
    max-width: 100%;
    min-width: 50px;
  }
  
  .msg.own .msg-bubble {
    background: #8B4513;
    border-bottom-right-radius: 4px;
  }
  
  .msg.other .msg-bubble {
    background: #A0522D;
    border-top-left-radius: 4px;
  }
  
  .msg-text {
    word-wrap: break-word;
    word-break: break-word;
    overflow-wrap: break-word;
    white-space: pre-wrap;
    line-height: 1.5;
    color: white;
  }
  
  .msg-footer {
    display: flex;
    justify-content: flex-end;
    margin-top: 4px;
  }
  
  .msg-content {
    word-wrap: break-word;
    word-break: break-word;
    overflow-wrap: break-word;
    white-space: pre-wrap;
    max-width: 100%;
    overflow: visible;
    line-height: 1.5;
    margin: 4px 0;
  }
  
      /* Estilos para bot√≥n de eliminar */
  .delete-btn {
    position: relative;
    top: 5px;
    right: 5px;
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: white;
    opacity: 0.8;
    transition: all 0.2s;
    z-index: 10;
    backdrop-filter: blur(2px);
  }
  
    .delete-btn:hover {
    opacity: 1;
    background: rgba(255, 69, 0, 0.3);
    border-color: rgba(255, 69, 0, 0.5);
    transform: scale(1.15);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }
  
  /* Estilos especiales para bot√≥n de eliminar de administrador */
  .admin-delete-btn {
    background: rgba(255, 215, 0, 0.2);
    border-color: rgba(255, 215, 0, 0.5);
  }
  
  .admin-delete-btn:hover {
    background: rgba(255, 69, 0, 0.4);
    border-color: rgba(255, 69, 0, 0.7);
  }
  
  /* Badge de administrador */
  .admin-badge {
    display: inline-block;
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
    color: #8B4513;
    font-size: 10px;
    padding: 1px 4px;
    border-radius: 4px;
    margin-left: 4px;
    vertical-align: middle;
    cursor: help;
  }
  
      /* Estilos para mensajes eliminados */
  .msg.deleted {
    opacity: 0.65;
    background: linear-gradient(135deg, rgba(139, 69, 19, 0.4) 0%, rgba(160, 82, 45, 0.4) 100%) !important;
  }
  
  /* Estilos espec√≠ficos para mensajes eliminados por administrador */
  .msg.deleted-by-admin {
    background: linear-gradient(135deg, rgba(139, 69, 19, 0.5) 0%, rgba(160, 82, 45, 0.5) 100%) !important;
    border-left: 3px solid rgba(255, 215, 0, 0.5);
  }
  
  .msg.deleted .msg-content {
    font-style: italic;
    opacity: 0.9;
    color: rgba(255, 255, 255, 0.8) !important;
  }
  
  .msg.deleted .msg-user {
    opacity: 0.8;
  }
  
  .msg.deleted .msg-time {
    opacity: 0.7;
    color: rgba(255, 255, 255, 0.7) !important;
  }
  
  /* Informaci√≥n de eliminaci√≥n por administrador */
  .delete-info {
    font-size: 10px !important;
    opacity: 0.8;
    margin-top: 2px;
    font-style: italic;
    color: rgba(255, 215, 0, 0.9) !important;
  }
  
  
  
  * {
    box-sizing: border-box;
    max-width: 100%;
  }


    #typing { 
    padding: 8px 20px; 
    font-style: italic; 
    opacity: 0.9; 
    color: white;
    font-size: 13px;
    background: rgba(139, 69, 19, 0.7);
    border-radius: 0 0 10px 10px;
    margin: 0 20px;
  }

      #inputArea {
    display: flex; 
    flex-direction: column;
    padding: 15px; 
    border-top: 1px solid rgba(139, 69, 19, 0.2);
    background: rgba(245, 222, 179, 0.2);
    gap: 8px;
    position: relative;
  }
  
  .input-row {
    display: flex;
    gap: 10px;
    width: 100%;
  }

  input {
    flex: 1; 
    padding: 12px 16px; 
    border-radius: 20px;
    border: 1px solid rgba(139, 69, 19, 0.3);
    font-size: 14px;
    background: white;
    transition: all 0.3s;
  }
  
  input:focus {
    outline: none;
    border-color: #8B4513;
    box-shadow: 0 0 0 2px rgba(139, 69, 19, 0.1);
  }
  
  input:disabled {
    background: #f5f5f5;
    color: #999;
    cursor: not-allowed;
  }

    button {
    margin-left: 10px; padding: 10px 16px;
    border: none; background: #8B4513; color: white;
    border-radius: 8px; cursor: pointer;
    transition: all 0.3s;
  }
  
  button:hover {
    background: #A0522D;
    transform: translateY(-2px);
  }
  
  button:disabled {
    background: #D2B48C;
    cursor: not-allowed;
    transform: none;
  }
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginContainer">
  <div id="loginBox">
    <h2>üîê Iniciar Sesi√≥n</h2>
    <p>Bienvenido al Chat</p>
    
    <div id="errorMessage" class="errorMessage"></div>
    
    <div class="inputGroup">
    <label for="loginUsername">Usuario (m√°x 12 d√≠gitos)</label>
    <input type="text" id="loginUsername" placeholder="@usuario" autocomplete="username" maxlength="12" oninput="validateUsernameLength()">
  </div>
    
    <div class="inputGroup">
      <label for="loginPassword">Contrase√±a</label>
      <div class="passwordWrapper">
        <input type="password" id="loginPassword" placeholder="Contrase√±a segura" autocomplete="current-password">
        <span class="togglePassword" onclick="togglePasswordVisibility()">üëÅÔ∏è</span>
      </div>
      <div class="passwordRequirements" id="passwordRequirements" style="display: none;">
        <div class="requirement" id="req-uppercase">
          <span>‚úó</span> <span style="margin-left: 8px;">Al menos una may√∫scula</span>
        </div>
        <div class="requirement" id="req-lowercase">
          <span>‚úó</span> <span style="margin-left: 8px;">Al menos una min√∫scula</span>
        </div>
        <div class="requirement" id="req-number">
          <span>‚úó</span> <span style="margin-left: 8px;">Al menos un n√∫mero</span>
        </div>
        <div class="requirement" id="req-special">
          <span>‚úó</span> <span style="margin-left: 8px;">Al menos un car√°cter especial (!@#$%^&*)</span>
        </div>
      </div>
    </div>
    
    <div class="inputGroup" id="displayNameGroup">
      <label for="loginDisplayName">Nombre para mostrar</label>
      <input type="text" id="loginDisplayName" placeholder="Tu nombre" autocomplete="name">
    </div>
    
    <div class="checkboxGroup">
      <input type="checkbox" id="rememberMe">
      <label for="rememberMe">Recordar inicio de sesi√≥n</label>
    </div>
    
        <button class="loginButton" onclick="handleLogin()">Iniciar Sesi√≥n</button>
    <div style="margin-top: 20px; text-align: center;">
      <button onclick="setupDatabase()" style="background: #666; padding: 8px 16px; font-size: 12px; margin: 5px;">Configurar Base de Datos</button>
      <button onclick="testChatFunctionality()" style="background: #4CAF50; padding: 8px 16px; font-size: 12px; margin: 5px;">Probar Chat</button>
    </div>
  </div>
</div>

<!-- CHAT SCREEN -->
<div id="container" style="display: none;">
  <div id="sidebar">
    <h3 style="color: white;">Conectados</h3>
    <div id="usersList"></div>
  </div>

  <div id="chatArea">
        <div id="topBar">
      <div style="display: flex; align-items: center; gap: 12px;">
        <div id="userAvatarTop" class="avatar-top"></div>
        <div>
          <span id="usernameDisplay"></span>
          <div id="userStatus" style="font-size: 12px; opacity: 0.8; color: #09ff00;">Conectado</div>
        </div>
      </div>
      <div>
        <button onclick="changeName()">Cambiar nombre</button>
        <button onclick="logout()" style="background: #ef4444;">Cerrar sesi√≥n</button>
      </div>
    </div>

    <div id="chat"></div>
    <div id="typing"></div>

                <div id="inputArea">
      <div class="input-row">
                <input id="messageInput" placeholder="Escribe un mensaje (m√°x 1000 caracteres)..." oninput="sendTyping(true); updateCharCounter()" onkeypress="if(event.key === 'Enter') { event.preventDefault(); sendMessage(); }" maxlength="1000">
        <button onclick="sendMessage()">Enviar</button>
      </div>
      <div id="charCounter" style="font-size: 11px; color: white; text-align: right; padding: 2px 12px 0 0; display: none; font-weight: 500;">0/1000 caracteres</div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ============================================================
   SUPABASE CONFIG
============================================================ */
const SUPABASE_URL = "https://hgangxlyytnxdndwjvgf.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnYW5neGx5eXRueGRuZHdqdmdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNDgyNTksImV4cCI6MjA4MDkyNDI1OX0.VL5GgpkfV102lJc_NEi0Ga15gDiNSV92jSIRMuH-5hI";
console.log('Configurando Supabase...');
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
console.log('Supabase configurado:', db ? 'OK' : 'ERROR');
// Probar conexi√≥n a Supabase y verificar estructura
async function testSupabaseConnection() {
  try {
    console.log('üîå Probando conexi√≥n a Supabase...');
    console.log('URL:', SUPABASE_URL);
    
    // Probar conexi√≥n b√°sica
    const { data, error, count } = await db.from('messages').select('*', { count: 'exact' }).limit(1);
    
    if (error) {
      console.error('‚ùå Error de conexi√≥n a Supabase:', error);
      console.error('Detalles:', error.message);
      
      // Mostrar instrucciones si la tabla no existe
      if (error.message.includes('does not exist') || error.message.includes('no existe') || error.message.includes('relation')) {
        console.warn('‚ö†Ô∏è La tabla messages no existe. Se necesita configurar la base de datos.');
        
        // Mostrar alerta
        setTimeout(() => {
          alert('‚ö†Ô∏è ATENCI√ìN: La tabla messages no existe en Supabase.\n\nPara solucionar:\n1. Ve a tu proyecto Supabase\n2. Abre el Editor SQL\n3. Ejecuta el archivo configurar_bd.sql o crear_tabla_messages_completa.sql');
        }, 1000);
      } else {
        // Otro tipo de error
        setTimeout(() => {
          alert('‚ö†Ô∏è Error de conexi√≥n a Supabase:\n' + error.message);
        }, 1000);
      }
    } else {
      console.log('‚úÖ Conexi√≥n a Supabase exitosa');
      console.log('Total de mensajes:', count || 0);
      
      // Verificar si la tabla tiene las columnas necesarias
      if (data && data.length > 0) {
        const firstMessage = data[0];
        console.log('Primer mensaje:', firstMessage);
        
        const hasDeletedField = 'deleted' in firstMessage;
        const hasIdField = 'id' in firstMessage;
        
        console.log('Tiene campo deleted:', hasDeletedField);
        console.log('Tiene campo id:', hasIdField);
        
        if (!hasDeletedField) {
          console.warn('‚ö†Ô∏è La tabla messages no tiene la columna "deleted".');
          
          setTimeout(() => {
            alert('‚ö†Ô∏è La tabla messages necesita actualizaci√≥n.\n\nEjecuta configurar_bd.sql en Supabase para agregar las columnas faltantes.');
          }, 1500);
        } else {
          console.log('‚úÖ Estructura de la base de datos correcta');
        }
      } else {
        console.log('‚ÑπÔ∏è No hay mensajes en la base de datos');
      }
    }
  } catch (error) {
    console.error('‚ùå Error en test de conexi√≥n:', error);
    console.error('Stack:', error.stack);
    
    setTimeout(() => {
      alert('‚ùå Error cr√≠tico al conectar con Supabase:\n' + error.message);
    }, 1000);
  }
}

// Ejecutar test cuando se cargue la p√°gina
window.addEventListener('load', () => {
  console.log('üöÄ P√°gina cargada, iniciando diagn√≥stico...');
  
  // Ejecutar diagn√≥stico completo
  setTimeout(async () => {
    await testSupabaseConnection();
    
    // Verificar tambi√©n otros componentes
    console.log('üîç Verificando componentes de la p√°gina...');
    console.log('Elemento #chat:', document.getElementById('chat') ? '‚úÖ Existe' : '‚ùå No existe');
    console.log('Elemento #messageInput:', document.getElementById('messageInput') ? '‚úÖ Existe' : '‚ùå No existe');
    console.log('Elemento #loginContainer:', document.getElementById('loginContainer') ? '‚úÖ Existe' : '‚ùå No existe');
    
    // Verificar variables globales
    console.log('üåê Variables globales:');
    console.log('- Supabase URL:', SUPABASE_URL ? '‚úÖ Configurada' : '‚ùå No configurada');
    console.log('- Supabase Client:', db ? '‚úÖ Inicializado' : '‚ùå No inicializado');
    
    // Si estamos en el chat, probar carga de mensajes
    if (document.getElementById('container').style.display !== 'none') {
      console.log('üí¨ Chat visible, probando carga de mensajes...');
      await loadMessages();
    }
  }, 1000);
});

/* ============================================================
   VALIDACI√ìN DE CONTRASE√ëA SEGURA
============================================================ */
function validatePassword(password) {
  const requirements = {
    uppercase: /[A-Z]/.test(password),
    lowercase: /[a-z]/.test(password),
    number: /[0-9]/.test(password),
    special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
  };
  
  return {
    valid: requirements.uppercase && requirements.lowercase && requirements.number && requirements.special,
    requirements
  };
}

/* ============================================================
   VALIDACI√ìN DE USERNAME (M√ÅX 12 D√çGITOS)
============================================================ */
function validateUsernameLength() {
  const usernameInput = document.getElementById('loginUsername');
  const username = usernameInput.value.trim();
  
  if (username.length > 12) {
    usernameInput.value = username.substring(0, 12);
    showError('El usuario no puede tener m√°s de 12 d√≠gitos');
  }
}

/* ============================================================
   CONTADOR DE CARACTERES PARA MENSAJES
============================================================ */
function updateCharCounter() {
  const input = document.getElementById('messageInput');
  const text = input.value;
  const counter = document.getElementById('charCounter');
  
  if (counter) {
    const remaining = 1000 - text.length;
    counter.textContent = `${text.length}/1000 caracteres`;
    
    // Mostrar/ocultar contador
    if (text.length > 0) {
      counter.style.display = 'block';
    } else {
      counter.style.display = 'none';
    }
    
    // Cambiar color seg√∫n el l√≠mite
    if (remaining < 100) {
      counter.style.color = '#f59e0b';
    } else if (remaining < 50) {
      counter.style.color = '#ef4444';
    } else {
      counter.style.color = '#666';
    }
  }
}

function updatePasswordRequirements(password) {
  const validation = validatePassword(password);
  const reqDiv = document.getElementById('passwordRequirements');
  
  if (password.length > 0) {
    reqDiv.style.display = 'block';
    
    document.getElementById('req-uppercase').className = validation.requirements.uppercase ? 'requirement valid' : 'requirement invalid';
    document.getElementById('req-lowercase').className = validation.requirements.lowercase ? 'requirement valid' : 'requirement invalid';
    document.getElementById('req-number').className = validation.requirements.number ? 'requirement valid' : 'requirement invalid';
    document.getElementById('req-special').className = validation.requirements.special ? 'requirement valid' : 'requirement invalid';
    
    document.getElementById('req-uppercase').querySelector('span').textContent = validation.requirements.uppercase ? '‚úì' : '‚úó';
    document.getElementById('req-lowercase').querySelector('span').textContent = validation.requirements.lowercase ? '‚úì' : '‚úó';
    document.getElementById('req-number').querySelector('span').textContent = validation.requirements.number ? '‚úì' : '‚úó';
    document.getElementById('req-special').querySelector('span').textContent = validation.requirements.special ? '‚úì' : '‚úó';
  } else {
    reqDiv.style.display = 'none';
  }
}

function togglePasswordVisibility() {
  const input = document.getElementById('loginPassword');
  const toggle = document.querySelector('.togglePassword');
  
  if (input.type === 'password') {
    input.type = 'text';
    toggle.textContent = 'üôà';
  } else {
    input.type = 'password';
    toggle.textContent = 'üëÅÔ∏è';
  }
}

// Event listener para validaci√≥n en tiempo real
document.addEventListener('DOMContentLoaded', () => {
  const passwordInput = document.getElementById('loginPassword');
  if (passwordInput) {
    // Este event listener se manejar√° en la l√≥gica principal
    // para diferenciar entre usuarios nuevos y existentes
  }
});

/* ============================================================
   SISTEMA DE LOGIN
============================================================ */
let userid = null;
let displayName = null;
let userPassword = null;

/* ============================================================
   VARIABLES DEL SISTEMA ANTI-SPAM Y TYPING
   (Declaradas aqu√≠ para que est√©n disponibles antes de que
    se llamen las funciones que las usan)
============================================================ */
// Variables del sistema anti-spam
let messageCount = 0;
let messageTimer = null;
let spamBlocked = false;
let spamTimer = null;
const MAX_MESSAGES_PER_SECOND = 5;
const SPAM_BLOCK_TIME = 60; // 60 segundos de bloqueo

// Variables del sistema de typing
let typingTimeout;
let typingDebounceTimer;
let lastTypingSent = 0;
const TYPING_DEBOUNCE_TIME = 1000; // 1 segundo entre actualizaciones
const TYPING_STOP_TIME = 2000; // 2 segundos para marcar como dej√≥ de escribir

function showError(message) {
  const errorDiv = document.getElementById('errorMessage');
  errorDiv.textContent = message;
  errorDiv.style.display = 'block';
  setTimeout(() => {
    errorDiv.style.display = 'none';
  }, 5000);
}

// Nueva funci√≥n para mostrar notificaciones en el chat
function showChatNotification(message, isError = false) {
  console.log('üì¢ Notificaci√≥n en chat:', message, 'Error:', isError);
  
  // Crear o reutilizar un elemento de notificaci√≥n en el chat
  let notification = document.getElementById('chatNotification');
  
  if (!notification) {
    notification = document.createElement('div');
    notification.id = 'chatNotification';
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-width: 300px;
      text-align: center;
      animation: slideInRight 0.3s ease-out;
      display: none;
    `;
    document.body.appendChild(notification);
    
    // Agregar la animaci√≥n CSS si no existe
    if (!document.getElementById('chatNotificationStyle')) {
      const style = document.createElement('style');
      style.id = 'chatNotificationStyle';
      style.textContent = `
        @keyframes slideInRight {
          from {
            opacity: 0;
            transform: translateX(100%);
          }
          to {
            opacity: 1;
            transform: translateX(0);
          }
        }
      `;
      document.head.appendChild(style);
    }
  }
  
  // Estilos seg√∫n el tipo de mensaje
  if (isError) {
    notification.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
    notification.style.color = 'white';
    notification.style.border = '1px solid rgba(239, 68, 68, 0.3)';
  } else {
    notification.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
    notification.style.color = 'white';
    notification.style.border = '1px solid rgba(16, 185, 129, 0.3)';
  }
  
  notification.textContent = message;
  notification.style.display = 'block';
  
  // Ocultar despu√©s de 3 segundos
  setTimeout(() => {
    notification.style.display = 'none';
  }, 3000);
}

async function handleLogin() {
  const usernameInput = document.getElementById('loginUsername').value.trim();
  const passwordInput = document.getElementById('loginPassword').value;
  const displayNameInput = document.getElementById('loginDisplayName').value.trim();
  const rememberMe = document.getElementById('rememberMe').checked;
  
  // Validaciones b√°sicas
  if (!usernameInput) {
    showError('Por favor ingresa un usuario');
    return;
  }
  
  if (!passwordInput) {
    showError('Por favor ingresa una contrase√±a');
    return;
  }
  
  // Validar formato de usuario
  let formattedUsername = usernameInput.toLowerCase().replace(/\s+/g, '');
  if (!formattedUsername.startsWith('@')) {
    formattedUsername = '@' + formattedUsername;
  }
  
  try {
    // Verificar si el usuario existe en la base de datos
    const { data: existingUser } = await db
      .from('users')
      .select('*')
      .eq('username', formattedUsername)
      .maybeSingle();
    
    if (existingUser) {
      // USUARIO EXISTENTE: validar contrase√±a contra la BD
      if (existingUser.password !== passwordInput) {
        showError('Contrase√±a incorrecta');
        return;
      }
      
      // Usar el nombre de la BD si no se proporcion√≥ uno nuevo
      userid = formattedUsername;
      userPassword = passwordInput;
      
      if (displayNameInput && displayNameInput !== existingUser.display_name) {
        // Si el usuario escribi√≥ un nombre diferente, usarlo y actualizar BD
        displayName = displayNameInput;
        await db
          .from('users')
          .update({ display_name: displayName })
          .eq('username', formattedUsername);
      } else {
        // Usar el nombre almacenado en la BD
        displayName = existingUser.display_name;
      }
      
    } else {
      // NUEVO USUARIO: validar contrase√±a segura y pedir nombre
      const passwordValidation = validatePassword(passwordInput);
      if (!passwordValidation.valid) {
        showError('La contrase√±a no cumple con los requisitos de seguridad');
        return;
      }
      
      if (!displayNameInput) {
        showError('Por favor ingresa tu nombre para mostrar');
        return;
      }
      
      // Crear nuevo usuario
      userid = formattedUsername;
      displayName = displayNameInput;
      userPassword = passwordInput;
      
      // Guardar en la base de datos
      await db.from('users').insert({
        username: userid,
        display_name: displayName,
        password: userPassword
      });
    }
    
    // Guardar credenciales seg√∫n "Recordar inicio de sesi√≥n"
    if (rememberMe) {
      localStorage.setItem('userid', userid);
      localStorage.setItem('display_name', displayName);
      localStorage.setItem('user_password', btoa(userPassword));
      localStorage.setItem('remember_session', 'true');
    } else {
      sessionStorage.setItem('userid', userid);
      sessionStorage.setItem('display_name', displayName);
    }
    
    // Mostrar chat y ocultar login
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('container').style.display = 'flex';
    
    // Inicializar chat
    initChat();
    
  } catch (error) {
    console.error('Error en el login:', error);
    showError('Error al procesar el login. Intenta nuevamente.');
  }
}

// Verificar sesi√≥n guardada al cargar
async function checkSavedSession() {
  const rememberSession = localStorage.getItem('remember_session');
  
  if (rememberSession === 'true') {
    const savedUserid = localStorage.getItem('userid');
    const savedDisplayName = localStorage.getItem('display_name');
    const savedPassword = localStorage.getItem('user_password');
    
    if (savedUserid && savedDisplayName && savedPassword) {
      try {
        // Verificar en base de datos
        const { data: existingUser } = await db
          .from('users')
          .select('*')
          .eq('username', savedUserid)
          .maybeSingle();
        
        if (existingUser) {
          const decryptedPassword = atob(savedPassword);
          // Validar contrase√±a contra la base de datos
          if (existingUser.password === decryptedPassword) {
            userid = savedUserid;
            displayName = savedDisplayName;
            userPassword = decryptedPassword;
            
            // Auto-login exitoso - NO mostrar pantalla de login
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('container').style.display = 'flex';
            
            // Asegurar que el chat est√© completamente inicializado
            setTimeout(() => {
              initChat();
            }, 100);
            return true;
          } else {
            // Contrase√±a incorrecta - limpiar datos inv√°lidos
            localStorage.removeItem('userid');
            localStorage.removeItem('display_name');
            localStorage.removeItem('user_password');
            localStorage.removeItem('remember_session');
          }
        } else {
          // Usuario no existe en BD - limpiar datos
          localStorage.removeItem('userid');
          localStorage.removeItem('display_name');
          localStorage.removeItem('user_password');
          localStorage.removeItem('remember_session');
        }
      } catch (error) {
        console.error('Error al verificar sesi√≥n:', error);
        // Limpiar datos inv√°lidos
        localStorage.removeItem('userid');
        localStorage.removeItem('display_name');
        localStorage.removeItem('user_password');
        localStorage.removeItem('remember_session');
      }
    }
  }
  return false;
}

function initChat() {
  console.log('=== INICIANDO CHAT ===');
  console.log('Usuario:', userid);
  console.log('Nombre:', displayName);
  console.log('Elemento #chat existe:', document.getElementById('chat') ? 'S√≠' : 'No');
  
  // Verificar si es administrador
  const isAdmin = userid === '@proyectoja';
  
  // Mostrar nombre de usuario con indicador de administrador si corresponde
  let usernameHTML = `${displayName}`;
  if (isAdmin) {
    usernameHTML += ' <span style="color: gold; font-size: 14px;" title="Administrador">Admin</span>';
  }
  usernameHTML += `<br><small style="opacity:0.7">${userid}</small>`;
  
  document.getElementById('usernameDisplay').innerHTML = usernameHTML;
  
  // Mostrar avatar en el top bar con indicador de administrador
  const avatarTop = document.getElementById('userAvatarTop');
  if (avatarTop && displayName) {
    avatarTop.textContent = displayName.charAt(0).toUpperCase();
    
    // Agregar estilo especial para administrador
    if (isAdmin) {
      avatarTop.style.background = 'linear-gradient(135deg, #DAA520 0%, #FFD700 100%)';
      avatarTop.style.boxShadow = '0 3px 6px rgba(218, 165, 32, 0.4)';
      
      // Agregar badge de administrador
      const adminBadge = document.createElement('div');
      adminBadge.style.cssText = 'position: absolute; bottom: -3px; right: -3px; background: gold; color: #8B4513; width: 14px; height: 14px; border-radius: 50%; font-size: 9px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 1px solid #8B4513;';
      adminBadge.textContent = 'A';
      adminBadge.title = 'Administrador';
      avatarTop.style.position = 'relative';
      avatarTop.appendChild(adminBadge);
    }
  }
  
    connectUser();
  loadMessages();
  loadOnlineUsers();
  
  // Inicializar suscripci√≥n a typing
  initTypingSubscription();
  
  // Inicializar suscripci√≥n a mensajes en tiempo real
  initMessagesSubscription();
  
  // Inicializar sistema anti-spam
  if (messageTimer) {
    clearInterval(messageTimer);
  }
  messageTimer = setInterval(() => {
    messageCount = 0;
    updateSpamCounter();
  }, 1000);
  
    // Crear contador de spam si no existe
  let counter = document.getElementById('spamCounter');
  if (!counter) {
    counter = document.createElement('div');
    counter.id = 'spamCounter';
    counter.style.cssText = 'padding: 10px 15px; background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.25) 100%); border-radius: 10px; font-size: 14px; font-weight: bold; margin-bottom: 12px; text-align: center; display: none; border: 1px solid rgba(239, 68, 68, 0.3);';
    document.getElementById('inputArea').insertBefore(counter, document.getElementById('inputArea').firstChild);
  }
    updateSpamCounter();
  
  // Inicializar contador de caracteres
  updateCharCounter();
  
  // Inicializar sistema anti-spam
  if (messageTimer) {
    clearInterval(messageTimer);
  }
  messageTimer = setInterval(() => {
    messageCount = 0;
    updateSpamCounter();
  }, 1000);
  
    // Agregar mensaje de prueba para verificar estilos
  setTimeout(() => {
    const testMessage = {
      username: 'Sistema',
      content: '¬°Bienvenido al chat! Los mensajes se mostrar√°n aqu√≠.',
      created_at: new Date().toISOString()
    };
    addMessage(testMessage);
  }, 500);
  
  // Enfocar input de mensaje
  document.getElementById('messageInput').focus();
}

// Funci√≥n para inicializar la suscripci√≥n a typing
function initTypingSubscription() {
  console.log('Inicializando suscripci√≥n a typing...');
  
  try {
    // Cancelar suscripci√≥n anterior si existe
    if (window.typingChannel) {
      db.removeChannel(window.typingChannel);
    }
    
    // Crear nueva suscripci√≥n
    window.typingChannel = db.channel('typing_updates_' + userid);
    
    window.typingChannel
      .on(
        'postgres_changes',
        { 
          event: '*', 
          schema: 'public', 
          table: 'typing' 
        },
        (payload) => {
          console.log('üì¢ EVENTO TYPING RECIBIDO:', payload);
          
          // Ignorar nuestros propios eventos
          if (payload.new && payload.new.userid === userid) {
            console.log('Ignorando evento propio');
            return;
          }
          
          // Mostrar qui√©n est√° escribiendo
          if (payload.new && payload.new.typing) {
            const nombre = payload.new.username || payload.new.userid || 'Alguien';
            console.log(`${nombre} est√° escribiendo‚Ä¶`);
            document.getElementById('typing').textContent = 
              `${nombre} est√° escribiendo‚Ä¶`;
            
            // Limpiar despu√©s de 3 segundos
            setTimeout(() => {
              document.getElementById('typing').textContent = '';
            }, 3000);
          } else {
            console.log('Typing detenido');
            document.getElementById('typing').textContent = '';
          }
        }
      )
      .subscribe((status) => {
        console.log('Estado de suscripci√≥n typing:', status);
      });
      
    console.log('‚úÖ Suscripci√≥n a typing inicializada');
  } catch (error) {
    console.error('‚ùå Error al inicializar suscripci√≥n a typing:', error);
    }
}

// Funci√≥n para inicializar la suscripci√≥n a mensajes en tiempo real
function initMessagesSubscription() {
  console.log('üîî Inicializando suscripci√≥n a mensajes en tiempo real...');
  
  try {
    // Cancelar suscripci√≥n anterior si existe
    if (window.messageSubscription) {
      db.removeChannel(window.messageSubscription);
    }
    
    // Crear nuevo canal
    window.messageSubscription = db.channel('realtime_messages_' + userid + '_' + Date.now());
    
    window.messageSubscription
      .on("postgres_changes", { 
        event: "INSERT", 
        schema: "public", 
        table: "messages" 
      }, (payload) => {
        console.log('üì® NUEVO MENSAJE RECIBIDO (INSERT):', payload);
        console.log('Contenido:', payload.new.content);
        console.log('Usuario:', payload.new.username);
        
        // Verificar que no sea nuestro propio mensaje reci√©n enviado
        const isOwnMessage = displayName && payload.new.username === displayName;
        console.log('¬øEs nuestro mensaje?', isOwnMessage);
        
        // Siempre agregar el mensaje
        addMessage(payload.new);
      })
      .on("postgres_changes", { 
        event: "UPDATE", 
        schema: "public", 
        table: "messages" 
      }, (payload) => {
        console.log('Mensaje actualizado:', payload);
        // Actualizar el mensaje en la interfaz si existe
        const messageElement = document.querySelector(`.msg[data-message-id="${payload.new.id}"]`);
        if (messageElement) {
                // Si el mensaje fue eliminado, actualizar la interfaz
      if (payload.new.deleted || payload.new.content === '[Mensaje eliminado]') {
        const textElement = messageElement.querySelector('.msg-text');
        if (textElement) {
          textElement.textContent = '[Mensaje eliminado]';
        }
        
        // Agregar informaci√≥n de eliminaci√≥n por administrador si corresponde
        if (payload.new.deleted_by_admin && payload.new.deleted_by === '@proyectoja') {
          // Verificar si ya existe la informaci√≥n de eliminaci√≥n
          let deleteInfo = messageElement.querySelector('.delete-info');
          if (!deleteInfo) {
            deleteInfo = document.createElement('div');
            deleteInfo.className = 'delete-info';
            deleteInfo.style.cssText = 'font-size: 10px; opacity: 0.8; margin-top: 2px; font-style: italic; color: rgba(255, 215, 0, 0.9);';
            deleteInfo.textContent = 'Eliminado por administrador';
            
            // Insertar en el msg-bubble
            const msgBubble = messageElement.querySelector('.msg-bubble');
            if (msgBubble) {
              msgBubble.appendChild(deleteInfo);
            }
          }
          
          // Agregar clase especial para mensajes eliminados por administrador
          messageElement.classList.add('deleted-by-admin');
        }
        
        // Remover el bot√≥n de eliminar
        const deleteBtn = messageElement.querySelector('.delete-btn');
        if (deleteBtn) {
          deleteBtn.remove();
        }
        
        // Agregar clase para estilo de mensaje eliminado
        messageElement.classList.add('deleted');
      }
        } else {
          // Si el elemento no existe, agregarlo (podr√≠a ser un mensaje antiguo que se actualiz√≥)
          addMessage(payload.new);
        }
      })
      .subscribe((status) => {
        console.log('Estado de suscripci√≥n a mensajes:', status);
        if (status === 'SUBSCRIBED') {
          console.log('‚úÖ Suscrito correctamente a mensajes en tiempo real');
        } else if (status === 'CHANNEL_ERROR') {
          console.error('‚ùå Error en la suscripci√≥n a mensajes');
        }
      });
      
    console.log('‚úÖ Suscripci√≥n a mensajes inicializada');
  } catch (error) {
    console.error('‚ùå Error al inicializar suscripci√≥n a mensajes:', error);
  }
}

// Configurar l√≥gica para mostrar/ocultar campo de nombre
document.addEventListener('DOMContentLoaded', async () => {
  const usernameInput = document.getElementById('loginUsername');
  const displayNameGroup = document.getElementById('displayNameGroup');
  const passwordInput = document.getElementById('loginPassword');
  
  // Funci√≥n para verificar si el usuario existe
  async function checkUserExists(username) {
    if (!username) return null;
    
    let formattedUsername = username.toLowerCase().replace(/\s+/g, '');
    if (!formattedUsername.startsWith('@')) {
      formattedUsername = '@' + formattedUsername;
    }
    
    try {
      const { data: existingUser } = await db
        .from('users')
        .select('display_name, password')
        .eq('username', formattedUsername)
        .maybeSingle();
      
      return existingUser;
    } catch (error) {
      console.error('Error al verificar usuario:', error);
      return null;
    }
  }
  
  // Evento cuando el usuario escribe en el campo de username
  usernameInput.addEventListener('input', async () => {
    const username = usernameInput.value.trim();
    
    if (!username) {
      // Si no hay username, mostrar campo de nombre
      displayNameGroup.style.display = 'block';
      document.getElementById('loginDisplayName').value = '';
      document.getElementById('passwordRequirements').style.display = 'none';
      return;
    }
    
    // Esperar un momento para no hacer muchas consultas
    setTimeout(async () => {
      const existingUser = await checkUserExists(username);
      
      if (existingUser) {
        // Usuario existe - usar nombre almacenado, NO pedirlo
        displayNameGroup.style.display = 'none';
        document.getElementById('loginDisplayName').value = existingUser.display_name || '';
        
        // Para usuarios existentes, NO mostrar requisitos de contrase√±a
        document.getElementById('passwordRequirements').style.display = 'none';
      } else {
        // Usuario NO existe - mostrar campo de nombre (obligatorio para nuevo usuario)
        displayNameGroup.style.display = 'block';
        document.getElementById('loginDisplayName').value = '';
        
        // Para nuevos usuarios, mostrar requisitos si hay contrase√±a
        if (passwordInput.value.length > 0) {
          updatePasswordRequirements(passwordInput.value);
        }
      }
    }, 300);
  });
  
  // Evento para contrase√±a
  passwordInput.addEventListener('input', async (e) => {
    const username = usernameInput.value.trim();
    
    if (!username) {
      // Si no hay username, mostrar requisitos (asumimos nuevo usuario)
      updatePasswordRequirements(e.target.value);
      return;
    }
    
    const existingUser = await checkUserExists(username);
    
    if (!existingUser) {
      // Solo mostrar requisitos para NUEVOS usuarios
      updatePasswordRequirements(e.target.value);
    } else {
      // Ocultar requisitos para usuarios EXISTENTES
      document.getElementById('passwordRequirements').style.display = 'none';
    }
  });
  
            // Verificar sesi√≥n guardada al cargar
  const hasValidSession = await checkSavedSession();
  if (!hasValidSession) {
    // NO hay sesi√≥n v√°lida - mostrar pantalla de login
    document.getElementById('loginContainer').style.display = 'flex';
    document.getElementById('container').style.display = 'none';
  } else {
    // Hay sesi√≥n v√°lida - asegurar que el chat est√© visible
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('container').style.display = 'flex';
    // Inicializar el chat (checkSavedSession ya llam√≥ a initChat dentro del setTimeout)
    // Pero llamamos de nuevo para asegurar que todo se inicialice correctamente
    setTimeout(() => {
      if (userid && displayName) {
        initChat();
      }
    }, 200);
  }
});

/* ============================================================
   NOTA: Sistema de tema claro/oscuro removido seg√∫n solicitud
============================================================ */

/* ============================================================
   CAMBIAR NOMBRE Y CERRAR SESI√ìN
============================================================ */
function changeName() {
  const nuevo = prompt("Nuevo nombre:");
  if (!nuevo) return;

  displayName = nuevo.trim();
  
  // Actualizar en la base de datos
  db.from('users')
    .update({ display_name: displayName })
    .eq('username', userid)
    .then(() => {
      console.log('Nombre actualizado en la base de datos');
    })
    .catch(error => {
      console.error('Error al actualizar nombre:', error);
    });
  
  // Actualizar seg√∫n el tipo de sesi√≥n
  if (localStorage.getItem('remember_session') === 'true') {
    localStorage.setItem('display_name', displayName);
  } else {
    sessionStorage.setItem('display_name', displayName);
  }

  document.getElementById('usernameDisplay').innerHTML =
    `${displayName}<br><small style="opacity:0.7">${userid}</small>`;
  
  // Actualizar avatar en el top bar
  const avatarTop = document.getElementById('userAvatarTop');
  if (avatarTop && displayName) {
    avatarTop.textContent = displayName.charAt(0).toUpperCase();
  }

  connectUser();
}

function logout() {
  if (confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
    // Limpiar localStorage y sessionStorage
    localStorage.removeItem('userid');
    localStorage.removeItem('display_name');
    localStorage.removeItem('user_password');
    localStorage.removeItem('remember_session');
    sessionStorage.clear();
    
    // Desconectar usuario
    if (userid) {
      db.from('online_users').delete().eq('userid', userid);
    }
    
    // Mostrar solo usuario y contrase√±a (limpiar nombre y ocultar campo)
    document.getElementById('loginUsername').value = userid || '';
    document.getElementById('loginPassword').value = '';
    document.getElementById('loginDisplayName').value = '';
    document.getElementById('displayNameGroup').style.display = 'block';
    document.getElementById('rememberMe').checked = false;
    document.getElementById('passwordRequirements').style.display = 'none';
    
    // Mostrar login y ocultar chat
    document.getElementById('loginContainer').style.display = 'flex';
    document.getElementById('container').style.display = 'none';
    
    // Resetear variables
    userid = null;
    displayName = null;
    userPassword = null;
  }
}

/* ============================================================
   ONLINE USERS - MEJORADO
============================================================ */
async function connectUser() {
  try {
    console.log("Conectando usuario:", { userid, displayName });
    
    // Primero, verificar si el usuario ya existe
    const { data: existingUser, error: checkError } = await db
      .from("online_users")
      .select("*")
      .eq("userid", userid)
      .maybeSingle();
    
    if (checkError) {
      console.error("Error al verificar usuario existente:", checkError);
    }
    
    console.log("Usuario existente:", existingUser);
    
    if (existingUser) {
      // Actualizar usuario existente
      const updateData = {
        username: userid,
        display_name: displayName,
        last_seen: new Date().toISOString()
      };
      console.log("Actualizando usuario con:", updateData);
      
      const { error: updateError } = await db
        .from("online_users")
        .update(updateData)
        .eq("userid", userid);
        
      if (updateError) {
        console.error("Error al actualizar usuario:", updateError);
      } else {
        console.log("Usuario actualizado correctamente");
      }
    } else {
      // Insertar nuevo usuario
      const insertData = {
        userid,
        username: userid,
        display_name: displayName,
        last_seen: new Date().toISOString(),
        connected_at: new Date().toISOString()
      };
      console.log("Insertando nuevo usuario con:", insertData);
      
      const { error: insertError } = await db
        .from("online_users")
        .insert(insertData);
        
      if (insertError) {
        console.error("Error al insertar usuario:", insertError);
      } else {
        console.log("Usuario insertado correctamente");
      }
    }
  } catch (error) {
    console.error("Error al conectar usuario:", error);
  }
}

// actualizar cada 10s
setInterval(connectUser, 10000);

function renderAvatar(name) {
  return name ? name.charAt(0).toUpperCase() : "?";
}

async function loadOnlineUsers() {
  try {
    console.log("Cargando usuarios conectados...");
    const now = Date.now();
    
    // Intentar cargar usuarios, pero continuar incluso si hay error
    let data = [];
    let error = null;
    
    try {
      const result = await db.from("online_users").select("*");
      data = result.data || [];
      error = result.error;
    } catch (fetchError) {
      console.warn("No se pudo cargar usuarios (tabla puede no existir):", fetchError.message);
      data = [];
    }
    
    if (error) {
      console.warn("Error al cargar usuarios (continuando):", error.message);
    }
    
    console.log("Usuarios en la base de datos:", data);

        // Intentar borrar inactivos (m√°s de 30 segundos)
    try {
      const expired = data.filter(u => u.last_seen && (now - new Date(u.last_seen)) > 30000);
      for (const u of expired) {
        if (u.userid) {
          await db.from("online_users").delete().eq("userid", u.userid);
        }
      }
    } catch (deleteError) {
      console.warn("No se pudieron eliminar usuarios inactivos:", deleteError.message);
    }

    const active = data.filter(u => (now - new Date(u.last_seen)) <= 30000);
    const list = document.getElementById("usersList");
    list.innerHTML = "";

    // Mostrar mensaje si no hay usuarios
    if (active.length === 0) {
      list.innerHTML = '<div style="padding: 10px; text-align: center; opacity: 0.7;">No hay usuarios conectados</div>';
      return;
    }

    // Ordenar alfab√©ticamente por display_name
    active.sort((a, b) => a.display_name?.localeCompare(b.display_name || ""));

    // Mostrar contador
    const title = document.querySelector("#sidebar h3");
    if (title) {
      title.textContent = `Conectados (${active.length})`;
    }

    active.forEach(u => {
      const div = document.createElement("div");
      div.className = "userItem";

      // Resaltar al usuario actual
      if (u.userid === userid) {
        div.style.backgroundColor = "rgba(70, 130, 180, 0.3)";
        div.style.borderLeft = "3px solid steelblue";
      }

            // Determinar si es administrador
      const isAdminUser = u.userid === '@proyectoja';
      const isCurrentUserAdmin = userid === '@proyectoja';
      
      // Color de fondo diferente para administrador
      let avatarBackground = '#5f9ea0';
      if (u.userid === userid) {
        avatarBackground = '#4682b4';
      } else if (isAdminUser) {
        avatarBackground = '#DAA520';
      }
      
      div.innerHTML = `
        <div class="avatar" style="background: ${avatarBackground};">
          ${renderAvatar(u.display_name)}
          ${isAdminUser ? '<div style="position: absolute; bottom: -2px; right: -2px; background: gold; color: #8B4513; width: 12px; height: 12px; border-radius: 50%; font-size: 8px; display: flex; align-items: center; justify-content: center;">A</div>' : ''}
        </div>
        <div>
          <b style="color:white";>${u.display_name || "Sin nombre"}</b>
          ${isAdminUser ? ' <span style="color: gold; font-size: 10px;">Admin</span>' : ''}
          ${u.userid === userid ? ' <small style="color: steelblue;">(T√∫)</small>' : ''}<br>
          <small style="opacity: 0.7; color: white;">${u.userid}</small>
        </div>
      `;

      list.appendChild(div);
    });
  } catch (error) {
    console.error("Error en loadOnlineUsers:", error);
  }
}

// Cargar usuarios al inicio y cada 5 segundos
loadOnlineUsers();
setInterval(loadOnlineUsers, 5000);

// Suscribirse a cambios en tiempo real
try {
  db.channel("online_users_changes")
    .on(
      "postgres_changes",
      { 
        event: "*", 
        schema: "public", 
        table: "online_users" 
      },
      () => {
        loadOnlineUsers();
      }
    )
    .subscribe();
} catch (error) {
  console.error("Error al suscribirse a online_users:", error);
}

/* ============================================================
   CHAT CON L√çMITE DE MENSAJES
============================================================ */
// VARIABLE CONFIGURABLE: N√∫mero m√°ximo de mensajes a mostrar/guardar
const MAX_MESSAGES = 20;

function formatTime(t) {
  return new Date(t).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
}

function formatTimeAMPM(t) {
  const date = new Date(t);
  let hours = date.getHours();
  let minutes = date.getMinutes();
  const ampm = hours >= 12 ? 'PM' : 'AM';
  
  hours = hours % 12;
  hours = hours ? hours : 12; // La hora 0 debe ser 12
  minutes = minutes < 10 ? '0' + minutes : minutes;
  
  return `${hours}:${minutes} ${ampm}`;
}

function addMessage(msg) {
  console.log('A√±adiendo mensaje:', msg);
  
  // Validar que el mensaje tenga los datos necesarios
  if (!msg || !msg.username) {
    console.error('Mensaje inv√°lido:', msg);
    return;
  }
  
  const div = document.createElement("div");
  
  // Determinar si es nuestro mensaje o de otro usuario
  const isOwnMessage = displayName && msg.username === displayName;
  div.className = isOwnMessage ? "msg own" : "msg other";
  
  // Verificar si el usuario actual es administrador
  const isAdmin = userid === '@proyectoja';
  // Verificar si el autor del mensaje es administrador
  const isMessageAuthorAdmin = msg.username === 'proyectoja' || msg.username === '@proyectoja' || msg.userid === '@proyectoja';
  
  // Agregar ID del mensaje como atributo data
  if (msg.id) {
    div.dataset.messageId = msg.id;
  }
  
  // Verificar si el mensaje est√° eliminado
  const isDeleted = msg.deleted || msg.content === '[Mensaje eliminado]';
  
  // Verificar si fue eliminado por administrador
  const deletedByAdmin = msg.deleted_by_admin || false;
  const deletedBy = msg.deleted_by || '';
  
  let messageContent = msg.content || '';
  let deleteInfo = '';
  
  if (isDeleted) {
    messageContent = '[Mensaje eliminado]';
    div.classList.add('deleted');
    
    // Agregar informaci√≥n adicional si fue eliminado por administrador
    if (deletedByAdmin && deletedBy === '@proyectoja') {
      deleteInfo = '<div class="delete-info" style="font-size: 10px; opacity: 0.8; margin-top: 2px; font-style: italic;">Eliminado por administrador</div>';
      div.classList.add('deleted-by-admin');
    }
  }

  // Determinar si mostrar bot√≥n de eliminar:
  // - Para mensajes propios no eliminados
  // - Para administrador en cualquier mensaje no eliminado
  const showDeleteButton = !isDeleted && msg.id && (isOwnMessage || isAdmin);
  
  // Estilo especial para bot√≥n de administrador
  const deleteButtonClass = isAdmin && !isOwnMessage ? 'delete-btn admin-delete-btn' : 'delete-btn';
  
    // Obtener inicial para el avatar (evitar 'P' de 'proyectoja')
  let userInitial = '?';
  if (msg.username) {
    // Si el username comienza con '@', tomar el segundo car√°cter
    if (msg.username.startsWith('@')) {
      userInitial = msg.username.length > 1 ? msg.username.charAt(1).toUpperCase() : '?';
    } else {
      userInitial = msg.username.charAt(0).toUpperCase();
    }
    // Si es 'P' de 'proyectoja', usar 'A' para administrador
    if (userInitial === 'P' && (msg.username.toLowerCase().includes('proyecto') || isMessageAuthorAdmin)) {
      userInitial = 'A';
    }
  }
  
  // Crear HTML con avatar estilo WhatsApp (SOLO para mensajes de otros)
  div.innerHTML = `
    <div class="msg-container">
      ${!isOwnMessage ? `<div class="msg-avatar">${userInitial}</div>` : '<div class="msg-avatar" style="visibility: hidden;"></div>'}
      <div class="msg-content-wrapper">
        ${!isOwnMessage ? `<div class="msg-user">${msg.username || 'Usuario desconocido'}
          ${isMessageAuthorAdmin ? ' <span class="admin-badge" title="Administrador">üëë</span>' : ''}
        </div>` : ''}
        <div class="msg-bubble">
          <div class="msg-text">${messageContent}</div>
          ${deleteInfo}
          <div class="msg-footer">
            <div class="msg-time">${msg.created_at ? formatTimeAMPM(msg.created_at) : '--:-- --'}</div>
          </div>
        </div>
      </div>
      ${showDeleteButton ? '<button class="' + deleteButtonClass + '" onclick="deleteMessage(' + msg.id + ', this, ' + isAdmin + ')">üóëÔ∏è</button>' : ''}
    </div>
  `;

  const chatDiv = document.getElementById("chat");
  if (chatDiv) {
    chatDiv.appendChild(div);
    
    // Mantener solo los √∫ltimos MAX_MESSAGES mensajes en la interfaz
    const allMessages = chatDiv.querySelectorAll('.msg');
    if (allMessages.length > MAX_MESSAGES) {
      // Eliminar el mensaje m√°s antiguo (el primero)
      allMessages[0].remove();
    }
    
    chatDiv.scrollTo({
      top: chatDiv.scrollHeight,
      behavior: "smooth"
    });
    
    console.log('Mensaje a√±adido correctamente');
  } else {
    console.error('No se encontr√≥ el elemento #chat');
  }
}

// Funci√≥n para eliminar un mensaje
async function deleteMessage(messageId, buttonElement, isAdmin = false) {
  if (!messageId) {
    console.error('ID de mensaje no v√°lido');
    return;
  }
  
  let confirmMessage = '¬øEst√°s seguro de que quieres eliminar este mensaje?';
  if (isAdmin && userid === '@proyectoja') {
    confirmMessage = '¬øEst√°s seguro de que quieres eliminar este mensaje como administrador?\n\n‚ö†Ô∏è Esta acci√≥n eliminar√° el mensaje para todos los usuarios.';
  }
  
  if (!confirm(confirmMessage)) {
    return;
  }
  
    try {
    // Preparar datos de actualizaci√≥n
    const updateData = { 
      content: '[Mensaje eliminado]',
      deleted: true,
      deleted_at: new Date().toISOString()
    };
    
    // Si es administrador, agregar informaci√≥n adicional
    if (isAdmin && userid === '@proyectoja') {
      updateData.deleted_by_admin = true;
      updateData.deleted_by = userid;
    }
    
    // Actualizar el mensaje en la base de datos
    const { error } = await db
      .from('messages')
      .update(updateData)
      .eq('id', messageId);
    
    if (error) {
      console.error('Error al eliminar mensaje:', error);
      showError('Error al eliminar el mensaje');
      return;
    }
    
        // Encontrar el elemento del mensaje y actualizarlo localmente
    const messageElement = buttonElement.closest('.msg');
    if (messageElement) {
      // Actualizar el contenido del mensaje
      const textElement = messageElement.querySelector('.msg-text');
      if (textElement) {
        textElement.textContent = '[Mensaje eliminado]';
      }
      
      // Agregar informaci√≥n de eliminaci√≥n por administrador si corresponde
      if (isAdmin && userid === '@proyectoja') {
        const deleteInfo = document.createElement('div');
        deleteInfo.className = 'delete-info';
        deleteInfo.style.cssText = 'font-size: 10px; opacity: 0.8; margin-top: 2px; font-style: italic; color: rgba(255, 215, 0, 0.9);';
        deleteInfo.textContent = 'Eliminado por administrador';
        
        const msgBubble = messageElement.querySelector('.msg-bubble');
        if (msgBubble) {
          msgBubble.appendChild(deleteInfo);
        }
        
        messageElement.classList.add('deleted-by-admin');
      }
      
      // Remover el bot√≥n de eliminar
      const deleteBtn = messageElement.querySelector('.delete-btn');
      if (deleteBtn) {
        deleteBtn.remove();
      }
      
      // Agregar clase para estilo de mensaje eliminado
      messageElement.classList.add('deleted');
      
      console.log('Mensaje eliminado localmente');
        }
    
    // Mostrar mensaje de √©xito diferente para administrador
    if (isAdmin && userid === '@proyectoja') {
      showError('‚úÖ Mensaje eliminado por administrador');
    } else {
      showError('Mensaje eliminado correctamente');
    }
  } catch (error) {
    console.error('Error en deleteMessage:', error);
    
    // Mensaje de error m√°s espec√≠fico
    if (error.message && error.message.includes('column')) {
      showError('Error: La base de datos no est√° configurada correctamente. Ejecuta configurar_bd.sql en Supabase.');
    } else {
      showError('Error al eliminar el mensaje');
    }
  }
}

async function loadMessages() {
  console.log('üì• Cargando mensajes...');
  
  try {
    // Cargar solo los √∫ltimos MAX_MESSAGES mensajes
    console.log('Consultando mensajes...');
    const { data, error } = await db
      .from("messages")
      .select("*")
      .order("id", { ascending: false })
      .limit(MAX_MESSAGES);
      
    if (error) {
      console.error('‚ùå Error al cargar mensajes:', error);
      console.error('Detalles:', error.message);
      showError('Error al cargar mensajes: ' + error.message);
      return;
    }
    
    console.log(`‚úÖ ${data ? data.length : 0} mensajes cargados`);
    if (data && data.length > 0) {
      console.log('Ejemplo de mensaje:', data[0]);
    }
    
    if (data && data.length > 0) {
      // Mostrar en orden inverso (m√°s recientes primero) o en orden normal
      const chatDiv = document.getElementById("chat");
      if (chatDiv) {
        console.log('Elemento #chat encontrado, limpiando...');
        chatDiv.innerHTML = ''; // Limpiar antes de cargar
        
        // Ordenar por ID ascendente para mostrar del m√°s antiguo al m√°s nuevo
        data.sort((a, b) => a.id - b.id).forEach(addMessage);
        console.log('Mensajes mostrados en el chat');
      } else {
        console.error('No se encontr√≥ el elemento #chat');
      }
    } else {
      console.log('No hay mensajes para mostrar');
      const chatDiv = document.getElementById("chat");
      if (chatDiv) {
        chatDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #666; font-style: italic;">No hay mensajes a√∫n. ¬°S√© el primero en escribir!</div>';
      }
    }
  } catch (error) {
    console.error('Error en loadMessages:', error);
  }
}

// Funci√≥n para limpiar mensajes antiguos de la base de datos
async function cleanOldMessages() {
  try {
    // Obtener todos los mensajes ordenados por ID descendente
    const { data: allMessages } = await db
      .from("messages")
      .select("id")
      .order("id", { ascending: false });
      
    if (allMessages && allMessages.length > MAX_MESSAGES) {
      // Encontrar el ID que est√° en la posici√≥n MAX_MESSAGES
      const lastIdToKeep = allMessages[MAX_MESSAGES - 1].id;
      
      // Eliminar todos los mensajes con ID menor al que queremos mantener
      const { error } = await db
        .from("messages")
        .delete()
        .lt("id", lastIdToKeep);
        
      if (error) {
        console.error("Error al eliminar mensajes antiguos:", error);
      } else {
        console.log(`Mensajes antiguos limpiados (manteniendo √∫ltimos ${MAX_MESSAGES})`);
      }
    }
  } catch (error) {
    console.error("Error en cleanOldMessages:", error);
  }
}

// Cancelar suscripci√≥n anterior si existe
if (window.messageSubscription) {
  db.removeChannel(window.messageSubscription);
}

// Crear nuevo canal
// window.messageSubscription = db.channel('realtime_messages_' + Date.now()); // COMENTADO: Suscripci√≥n duplicada

window.messageSubscription
  .on("postgres_changes", { 
    event: "INSERT", 
    schema: "public", 
    table: "messages" 
  }, (payload) => {
    console.log('üì® NUEVO MENSAJE RECIBIDO (INSERT):', payload);
    console.log('Contenido:', payload.new.content);
    console.log('Usuario:', payload.new.username);
    
    // Verificar que no sea nuestro propio mensaje reci√©n enviado
    const isOwnMessage = displayName && payload.new.username === displayName;
    console.log('¬øEs nuestro mensaje?', isOwnMessage);
    
    // Siempre agregar el mensaje
    addMessage(payload.new);
  })
    .on("postgres_changes", { 
    event: "UPDATE", 
    schema: "public", 
    table: "messages" 
  }, (payload) => {
    console.log('Mensaje actualizado:', payload);
    // Actualizar el mensaje en la interfaz si existe
    const messageElement = document.querySelector(`.msg[data-message-id="${payload.new.id}"]`);
    if (messageElement) {
            // Si el mensaje fue eliminado, actualizar la interfaz
      if (payload.new.deleted || payload.new.content === '[Mensaje eliminado]') {
        const textElement = messageElement.querySelector('.msg-text');
        if (textElement) {
          textElement.textContent = '[Mensaje eliminado]';
        }
        
        // Agregar informaci√≥n de eliminaci√≥n por administrador si corresponde
        if (payload.new.deleted_by_admin && payload.new.deleted_by === '@proyectoja') {
          // Verificar si ya existe la informaci√≥n de eliminaci√≥n
          let deleteInfo = messageElement.querySelector('.delete-info');
          if (!deleteInfo) {
            deleteInfo = document.createElement('div');
            deleteInfo.className = 'delete-info';
            deleteInfo.style.cssText = 'font-size: 10px; opacity: 0.8; margin-top: 2px; font-style: italic; color: rgba(255, 215, 0, 0.9);';
            deleteInfo.textContent = 'Eliminado por administrador';
            
            // Insertar en el msg-bubble
            const msgBubble = messageElement.querySelector('.msg-bubble');
            if (msgBubble) {
              msgBubble.appendChild(deleteInfo);
            }
          }
          
          // Agregar clase especial para mensajes eliminados por administrador
          messageElement.classList.add('deleted-by-admin');
        }
        
        // Remover el bot√≥n de eliminar
        const deleteBtn = messageElement.querySelector('.delete-btn');
        if (deleteBtn) {
          deleteBtn.remove();
        }
        
        // Agregar clase para estilo de mensaje eliminado
        messageElement.classList.add('deleted');
      }
    } else {
      // Si el elemento no existe, agregarlo (podr√≠a ser un mensaje antiguo que se actualiz√≥)
      addMessage(payload.new);
    }
  })
  .subscribe((status) => {
    console.log('Estado de suscripci√≥n a mensajes:', status);
    if (status === 'SUBSCRIBED') {
      console.log('‚úÖ Suscrito correctamente a mensajes en tiempo real');
    }
  });

/* ============================================================
   SISTEMA ANTI-SPAM
============================================================ */
// NOTA: Las variables ya est√°n declaradas al principio del script
// para evitar errores de referencia

function updateSpamCounter() {
  const counter = document.getElementById('spamCounter');
  if (counter) {
    if (spamBlocked) {
      const timeLeft = Math.ceil((spamTimer - Date.now()) / 1000);
      counter.textContent = `Bloqueado por spam: ${timeLeft}s`;
      counter.style.color = '#ef4444';
      
      if (timeLeft <= 0) {
        spamBlocked = false;
        counter.style.display = 'none';
        document.getElementById('messageInput').disabled = false;
        document.querySelector('#inputArea button').disabled = false;
        clearInterval(window.spamInterval);
      }
    } else {
      counter.textContent = `Mensajes: ${messageCount}/${MAX_MESSAGES_PER_SECOND}`;
      counter.style.color = messageCount >= MAX_MESSAGES_PER_SECOND ? '#f59e0b' : '#10b981';
    }
  }
}

function checkSpam() {
  messageCount++;
  
  if (messageCount >= MAX_MESSAGES_PER_SECOND && !spamBlocked) {
    // Bloquear por spam
    spamBlocked = true;
    spamTimer = Date.now() + (SPAM_BLOCK_TIME * 1000);
    
    // Crear contador si no existe
    let counter = document.getElementById('spamCounter');
    if (!counter) {
      counter = document.createElement('div');
      counter.id = 'spamCounter';
      counter.style.cssText = 'padding: 8px 15px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; font-size: 14px; font-weight: bold; margin-bottom: 10px; text-align: center;';
      document.getElementById('inputArea').insertBefore(counter, document.getElementById('inputArea').firstChild);
    }
    
    // Deshabilitar input y bot√≥n
    document.getElementById('messageInput').disabled = true;
    document.querySelector('#inputArea button').disabled = true;
    
    // Iniciar contador regresivo
    updateSpamCounter();
    window.spamInterval = setInterval(updateSpamCounter, 1000);
    
    // Mostrar alerta
    showError(`¬°Demasiados mensajes! Bloqueado por ${SPAM_BLOCK_TIME} segundos.`);
    return true;
  }
  
  updateSpamCounter();
  return false;
}

async function sendMessage() {
    console.log('üöÄ Funci√≥n sendMessage() llamada');
    console.log('Variables globales:', { userid, displayName, userPassword });
    
    if (spamBlocked) {
      console.log('‚ùå Bloqueado por spam');
      showChatNotification('Espera a que termine el bloqueo por spam', true);
      return;
    }
    
    const inp = document.getElementById("messageInput");
    console.log('Input encontrado:', inp ? 'S√≠' : 'No');
    if (!inp) {
      console.error('‚ùå No se encontr√≥ el input de mensaje');
      showChatNotification('Error: No se encontr√≥ el campo de mensaje', true);
      return;
    }
    
    const text = inp.value.trim();
    console.log('Texto a enviar:', text);
    if (!text) {
      console.log('‚ö†Ô∏è Texto vac√≠o, no se env√≠a');
      return;
    }

    // Verificar l√≠mite de caracteres
    if (text.length > 1000) {
      console.log('‚ùå Texto demasiado largo:', text.length);
      showChatNotification('El mensaje no puede tener m√°s de 1000 caracteres', true);
      inp.value = text.substring(0, 1000);
      return;
    }
    
    // Eliminar enlaces del texto
    const cleanText = text.replace(/https?:\/\/[^\s]+/g, '[enlace eliminado]').replace(/www\.[^\s]+/g, '[enlace eliminado]');
    console.log('Texto limpio:', cleanText);
    
    // Verificar spam
    if (checkSpam()) {
      console.log('‚ùå Bloqueado por sistema anti-spam');
      return;
    }

    try {
    console.log('üì§ Intentando enviar mensaje a Supabase...');
    console.log('Usuario (displayName):', displayName);
    console.log('UserID:', userid);
    
    // Verificar que displayName no sea null o undefined
    if (!displayName) {
      console.error('‚ùå ERROR: displayName es null o undefined');
      showChatNotification('Error: No se ha configurado el nombre de usuario', true);
      return;
    }
    
    // Intentar insertar con estructura m√≠nima primero
    const messageData = {
      username: displayName,
      content: cleanText,
      created_at: new Date().toISOString()
    };
    
    console.log('Datos a insertar:', messageData);
    
    const { data, error } = await db.from("messages")
      .insert(messageData)
      .select();
    
    if (error) {
      console.error('‚ùå Error al insertar mensaje:', error);
      console.error('Detalles:', error.message);
      
      // Intentar sin el campo deleted si falla
      if (error.message.includes('column') && error.message.includes('deleted')) {
        console.log('‚ö†Ô∏è Intentando sin campo deleted...');
        delete messageData.deleted;
        
        const { data: data2, error: error2 } = await db.from("messages")
          .insert(messageData)
          .select();
          
        if (error2) {
          showChatNotification("Error al enviar: " + error2.message, true);
          return;
        }
        
        console.log('‚úÖ Mensaje insertado (sin campo deleted):', data2);
        showChatNotification('‚úÖ Mensaje enviado (modo compatible)');
      } else {
        showChatNotification("Error al enviar: " + error.message, true);
        return;
      }
    } else {
      console.log('‚úÖ Mensaje insertado correctamente:', data);
      showChatNotification('‚úÖ Mensaje enviado');
    }
    
    inp.value = "";
    sendTyping(false);
    
    // Limpiar mensajes antiguos despu√©s de enviar uno nuevo
    setTimeout(cleanOldMessages, 500);
    
    // Enfocar el input despu√©s de enviar
    inp.focus();
  } catch (error) {
    console.error("‚ùå Error en sendMessage:", error);
    console.error("Stack:", error.stack);
        showChatNotification("Error al enviar el mensaje. Intenta nuevamente.", true);
  }
}

/* ============================================================
   TYPING - MEJORADO COMO WHATSAPP
============================================================ */
// NOTA: Las variables ya est√°n declaradas al principio del script
// para evitar errores de referencia

async function sendTyping(state = true) {
  try {
    const now = Date.now();
    
    // Debounce: evitar enviar muchas actualizaciones en poco tiempo
    if (state && (now - lastTypingSent) < TYPING_DEBOUNCE_TIME) {
      clearTimeout(typingDebounceTimer);
      typingDebounceTimer = setTimeout(() => sendTyping(true), TYPING_DEBOUNCE_TIME);
      return;
    }
    
    clearTimeout(typingTimeout);
    clearTimeout(typingDebounceTimer);
    
    if (!userid || !displayName) {
      return;
    }

    // Solo actualizar si el estado cambi√≥
    const typingData = {
      userid: userid,
      username: displayName,
      typing: state,
      updated_at: new Date().toISOString()
    };
    
    // Upsert usando userid como primary key
    const { error } = await db
      .from('typing')
      .upsert(typingData, { onConflict: 'userid' });
      
    if (!error) {
      lastTypingSent = now;
    }

    // Configurar timeout para establecer typing a false despu√©s de dejar de escribir
    if (state) {
      typingTimeout = setTimeout(async () => {
        const falseData = {
          userid: userid,
          username: displayName,
          typing: false,
          updated_at: new Date().toISOString()
        };
        
        await db
          .from('typing')
          .upsert(falseData, { onConflict: 'userid' })
          .catch(err => console.error("Error al establecer typing false:", err));
      }, TYPING_STOP_TIME);
    }
  } catch (error) {
    console.error("Error en sendTyping:", error);
  }
}

// NOTA: La suscripci√≥n a typing ahora se maneja en initTypingSubscription()
// que se llama desde initChat() cuando el usuario hace login


/* ============================================================
   LIMPIAR TYPING ANTIGUO
============================================================ */
// Funci√≥n para limpiar registros de typing donde typing = false
async function cleanOldTyping() {
  try {
    await db
      .from("typing")
      .delete()
      .eq("typing", false);
  } catch (error) {
    console.error("Error al limpiar typing:", error);
  }
}

// Limpiar cada 30 segundos
setInterval(cleanOldTyping, 30000);

// Limpiar al iniciar
cleanOldTyping();

// NOTA: Botones de depuraci√≥n removidos seg√∫n solicitud del usuario

// Funci√≥n para probar la funcionalidad del chat
async function testChatFunctionality() {
  console.log('üß™ Iniciando prueba de funcionalidad del chat...');
  
  // 1. Probar conexi√≥n a Supabase
  console.log('1. Probando conexi√≥n a Supabase...');
  try {
    const { data, error } = await db.from('messages').select('count').limit(1);
    if (error) {
      console.error('‚ùå Error de conexi√≥n:', error.message);
      alert('‚ùå Error de conexi√≥n a Supabase:\n' + error.message);
      return;
    }
    console.log('‚úÖ Conexi√≥n exitosa');
  } catch (error) {
    console.error('‚ùå Error:', error);
    alert('‚ùå Error: ' + error.message);
    return;
  }
  
  // 2. Probar inserci√≥n de mensaje
  console.log('2. Probando inserci√≥n de mensaje...');
  try {
    const testMessage = {
      username: 'usuario_prueba',
      content: 'Este es un mensaje de prueba ' + new Date().toLocaleTimeString(),
      created_at: new Date().toISOString()
    };
    
    const { data, error } = await db.from('messages').insert(testMessage).select();
    
    if (error) {
      console.error('‚ùå Error al insertar:', error.message);
      alert('‚ùå Error al insertar mensaje:\n' + error.message + '\n\nPosible soluci√≥n: Ejecuta configurar_bd.sql en Supabase');
      return;
    }
    
    console.log('‚úÖ Mensaje insertado:', data);
    alert('‚úÖ Prueba exitosa!\n\nMensaje de prueba insertado correctamente.\nID: ' + (data[0]?.id || 'N/A'));
    
    // 3. Probar carga de mensajes
    console.log('3. Probando carga de mensajes...');
    setTimeout(async () => {
      const { data: messages, error: loadError } = await db.from('messages')
        .select('*')
        .order('id', { ascending: false })
        .limit(5);
        
      if (loadError) {
        console.error('‚ùå Error al cargar:', loadError.message);
      } else {
        console.log('‚úÖ Mensajes cargados:', messages.length);
        
        // Limpiar mensaje de prueba
        if (data[0]?.id) {
          await db.from('messages').delete().eq('id', data[0].id);
          console.log('‚úÖ Mensaje de prueba eliminado');
        }
      }
    }, 1000);
    
  } catch (error) {
    console.error('‚ùå Error en prueba:', error);
    alert('‚ùå Error: ' + error.message);
  }
}

// Funci√≥n para configurar la base de datos (solo para desarrollo)
async function setupDatabase() {
  if (!confirm('¬øEst√°s seguro de que quieres configurar la base de datos?\n\nNOTA: Esto es solo para desarrollo.\nSi la tabla messages ya existe, solo se agregar√°n las columnas faltantes.')) {
    return;
  }
  
  try {
    // Intentar agregar las columnas si no existen
    console.log('Configurando base de datos...');
    
    // Nota: No podemos ejecutar SQL directo desde el cliente
    // En su lugar, verificamos la estructura actual y mostramos instrucciones
    const { data, error } = await db.from('messages').select('*').limit(1);
    
    if (error) {
      showError('Error al conectar con la tabla messages. Verifica que exista.');
      console.error('Error:', error);
      
      // Mostrar instrucciones SQL
      const sqlInstructions = `
Para configurar la base de datos, ejecuta este SQL en el editor SQL de Supabase:

-- Agregar columnas si no existen
ALTER TABLE messages 
ADD COLUMN IF NOT EXISTS deleted BOOLEAN DEFAULT FALSE,
ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMP WITH TIME ZONE;

-- Crear √≠ndice
CREATE INDEX IF NOT EXISTS idx_messages_deleted ON messages(deleted);
      `;
      
      alert('Instrucciones SQL:\n' + sqlInstructions);
      return;
    }
    
    // Si llegamos aqu√≠, la tabla existe
    showError('‚úÖ La tabla messages existe. Verificando estructura...');
    
    // Intentar insertar un mensaje de prueba con los nuevos campos
    const testMessage = {
      username: 'sistema',
      content: 'Mensaje de prueba para verificar estructura',
      created_at: new Date().toISOString(),
      deleted: false
    };
    
    const { error: insertError } = await db.from('messages').insert(testMessage);
    
    if (insertError && insertError.message.includes('column')) {
      // Probablemente falta alguna columna
      showError('‚ùå Falta alguna columna. Ejecuta el SQL de configuraci√≥n.');
      
      const sqlInstructions = `
Ejecuta este SQL en Supabase:

ALTER TABLE messages 
ADD COLUMN IF NOT EXISTS deleted BOOLEAN DEFAULT FALSE,
ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMP WITH TIME ZONE;

CREATE INDEX IF NOT EXISTS idx_messages_deleted ON messages(deleted);
      `;
      
      alert('SQL necesario:\n' + sqlInstructions);
    } else if (insertError) {
      showError('Error inesperado: ' + insertError.message);
    } else {
      showError('‚úÖ Base de datos configurada correctamente');
      
      // Eliminar el mensaje de prueba
      setTimeout(async () => {
        await db.from('messages').delete().eq('username', 'sistema');
      }, 2000);
    }
    
  } catch (error) {
        console.error('Error en setupDatabase:', error);
    showError('Error al configurar la base de datos');
  }
}

/* ============================================================
   EVENT LISTENER SIMPLE Y DIRECTO PARA ENTER
============================================================ */
// Soluci√≥n simple y directa para enviar con Enter
document.addEventListener('DOMContentLoaded', function() {
  console.log('üîß Configurando event listener SIMPLE para Enter...');
  
  // Funci√≥n que se ejecuta cada vez que se presiona una tecla en cualquier input
  document.addEventListener('keydown', function(e) {
    // Solo procesar si la tecla es Enter
    if (e.key !== 'Enter') return;
    
    // Verificar si el elemento activo es el input de mensaje
    const activeElement = document.activeElement;
    if (activeElement && activeElement.id === 'messageInput') {
      console.log('üéØ Enter presionado en el input de mensaje');
      e.preventDefault(); // Prevenir comportamiento por defecto
      
      // Peque√±o delay para asegurar que el texto est√© capturado
      setTimeout(function() {
        sendMessage();
      }, 10);
    }
  });
  
  console.log('‚úÖ Event listener SIMPLE configurado');
});

// Tambi√©n agregar event listener cuando se muestra el chat
const originalInitChat = window.initChat;
if (originalInitChat) {
  window.initChat = function() {
    originalInitChat.apply(this, arguments);
    
    // Agregar event listener directo al input cuando est√© disponible
    setTimeout(function() {
      const messageInput = document.getElementById('messageInput');
      if (messageInput) {
        console.log('üîß Agregando event listener directo al input');
        
        // Event listener para keypress
        messageInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            console.log('Enter presionado (keypress directo)');
            e.preventDefault();
            sendMessage();
          }
        });
        
        // Event listener para keydown como respaldo
        messageInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            console.log('Enter presionado (keydown directo)');
            e.preventDefault();
            setTimeout(function() {
              sendMessage();
            }, 10);
          }
        });
        
        console.log('‚úÖ Event listeners DIRECTOS agregados al input');
      }
    }, 200);
  };
}

/* ============================================================
   FUNCI√ìN DE PRUEBA PARA VERIFICAR QUE TODO FUNCIONE
============================================================ */
// Esta funci√≥n se puede llamar desde la consola del navegador para probar
window.testChat = function() {
  console.log('=== PRUEBA DEL CHAT ===');
  console.log('1. Verificando variables globales:');
  console.log('- userid:', userid);
  console.log('- displayName:', displayName);
  console.log('- userPassword:', userPassword ? 'Definida' : 'No definida');
  
  console.log('\n2. Verificando elementos del DOM:');
  console.log('- #messageInput:', document.getElementById('messageInput') ? '‚úÖ Existe' : '‚ùå No existe');
  console.log('- Bot√≥n de enviar:', document.querySelector('#inputArea button') ? '‚úÖ Existe' : '‚ùå No existe');
  console.log('- #chat:', document.getElementById('chat') ? '‚úÖ Existe' : '‚ùå No existe');
  
  console.log('\n3. Verificando funciones:');
  console.log('- sendMessage:', typeof sendMessage === 'function' ? '‚úÖ Existe' : '‚ùå No existe');
  console.log('- showChatNotification:', typeof showChatNotification === 'function' ? '‚úÖ Existe' : '‚ùå No existe');
  console.log('- db:', db ? '‚úÖ Inicializado' : '‚ùå No inicializado');
  
  console.log('\n4. Probando notificaci√≥n:');
  if (typeof showChatNotification === 'function') {
    showChatNotification('‚úÖ Prueba exitosa - El sistema de notificaciones funciona');
  } else {
    console.error('‚ùå showChatNotification no es una funci√≥n');
  }
  
  console.log('\n=== FIN DE LA PRUEBA ===');
  console.log('Para probar el env√≠o de mensajes, escribe en el input y presiona Enter o haz clic en el bot√≥n Enviar.');
};

console.log('‚úÖ Chat configurado. Para probar, ejecuta testChat() en la consola.');

</script>
</body>
</html>




