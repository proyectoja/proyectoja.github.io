<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Supabase Avanzado</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: rgba(100, 30, 30);
      color: #333;
      overflow: hidden;
      /* Prevenir scroll en toda la p√°gina */
      height: 100vh;
    }

    /* LOGIN STYLES */
    #loginContainer {
      display: flex;
      position: relative;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
      overflow: auto;
      box-sizing: border-box;
      background-color: rgb(100, 30, 30);
    }

    #loginBox {
      display: flex;
      flex-direction: column;
      position: relative;
      background: rgba(255, 255, 255, 0.95);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: 100%;
      height: auto;
      max-width: 420px;
      animation: slideIn 0.4s ease-out;
      margin: 20px;
      box-sizing: border-box;
    }



    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #loginBox h2 {
      text-align: center;
      margin-bottom: 10px;
      color: #8B4513;
      font-size: 28px;
    }

    body.dark #loginBox h2 {
      color: #8b9bff;
    }

    #loginBox p {
      text-align: center;
      margin-bottom: 30px;
      opacity: 0.8;
      font-size: 14px;
    }

    .inputGroup {
      margin-bottom: 20px;
    }

    .inputGroup label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 14px;
    }

    .inputGroup input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      transition: all 0.3s;
    }



    .inputGroup input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .passwordWrapper {
      position: relative;
    }

    .passwordWrapper input {
      padding-right: 45px;
    }

    .togglePassword {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      font-size: 18px;
      user-select: none;
    }

    .passwordRequirements {
      margin-top: 8px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      font-size: 12px;
    }



    .requirement {
      display: flex;
      align-items: center;
      margin: 5px 0;
    }

    .requirement.valid {
      color: #10b981;
    }

    .requirement.invalid {
      color: #ef4444;
      opacity: 0.6;
    }

    .checkboxGroup {
      display: flex;
      align-items: center;
      margin: 20px 0;
    }

    .checkboxGroup input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-right: 10px;
      cursor: pointer;
    }

    .checkboxGroup label {
      cursor: pointer;
      font-size: 14px;
      margin: 0;
    }

    .loginButton {
      display: flex;
      position: relative;
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(139, 69, 19, 0.4);
      box-sizing: border-box;
      text-align: center;
      justify-content: center;
    }

    .loginButton:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .loginButton:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .errorMessage {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }



    #container {
      display: flex;
      height: 100vh;
      overflow: hidden;
      /* Evitar scroll en el contenedor principal */
      position: relative;
    }

    /* Ajustar el chatArea cuando el sidebar est√° oculto */
    #sidebar.sidebar-hidden~#chatArea {
      margin-left: 0;
      width: 100%;
    }

    /* Ajustar el chatArea cuando el sidebar est√° visible */
    #sidebar:not(.sidebar-hidden)~#chatArea {
      margin-left: 0;
      width: calc(100% - 230px);
    }

    #sidebar {
      width: 230px;
      background: brown;
      padding: 15px;
      overflow: hidden;
      border-right: 1px solid rgba(255, 255, 255, 0.5);
      box-sizing: border-box;
      min-height: 0;
      /* Importante para scroll en flex container */
      transition: transform 0.3s ease-in-out;
      transform: translateX(0);
    }

    /* Sidebar oculto */
    #sidebar.sidebar-hidden {
      transform: translateX(-100%);
      width: 0;
      padding: 0;
      border-right: none;
      overflow: hidden;
    }

    /* Bot√≥n/barrera para mostrar sidebar - SIEMPRE VISIBLE */
    .sidebar-toggle {
      position: absolute;
      left: 230px;
      /* Pegado al borde derecho del sidebar cuando est√° visible */
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 80px;
      background: brown;
      border-radius: 0 10px 10px 0;
      cursor: pointer;
      display: flex !important;
      /* Forzar visibilidad */
      align-items: center;
      justify-content: center;
      z-index: 1000;
      /* Z-index muy alto para asegurar visibilidad */
      transition: left 0.3s ease, width 0.3s ease, opacity 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
      opacity: 0.7;
    }

    /* Cuando el sidebar est√° oculto, el bot√≥n se mueve a la izquierda */
    /* Esta regla se maneja ahora con JavaScript */

    .sidebar-toggle:hover {
      background: rgb(255, 255, 255, 0.3);
      width: 25px;
      opacity: 1;
      transform: translateY(-50%) scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .sidebar-toggle .toggle-icon {
      color: white;
      font-size: 14px;
      transition: transform 0.3s ease;
    }

    /* Animaci√≥n suave para el movimiento del bot√≥n */
    .sidebar-toggle {
      transition: left 0.3s ease, width 0.3s ease, opacity 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
    }

    /* Para pantallas peque√±as (tabletas y m√≥viles) */
    @media (max-width: 768px) {
      #sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        z-index: 99;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
      }

      #sidebar.sidebar-hidden {
        transform: translateX(-100%);
        width: 230px;
      }

      .sidebar-toggle {
        position: fixed;
        z-index: 1000;
      }
    }

    /* Para pantallas grandes (computadoras) */
    @media (min-width: 769px) {
      #container {
        position: relative;
      }
    }


    .userItem {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      padding: 10px;
      border-radius: 12px;
      background: rgba(100, 30, 30, 0.3);
      transition: all 0.3s;
      border: 1px solid rgba(100, 30, 30, 0.1);
      min-width: 0;
      /* Importante para que flex-shrink funcione */
    }

    .userItem:hover {
      background: rgba(100, 30, 30, 0.5);
      transform: translateX(5px);
    }


    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: bold;
      margin-right: 12px;
      font-size: 16px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .avatar-top {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: bold;
      font-size: 18px;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
    }

    #chatArea {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      /* Importante para scroll interno */
      overflow: hidden;
      /* Contener el contenido */
      background-color: rgb(100, 30, 30);
      transition: width 0.3s ease-in-out;
    }

    #topBar {
      padding: 15px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.5);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: brown;
    }

    #usernameDisplay {
      font-weight: 600;
      color: white;
      font-size: 20px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 300px;
    }

    #chat {
      padding: 20px;
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      /* Eliminar scroll horizontal */
      background: rgb(100, 30, 30);
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
      /* Importante para que el scroll funcione en flex containers */
    }

    #chat::-webkit-scrollbar {
      width: 15px;
    }

    #chat::-webkit-scrollbar-track {
      background: transparent;
      border-radius: 4px;
      margin: 5px 0;
    }

    #chat::-webkit-scrollbar-thumb {
      background: brown;
      border-radius: 4px;
    }

    #chat::-webkit-scrollbar-thumb:hover {
      background: rgba(165, 42, 42, 0.7);
    }


    .msg {
      margin-bottom: 15px;
      padding: 14px 16px 16px 16px;
      border-radius: 18px;
      max-width: 90%;
      min-width: 120px;
      position: relative;
      word-wrap: break-word;
      line-height: 1.4;
      box-sizing: border-box;
      overflow: visible;
    }

    .msg.own {
      background: transparent;
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }

    .msg.other {
      background: transparent;
      color: white;
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }

    .msg-time {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.9);
      margin-top: 8px;
      text-align: right;
      opacity: 0.95;
      display: block;
      clear: both;
      font-weight: 500;
      letter-spacing: 0.3px;
    }

    .msg-user {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
      color: white;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
      display: inline-block;
      vertical-align: middle;
    }

    /* Estilos para contenedor de mensaje con avatar */
    .msg-container {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      position: relative;
    }

    .msg-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
      flex-shrink: 0;
      margin-top: 4px;
    }

    .msg-content-wrapper {
      flex: 1;
      min-width: 0;
    }

    .msg-bubble {
      background: brown;
      padding: 10px 14px;
      border-radius: 18px;
      position: relative;
      max-width: 100%;
      min-width: 50px;
    }

    .msg.own .msg-bubble {
      background: brown;
      border-bottom-right-radius: 4px;
    }

    .msg.other .msg-bubble {
      background: brown;
      border-top-left-radius: 4px;
    }

    .msg-text {
      word-wrap: break-word;
      word-break: break-word;
      overflow-wrap: break-word;
      white-space: pre-wrap;
      line-height: 1.5;
      color: white;
    }

    .msg-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 4px;
    }

    .msg-content {
      word-wrap: break-word;
      word-break: break-word;
      overflow-wrap: break-word;
      white-space: pre-wrap;
      max-width: 100%;
      overflow: visible;
      line-height: 1.5;
      margin: 4px 0;
    }

    /* Estilos para bot√≥n de eliminar */
    .delete-btn {
      position: relative;
      top: 5px;
      right: 5px;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: white;
      opacity: 0.8;
      transition: all 0.2s;
      z-index: 10;
      backdrop-filter: blur(2px);
    }

    .delete-btn:hover {
      opacity: 1;
      background: rgba(255, 69, 0, 0.3);
      border-color: rgba(255, 69, 0, 0.5);
      transform: scale(1.15);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    /* Estilos especiales para bot√≥n de eliminar de administrador */
    .admin-delete-btn {
      background: rgba(255, 215, 0, 0.2);
      border-color: rgba(255, 215, 0, 0.5);
    }

    .admin-delete-btn:hover {
      background: rgba(255, 69, 0, 0.4);
      border-color: rgba(255, 69, 0, 0.7);
    }

    /* ============================================================
     ESTILOS PARA SISTEMA DE RESPUESTAS Y BOTONES
  ============================================================ */

    /* Estilos para bot√≥n de responder */
    .reply-btn {
      position: relative;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: white;
      opacity: 0.8;
      transition: all 0.2s;
      z-index: 10;
      backdrop-filter: blur(2px);
    }

    .reply-btn:hover {
      opacity: 1;
      background: rgba(102, 126, 234, 0.3);
      border-color: rgba(102, 126, 234, 0.5);
      transform: scale(1.15);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    /* Estilos para el √°rea de respuesta */
    #replyArea {
      display: none;
      padding: 10px 15px;
      background: linear-gradient(135deg, rgba(100, 30, 30, 0.3) 0%, rgba(100, 30, 30, 0.3) 100%);
      /* Azul para diferenciar */
      border-radius: 10px 10px 0 0;
      border-bottom: 2px solid rgba(100, 30, 30, 0.5);
      margin-bottom: 8px;
      position: relative;
      border-left: 4px solid rgb(100, 30, 30);
    }

    .reply-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .reply-title {
      font-size: 12px;
      font-weight: 600;
      color: #4682B4;
      /* Azul para el t√≠tulo */
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .reply-close {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .reply-close:hover {
      background: rgba(70, 130, 180, 0.1);
    }

    .reply-content {
      font-size: 13px;
      color: #2C3E50;
      /* Color m√°s oscuro para mejor contraste */
      padding: 8px;
      background: rgba(255, 255, 255, 0.90);
      border-radius: 8px;
      border-left: 3px solid rgb(100, 30, 30);
      max-height: 60px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      line-clamp: 2;
      font-style: italic;
      word-break: break-word;
    }

    .reply-author {
      font-weight: 600;
      color: rgb(100, 30, 30);
      /* Azul para el autor */
      margin-right: 5px;
    }

    /* Estilos para mensajes que son respuestas */
    .msg-reply {
      margin-top: 5px;
      padding: 8px 12px;
      background: linear-gradient(135deg, rgba(100, 30, 30, 0.3) 0%, rgba(100, 30, 30, 0.3) 100%);
      /* Fondo azul claro */
      border-radius: 8px;
      border-left: 3px solid rgb(100, 30, 30);
      /* Borde azul */
      font-size: 12px;
      color: #2C3E50;
      max-width: 100%;
      font-style: italic;
      overflow: hidden;
      word-break: break-word;
    }

    .msg-reply-author {
      font-weight: 600;
      color: #ccc;
      /* Azul para el autor */
      margin-right: 5px;
    }

    .msg-reply-content {
      color: #ccc;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      line-clamp: 2;
      max-height: 2.4em;
      line-height: 1.2em;
    }

    /* Estilos para los botones de acci√≥n en mensajes */
    .msg-actions {
      position: absolute;
      display: flex;
      gap: 5px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    /* Posicionamiento diferente para mensajes propios vs ajenos */
    .msg.own .msg-actions {
      right: 5px;
      /* Para mensajes propios: botones a la derecha */
      top: -30px;
    }

    .msg.other .msg-actions {
      top: 5px;
      position: relative;
      left: 5px;
      /* Para mensajes ajenos: botones a la izquierda */
    }

    .msg:hover .msg-actions {
      opacity: 1;
    }

    .msg-container {
      position: relative;
    }

    /* Ajustar posici√≥n de botones de eliminar para mensajes propios */
    .msg.own .delete-btn {
      position: relative;
      top: 0;
      right: 0;
    }

    /* Ajustar posici√≥n de botones de responder para mensajes propios */
    .msg.own .reply-btn {
      position: relative;
      top: 0;
      right: 0;
    }

    /* Ajustar posici√≥n de botones de eliminar para mensajes propios */
    .msg.other .delete-btn {
      position: relative;
      top: 0;
      right: 0;
    }

    /* Ajustar posici√≥n de botones de responder para mensajes propios */
    .msg.other .reply-btn {
      position: relative;
      top: 0;
      right: 0;
    }


    /* ============================================================
     ESTILOS PARA SELECTOR DE EMOJIS
  ============================================================ */

    /* Bot√≥n para abrir emojis */
    .emoji-btn {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      width: 36px;
      height: 36px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
      opacity: 0.8;
      transition: all 0.2s;
      backdrop-filter: blur(2px);
      margin-right: 5px;
    }

    .emoji-btn:hover {
      opacity: 1;
      background: rgba(255, 215, 0, 0.3);
      border-color: rgba(255, 215, 0, 0.5);
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    /* Contenedor del selector de emojis */
    .emoji-picker {
      position: absolute;
      bottom: 70px;
      right: 15px;
      left: 15px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      padding: 15px;
      z-index: 1000;
      display: none;
      border: 1px solid rgba(139, 69, 19, 0.2);
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .emoji-picker.show {
      display: block;
      animation: fadeIn 0.2s ease-out;
      max-height: 400px;
      /* Altura m√°xima con scroll */
      overflow-y: auto;
      /* Scroll vertical */
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Header del selector de emojis */
    .emoji-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .emoji-title {
      font-size: 16px;
      font-weight: 600;
      color: white;
    }

    .emoji-close {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .emoji-close:hover {
      background: rgba(255, 255, 255, 0.5)
    }

    /* Grid de emojis */
    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 6px;
      padding: 5px;
      overflow: visible;
      /* Sin scroll */
    }

    /* Emoji individual */
    .emoji-item {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      cursor: pointer;
      border-radius: 10px;
      transition: all 0.2s;
      user-select: none;
    }

    .emoji-item:hover {
      background: rgba(255, 255, 255, 0.5);
      transform: scale(1.15);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .emoji-item:active {
      background: rgba(139, 69, 19, 0.25);
      transform: scale(1.1);
    }

    /* Categor√≠as de emojis */
    .emoji-category {
      margin-top: 15px;
    }

    .emoji-category:first-child {
      margin-top: 0;
    }

    .emoji-category-title {
      font-size: 14px;
      font-weight: 600;
      color: black;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 1rem;
      padding-left: 20px;
      z-index: 1;
    }

    /* Scrollbar personalizado para el contenedor principal */
    .emoji-picker.show::-webkit-scrollbar {
      width: 10px;
    }

    .emoji-picker.show::-webkit-scrollbar-track {
      background: transparent;
      border-radius: 4px;
      margin: 5px 0;
    }

    .emoji-picker.show::-webkit-scrollbar-thumb {
      background: white;
      border-radius: 4px;
    }

    /* Badge de administrador */
    .admin-badge {
      display: inline-block;
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #8B4513;
      font-size: 10px;
      padding: 1px 4px;
      border-radius: 4px;
      margin-left: 4px;
      vertical-align: middle;
      cursor: help;
      flex-shrink: 0;
      white-space: nowrap;
    }

    /* Estilos para mensajes eliminados */
    .msg.deleted {
      opacity: 0.65;
      background: linear-gradient(135deg, rgba(139, 69, 19, 0.4) 0%, rgba(160, 82, 45, 0.4) 100%) !important;
    }

    /* Estilos espec√≠ficos para mensajes eliminados por administrador */
    .msg.deleted-by-admin {
      background: linear-gradient(135deg, rgba(139, 69, 19, 0.5) 0%, rgba(160, 82, 45, 0.5) 100%) !important;
      border-left: 3px solid rgba(255, 215, 0, 0.5);
    }

    .msg.deleted .msg-content {
      font-style: italic;
      opacity: 0.9;
      color: rgba(255, 255, 255, 0.8) !important;
    }

    .msg.deleted .msg-user {
      opacity: 0.8;
    }

    .msg.deleted .msg-time {
      opacity: 0.7;
      color: rgba(255, 255, 255, 0.7) !important;
    }

    /* Informaci√≥n de eliminaci√≥n por administrador */
    .delete-info {
      font-size: 10px !important;
      opacity: 0.8;
      margin-top: 2px;
      font-style: italic;
      color: rgba(255, 215, 0, 0.9) !important;
    }



    * {
      box-sizing: border-box;
      max-width: 100%;
    }


    #typing {
      padding: 8px 20px;
      font-style: italic;
      opacity: 0.9;
      color: white;
      font-size: 13px;
      background: rgb(100, 30, 30);
      border-radius: 0 0 10px 10px;
      margin: 0 20px;
    }

    #inputArea {
      display: flex;
      flex-direction: column;
      padding: 15px;
      border-top: 1px solid rgba(139, 69, 19, 0.2);
      background: brown;
      gap: 8px;
      position: relative;
    }

    .input-row {
      display: flex;
      gap: 10px;
      width: 100%;
    }

    input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 20px;
      border: 1px solid rgba(139, 69, 19, 0.3);
      font-size: 14px;
      background: white;
      transition: all 0.3s;
    }

    input:focus {
      outline: none;
      border-color: #8B4513;
      box-shadow: 0 0 0 2px rgba(139, 69, 19, 0.1);
    }

    input:disabled {
      background: #f5f5f5;
      color: #999;
      cursor: not-allowed;
    }

    button {
      margin-left: 10px;
      padding: 10px 16px;
      border: none;
      background: rgb(100, 30, 30);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    button:hover {
      background: #A0522D;
      transform: translateY(-2px);
    }

    button:disabled {
      background: #D2B48C;
      cursor: not-allowed;
      transform: none;
    }

    /* ============================================================
     NOTIFICACIONES MODERNAS
  ============================================================ */

    /* Contenedor de notificaciones */
    .notifications-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 350px;
    }

    /* Notificaci√≥n individual */
    .notification {
      background: white;
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: flex-start;
      gap: 12px;
      animation: notificationSlideIn 0.3s ease-out;
      transform-origin: top right;
      border-left: 4px solid #8B4513;
      max-width: 100%;
      overflow: hidden;
    }

    /* Animaci√≥n de entrada */
    @keyframes notificationSlideIn {
      from {
        opacity: 0;
        transform: translateX(100%) scale(0.9);
      }

      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    /* Animaci√≥n de salida */
    @keyframes notificationSlideOut {
      from {
        opacity: 1;
        transform: translateX(0) scale(1);
      }

      to {
        opacity: 0;
        transform: translateX(100%) scale(0.9);
      }
    }

    /* Icono de notificaci√≥n */
    .notification-icon {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: 14px;
      font-weight: bold;
    }

    /* Contenido de notificaci√≥n */
    .notification-content {
      flex: 1;
      min-width: 0;
    }

    .notification-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
      color: #333;
    }

    .notification-message {
      font-size: 13px;
      color: #666;
      line-height: 1.4;
      word-break: break-word;
    }

    /* Bot√≥n de cerrar */
    .notification-close {
      background: none;
      border: none;
      color: #999;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .notification-close:hover {
      background: rgba(0, 0, 0, 0.05);
      color: #666;
    }

    /* Tipos de notificaciones */
    .notification.success {
      border-left-color: #10b981;
      background: white;
    }

    .notification.success .notification-icon {
      background: #10b981;
      color: white;
    }

    .notification.error {
      border-left-color: #ef4444;
      background: white;
    }

    .notification.error .notification-icon {
      background: #ef4444;
      color: white;
    }

    .notification.warning {
      border-left-color: #f59e0b;
      background: white;
    }

    .notification.warning .notification-icon {
      background: #f59e0b;
      color: white;
    }

    .notification.info {
      border-left-color: #3b82f6;
      background: white;
    }

    .notification.info .notification-icon {
      background: #3b82f6;
      color: white;
    }

    /* Modal de confirmaci√≥n moderno */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.2s ease-out;
      backdrop-filter: blur(2px);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .modal {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      margin-bottom: 16px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }

    .modal-message {
      font-size: 14px;
      color: #666;
      line-height: 1.5;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .modal-button {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-button.cancel {
      background: #f3f4f6;
      color: #666;
    }

    .modal-button.cancel:hover {
      background: #e5e7eb;
    }

    .modal-button.confirm {
      background: #8B4513;
      color: white;
    }

    .modal-button.confirm:hover {
      background: #A0522D;
      transform: translateY(-1px);
    }

    .modal-button.danger {
      background: #ef4444;
      color: white;
    }

    .modal-button.danger:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }
  </style>
</head>

<body>

  <!-- Contenedor para notificaciones -->
  <div id="notificationsContainer" class="notifications-container"></div>

  <!-- LOGIN SCREEN -->
  <div id="loginContainer">
    <div id="loginBox">
      <h2>üîê Iniciar Sesi√≥n</h2>
      <p>Bienvenido al Chat</p>

      <div id="errorMessage" class="errorMessage"></div>

      <div class="inputGroup">
        <label for="loginUsername">Usuario (m√°x 12 d√≠gitos)</label>
        <input type="text" id="loginUsername" placeholder="@usuario" autocomplete="username" maxlength="12"
          oninput="validateUsernameLength()">
      </div>

      <div class="inputGroup">
        <label for="loginPassword">Contrase√±a</label>
        <div class="passwordWrapper">
          <input type="password" id="loginPassword" placeholder="Contrase√±a segura" autocomplete="current-password">
          <span class="togglePassword" onclick="togglePasswordVisibility()">üëÅÔ∏è</span>
        </div>
        <div class="passwordRequirements" id="passwordRequirements" style="display: none;">
          <div class="requirement" id="req-uppercase">
            <span>‚úó</span> <span style="margin-left: 8px;">Al menos una may√∫scula</span>
          </div>
          <div class="requirement" id="req-lowercase">
            <span>‚úó</span> <span style="margin-left: 8px;">Al menos una min√∫scula</span>
          </div>
          <div class="requirement" id="req-number">
            <span>‚úó</span> <span style="margin-left: 8px;">Al menos un n√∫mero</span>
          </div>
          <div class="requirement" id="req-special">
            <span>‚úó</span> <span style="margin-left: 8px;">Al menos un car√°cter especial (!@#$%^&*)</span>
          </div>
        </div>
      </div>

      <div class="inputGroup" id="displayNameGroup" style="display: none;">
        <label for="loginDisplayName">Nombre para mostrar</label>
        <input type="text" id="loginDisplayName" placeholder="Tu nombre" autocomplete="name">
      </div>

      <div class="checkboxGroup">
        <input type="checkbox" id="rememberMe">
        <label for="rememberMe">Recordar inicio de sesi√≥n</label>
      </div>

      <button class="loginButton" onclick="handleLogin()">Iniciar Sesi√≥n</button>
    </div>
  </div>

  <!-- CHAT SCREEN -->
  <div id="container" style="display: none;">
    <!-- Bot√≥n/barrera para mostrar sidebar -->
    <div id="sidebarToggle" class="sidebar-toggle" title="Mostrar/ocultar lista de usuarios">
      <div class="toggle-icon">‚ñ∂</div>
    </div>

    <div id="sidebar" class="sidebar-visible">
      <img src="logo-proyectoja.png" alt="">
      <h3 style="color: white;">Conectados</h3>
      <div id="usersList"></div>
    </div>

    <div id="chatArea">
      <div id="topBar">
        <div style="display: flex; align-items: center; gap: 12px;">
          <div id="userAvatarTop" class="avatar-top"></div>
          <div>
            <span id="usernameDisplay"></span>
            <div id="userStatus" style="font-size: 12px; opacity: 0.8; color: #09ff00;">Conectado</div>
          </div>
        </div>
        <div>
          <button onclick="changeName()">Cambiar nombre</button>
          <button onclick="logout()" style="background: #ef4444;">Cerrar sesi√≥n</button>
        </div>
      </div>

      <div id="chat"></div>
      <div id="typing"></div>

      <div id="inputArea">
        <!-- √Årea para mostrar el mensaje que se est√° respondiendo -->
        <div id="replyArea" style="display: none;">
          <div class="reply-header">
            <div class="reply-title" style="color: white;">
              <span>‚Ü©Ô∏è Respondiendo a:</span>
            </div>
            <button class="reply-close" onclick="cancelReply()">√ó</button>
          </div>
          <div class="reply-content">
            <span class="reply-author" id="replyAuthor"></span>
            <span id="replyText"></span>
          </div>
        </div>

        <div class="input-row">
          <button class="emoji-btn" onclick="toggleEmojiPicker()" title="Emojis">üòä</button>
          <input id="messageInput" placeholder="Escribe un mensaje (m√°x 1000 caracteres)..."
            oninput="sendTyping(true); updateCharCounter()"
            onkeypress="if(event.key === 'Enter') { event.preventDefault(); sendMessage(); }" maxlength="1000">
          <button onclick="sendMessage()">Enviar</button>
        </div>
        <div id="charCounter"
          style="font-size: 11px; color: white; text-align: right; padding: 2px 12px 0 0; display: none; font-weight: 500;">
          0/1000 caracteres</div>

        <!-- Selector de emojis -->
        <div id="emojiPicker" class="emoji-picker">
          <div class="emoji-header">
            <div class="emoji-title">üòä Emojis</div>
            <button class="emoji-close" onclick="toggleEmojiPicker()">√ó</button>
          </div>

          <div class="emoji-category">
            <div class="emoji-category-title">Caritas</div>
            <div class="emoji-grid" id="emojiFaces">
              <!-- Emojis de caritas se llenar√°n con JavaScript -->
            </div>
          </div>

          <div class="emoji-category">
            <div class="emoji-category-title">Manos</div>
            <div class="emoji-grid" id="emojiHands">
              <!-- Emojis de manos se llenar√°n con JavaScript -->
            </div>
          </div>

          <div class="emoji-category">
            <div class="emoji-category-title">Objetos</div>
            <div class="emoji-grid" id="emojiObjects">
              <!-- Emojis de objetos se llenar√°n con JavaScript -->
            </div>
          </div>

          <div class="emoji-category">
            <div class="emoji-category-title">S√≠mbolos</div>
            <div class="emoji-grid" id="emojiSymbols">
              <!-- Emojis de s√≠mbolos se llenar√°n con JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /* ============================================================
       SISTEMA DE NOTIFICACIONES MODERNAS
    ============================================================ */

    // Funci√≥n para mostrar notificaci√≥n moderna
    function showNotification(title, message, type = 'info', duration = 5000) {
      const container = document.getElementById('notificationsContainer');
      if (!container) {
        console.error('Contenedor de notificaciones no encontrado');
        return;
      }

      // Crear elemento de notificaci√≥n
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;

      // Icono seg√∫n el tipo
      let icon = '‚ÑπÔ∏è';
      switch (type) {
        case 'success': icon = '‚úì'; break;
        case 'error': icon = '‚úó'; break;
        case 'warning': icon = '‚ö†'; break;
        case 'info': icon = '‚Ñπ'; break;
      }

      notification.innerHTML = `
    <div class="notification-icon">${icon}</div>
    <div class="notification-content">
      <div class="notification-title">${title}</div>
      <div class="notification-message">${message}</div>
    </div>
    <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
  `;

      // Agregar al contenedor
      container.appendChild(notification);

      // Auto-eliminar despu√©s de la duraci√≥n especificada
      if (duration > 0) {
        setTimeout(() => {
          if (notification.parentNode) {
            notification.style.animation = 'notificationSlideOut 0.3s ease-out';
            setTimeout(() => {
              if (notification.parentNode) {
                notification.remove();
              }
            }, 300);
          }
        }, duration);
      }

      return notification;
    }

    // Funci√≥n para mostrar confirmaci√≥n moderna
    function showConfirm(title, message, options = {}) {
      return new Promise((resolve) => {
        const defaultOptions = {
          confirmText: 'Confirmar',
          cancelText: 'Cancelar',
          type: 'confirm', // 'confirm', 'danger', 'warning'
          showCancel: true
        };

        const config = { ...defaultOptions, ...options };

        // Crear overlay
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';

        // Crear modal
        const modal = document.createElement('div');
        modal.className = 'modal';

        // Determinar clase del bot√≥n principal
        let confirmButtonClass = 'confirm';
        if (config.type === 'danger') confirmButtonClass = 'danger';
        if (config.type === 'warning') confirmButtonClass = 'warning';

        modal.innerHTML = `
      <div class="modal-header">
        <div class="modal-title">${title}</div>
        <div class="modal-message">${message}</div>
      </div>
      <div class="modal-actions">
        ${config.showCancel ? `<button class="modal-button cancel">${config.cancelText}</button>` : ''}
        <button class="modal-button ${confirmButtonClass}">${config.confirmText}</button>
      </div>
    `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // Configurar eventos
        const confirmButton = modal.querySelector(`.modal-button.${confirmButtonClass}`);
        const cancelButton = modal.querySelector('.modal-button.cancel');

        const closeModal = (result) => {
          overlay.style.animation = 'fadeIn 0.2s ease-out reverse';
          modal.style.animation = 'modalSlideIn 0.3s ease-out reverse';

          setTimeout(() => {
            if (overlay.parentNode) {
              overlay.remove();
            }
            resolve(result);
          }, 200);
        };

        confirmButton.addEventListener('click', () => closeModal(true));

        if (cancelButton) {
          cancelButton.addEventListener('click', () => closeModal(false));
        }

        // Cerrar al hacer clic fuera del modal
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            closeModal(false);
          }
        });

        // Cerrar con Escape
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            closeModal(false);
            document.removeEventListener('keydown', handleEscape);
          }
        };

        document.addEventListener('keydown', handleEscape);

        // Enfocar bot√≥n de confirmar
        setTimeout(() => confirmButton.focus(), 100);
      });
    }

    // Funci√≥n para mostrar alerta moderna
    function showAlert(title, message, type = 'info') {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';

        const modal = document.createElement('div');
        modal.className = 'modal';

        let buttonClass = 'confirm';
        if (type === 'danger') buttonClass = 'danger';
        if (type === 'warning') buttonClass = 'warning';

        modal.innerHTML = `
      <div class="modal-header">
        <div class="modal-title">${title}</div>
        <div class="modal-message">${message}</div>
      </div>
      <div class="modal-actions">
        <button class="modal-button ${buttonClass}">Aceptar</button>
      </div>
    `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        const okButton = modal.querySelector(`.modal-button.${buttonClass}`);

        const closeModal = () => {
          overlay.style.animation = 'fadeIn 0.2s ease-out reverse';
          modal.style.animation = 'modalSlideIn 0.3s ease-out reverse';

          setTimeout(() => {
            if (overlay.parentNode) {
              overlay.remove();
            }
            resolve();
          }, 200);
        };

        okButton.addEventListener('click', closeModal);

        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            closeModal();
          }
        });

        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            closeModal();
            document.removeEventListener('keydown', handleEscape);
          }
        };

        document.addEventListener('keydown', handleEscape);

        setTimeout(() => okButton.focus(), 100);
      });
    }

    /* ============================================================
       SUPABASE CONFIG
    ============================================================ */
    const SUPABASE_URL = "https://hgangxlyytnxdndwjvgf.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnYW5neGx5eXRueGRuZHdqdmdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNDgyNTksImV4cCI6MjA4MDkyNDI1OX0.VL5GgpkfV102lJc_NEi0Ga15gDiNSV92jSIRMuH-5hI";
    console.log('Configurando Supabase...');
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    console.log('Supabase configurado:', db ? 'OK' : 'ERROR');
    // Probar conexi√≥n a Supabase y verificar estructura
    async function testSupabaseConnection() {
      try {
        console.log('üîå Probando conexi√≥n a Supabase...');
        console.log('URL:', SUPABASE_URL);

        // Probar conexi√≥n b√°sica
        const { data, error, count } = await db.from('messages').select('*', { count: 'exact' }).limit(1);

        if (error) {
          console.error('‚ùå Error de conexi√≥n a Supabase:', error);
          console.error('Detalles:', error.message);

          // Mostrar instrucciones si la tabla no existe
          if (error.message.includes('does not exist') || error.message.includes('no existe') || error.message.includes('relation')) {
            console.warn('‚ö†Ô∏è La tabla messages no existe. Se necesita configurar la base de datos.');

            // Mostrar notificaci√≥n moderna
            setTimeout(() => {
              showAlert('‚ö†Ô∏è ATENCI√ìN', 'La tabla messages no existe en Supabase.\n\nPara solucionar:\n1. Ve a tu proyecto Supabase\n2. Abre el Editor SQL\n3. Ejecuta el archivo configurar_bd.sql o crear_tabla_messages_completa.sql', 'warning');
            }, 1000);
          } else {
            // Otro tipo de error
            setTimeout(() => {
              showAlert('‚ö†Ô∏è Error de conexi√≥n', 'Error de conexi√≥n a Supabase:\n' + error.message, 'error');
            }, 1000);
          }
        } else {
          console.log('‚úÖ Conexi√≥n a Supabase exitosa');
          console.log('Total de mensajes:', count || 0);

          // Verificar si la tabla tiene las columnas necesarias
          if (data && data.length > 0) {
            const firstMessage = data[0];
            console.log('Primer mensaje:', firstMessage);

            const hasDeletedField = 'deleted' in firstMessage;
            const hasIdField = 'id' in firstMessage;

            console.log('Tiene campo deleted:', hasDeletedField);
            console.log('Tiene campo id:', hasIdField);

            if (!hasDeletedField) {
              console.warn('‚ö†Ô∏è La tabla messages no tiene la columna "deleted".');

              setTimeout(() => {
                showAlert('‚ö†Ô∏è Actualizaci√≥n necesaria', 'La tabla messages necesita actualizaci√≥n.\n\nEjecuta configurar_bd.sql en Supabase para agregar las columnas faltantes.', 'warning');
              }, 1500);
            } else {
              console.log('‚úÖ Estructura de la base de datos correcta');
            }
          } else {
            console.log('‚ÑπÔ∏è No hay mensajes en la base de datos');
          }
        }
      } catch (error) {
        console.error('‚ùå Error en test de conexi√≥n:', error);
        console.error('Stack:', error.stack);

        setTimeout(() => {
          showAlert('‚ùå Error cr√≠tico', 'Error cr√≠tico al conectar con Supabase:\n' + error.message, 'error');
        }, 1000);
      }
    }

    // Ejecutar test cuando se cargue la p√°gina
    window.addEventListener('load', () => {
      console.log('üöÄ P√°gina cargada, iniciando diagn√≥stico...');

      // Ejecutar diagn√≥stico completo
      setTimeout(async () => {
        await testSupabaseConnection();

        // Verificar tambi√©n otros componentes
        console.log('üîç Verificando componentes de la p√°gina...');
        console.log('Elemento #chat:', document.getElementById('chat') ? '‚úÖ Existe' : '‚ùå No existe');
        console.log('Elemento #messageInput:', document.getElementById('messageInput') ? '‚úÖ Existe' : '‚ùå No existe');
        console.log('Elemento #loginContainer:', document.getElementById('loginContainer') ? '‚úÖ Existe' : '‚ùå No existe');

        // Verificar variables globales
        console.log('üåê Variables globales:');
        console.log('- Supabase URL:', SUPABASE_URL ? '‚úÖ Configurada' : '‚ùå No configurada');
        console.log('- Supabase Client:', db ? '‚úÖ Inicializado' : '‚ùå No inicializado');

        // Si estamos en el chat, probar carga de mensajes
        if (document.getElementById('container').style.display !== 'none') {
          console.log('üí¨ Chat visible, probando carga de mensajes...');
          await loadMessages();
        }
      }, 1000);
    });

    /* ============================================================
       VALIDACI√ìN DE CONTRASE√ëA SEGURA
    ============================================================ */
    function validatePassword(password) {
      const requirements = {
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /[0-9]/.test(password),
        special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
      };

      return {
        valid: requirements.uppercase && requirements.lowercase && requirements.number && requirements.special,
        requirements
      };
    }

    /* ============================================================
       VALIDACI√ìN DE USERNAME (M√ÅX 12 D√çGITOS)
    ============================================================ */
    function validateUsernameLength() {
      const usernameInput = document.getElementById('loginUsername');
      const username = usernameInput.value.trim();

      if (username.length > 12) {
        usernameInput.value = username.substring(0, 12);
        showError('El usuario no puede tener m√°s de 12 d√≠gitos');
      }
    }

    /* ============================================================
       CONTADOR DE CARACTERES PARA MENSAJES
    ============================================================ */
    function updateCharCounter() {
      const input = document.getElementById('messageInput');
      const text = input.value;
      const counter = document.getElementById('charCounter');

      if (counter) {
        const remaining = 1000 - text.length;
        counter.textContent = `${text.length}/1000 caracteres`;

        // Mostrar/ocultar contador
        if (text.length > 0) {
          counter.style.display = 'block';
        } else {
          counter.style.display = 'none';
        }

        // Cambiar color seg√∫n el l√≠mite
        if (remaining < 100) {
          counter.style.color = '#ff0000';
        } else if (remaining < 500) {
          counter.style.color = '#f59e0b';
        } else {
          counter.style.color = '#00ff00';
        }
      }
    }

    function updatePasswordRequirements(password) {
      const validation = validatePassword(password);
      const reqDiv = document.getElementById('passwordRequirements');

      if (password.length > 0) {
        reqDiv.style.display = 'block';

        document.getElementById('req-uppercase').className = validation.requirements.uppercase ? 'requirement valid' : 'requirement invalid';
        document.getElementById('req-lowercase').className = validation.requirements.lowercase ? 'requirement valid' : 'requirement invalid';
        document.getElementById('req-number').className = validation.requirements.number ? 'requirement valid' : 'requirement invalid';
        document.getElementById('req-special').className = validation.requirements.special ? 'requirement valid' : 'requirement invalid';

        document.getElementById('req-uppercase').querySelector('span').textContent = validation.requirements.uppercase ? '‚úì' : '‚úó';
        document.getElementById('req-lowercase').querySelector('span').textContent = validation.requirements.lowercase ? '‚úì' : '‚úó';
        document.getElementById('req-number').querySelector('span').textContent = validation.requirements.number ? '‚úì' : '‚úó';
        document.getElementById('req-special').querySelector('span').textContent = validation.requirements.special ? '‚úì' : '‚úó';
      } else {
        reqDiv.style.display = 'none';
      }
    }

    function togglePasswordVisibility() {
      const input = document.getElementById('loginPassword');
      const toggle = document.querySelector('.togglePassword');

      if (input.type === 'password') {
        input.type = 'text';
        toggle.textContent = 'üôà';
      } else {
        input.type = 'password';
        toggle.textContent = 'üëÅÔ∏è';
      }
    }

    // Event listener para validaci√≥n en tiempo real
    document.addEventListener('DOMContentLoaded', () => {
      const passwordInput = document.getElementById('loginPassword');
      if (passwordInput) {
        // Este event listener se manejar√° en la l√≥gica principal
        // para diferenciar entre usuarios nuevos y existentes
      }
    });

    /* ============================================================
       SISTEMA DE LOGIN
    ============================================================ */
    let userid = null;
    let displayName = null;
    let userPassword = null;

    /* ============================================================
       VARIABLES PARA SISTEMA DE RESPUESTAS
    ============================================================ */
    let replyingTo = null; // ID del mensaje al que se est√° respondiendo
    let replyMessageData = null; // Datos del mensaje que se est√° respondiendo

    /* ============================================================
       VARIABLES DEL SISTEMA ANTI-SPAM Y TYPING
       (Declaradas aqu√≠ para que est√©n disponibles antes de que
        se llamen las funciones que las usan)
    ============================================================ */
    // Variables del sistema anti-spam
    let messageCount = 0;
    let messageTimer = null;
    let spamBlocked = false;
    let spamTimer = null;
    const MAX_MESSAGES_PER_SECOND = 5;
    const SPAM_BLOCK_TIME = 60; // 60 segundos de bloqueo

    // Variables del sistema de typing
    let typingTimeout;
    let typingDebounceTimer;
    let lastTypingSent = 0;
    const TYPING_DEBOUNCE_TIME = 1000; // 1 segundo entre actualizaciones
    const TYPING_STOP_TIME = 2000; // 2 segundos para marcar como dej√≥ de escribir

    function showError(message) {
      // Usar notificaci√≥n moderna en lugar del div de error
      const isSuccess = message.includes('‚úÖ');
      const isWarning = message.includes('‚ö†Ô∏è') || message.includes('Falta') || message.includes('configurada');

      let type = 'error';
      if (isSuccess) type = 'success';
      if (isWarning) type = 'warning';

      // Limpiar emojis para el t√≠tulo
      const cleanMessage = message.replace(/[‚úÖ‚ùå‚ö†Ô∏è]/g, '').trim();
      const title = isSuccess ? '√âxito' : isWarning ? 'Advertencia' : 'Error';

      showNotification(title, cleanMessage, type, 5000);

      // Tambi√©n mantener compatibilidad con el div de error para el login
      const errorDiv = document.getElementById('errorMessage');
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => {
          errorDiv.style.display = 'none';
        }, 5000);
      }
    }

    // Nueva funci√≥n para mostrar notificaciones en el chat
    function showChatNotification(message, isError = false) {
      console.log('üì¢ Notificaci√≥n en chat:', message, 'Error:', isError);

      // Usar el sistema de notificaciones moderno
      const isSuccess = message.includes('‚úÖ');
      const type = isError ? 'error' : isSuccess ? 'success' : 'info';

      // Limpiar emojis para el t√≠tulo
      const cleanMessage = message.replace(/[‚úÖ‚ùå‚ö†Ô∏è]/g, '').trim();
      const title = isError ? 'Error' : isSuccess ? '√âxito' : 'Informaci√≥n';

      showNotification(title, cleanMessage, type, 3000);
    }

    async function handleLogin() {
      const usernameInput = document.getElementById('loginUsername').value.trim();
      const passwordInput = document.getElementById('loginPassword').value;
      const displayNameInput = document.getElementById('loginDisplayName').value.trim();
      const rememberMe = document.getElementById('rememberMe').checked;

      // Validaciones b√°sicas
      if (!usernameInput) {
        showError('Por favor ingresa un usuario');
        return;
      }

      if (!passwordInput) {
        showError('Por favor ingresa una contrase√±a');
        return;
      }

      // Validar formato de usuario
      let formattedUsername = usernameInput.toLowerCase().replace(/\s+/g, '');
      if (!formattedUsername.startsWith('@')) {
        formattedUsername = '@' + formattedUsername;
      }

      try {
        // Verificar si el usuario existe en la base de datos
        const { data: existingUser } = await db
          .from('users')
          .select('*')
          .eq('username', formattedUsername)
          .maybeSingle();

        if (existingUser) {
          // USUARIO EXISTENTE: validar contrase√±a contra la BD
          if (existingUser.password !== passwordInput) {
            showError('Contrase√±a incorrecta');
            return;
          }

          // Usar el nombre de la BD si no se proporcion√≥ uno nuevo
          userid = formattedUsername;
          userPassword = passwordInput;

          if (displayNameInput && displayNameInput !== existingUser.display_name) {
            // Si el usuario escribi√≥ un nombre diferente, usarlo y actualizar BD
            displayName = displayNameInput;
            await db
              .from('users')
              .update({ display_name: displayName })
              .eq('username', formattedUsername);
          } else {
            // Usar el nombre almacenado en la BD
            displayName = existingUser.display_name;
          }

        } else {
          // NUEVO USUARIO: validar contrase√±a segura y pedir nombre
          const passwordValidation = validatePassword(passwordInput);
          if (!passwordValidation.valid) {
            showError('La contrase√±a no cumple con los requisitos de seguridad');
            return;
          }

          if (!displayNameInput) {
            showError('Por favor ingresa tu nombre para mostrar');
            return;
          }

          // Crear nuevo usuario
          userid = formattedUsername;
          displayName = displayNameInput;
          userPassword = passwordInput;

          // Guardar en la base de datos
          await db.from('users').insert({
            username: userid,
            display_name: displayName,
            password: userPassword
          });
        }

        // Guardar credenciales seg√∫n "Recordar inicio de sesi√≥n"
        if (rememberMe) {
          localStorage.setItem('userid', userid);
          localStorage.setItem('display_name', displayName);
          localStorage.setItem('user_password', btoa(userPassword));
          localStorage.setItem('remember_session', 'true');
        } else {
          sessionStorage.setItem('userid', userid);
          sessionStorage.setItem('display_name', displayName);
        }

        // Mostrar chat y ocultar login
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('container').style.display = 'flex';

        // Inicializar chat
        initChat();

      } catch (error) {
        console.error('Error en el login:', error);
        showError('Error al procesar el login. Intenta nuevamente.');
      }
    }

    // Verificar sesi√≥n guardada al cargar
    async function checkSavedSession() {
      const rememberSession = localStorage.getItem('remember_session');

      if (rememberSession === 'true') {
        const savedUserid = localStorage.getItem('userid');
        const savedDisplayName = localStorage.getItem('display_name');
        const savedPassword = localStorage.getItem('user_password');

        if (savedUserid && savedDisplayName && savedPassword) {
          try {
            // Verificar en base de datos
            const { data: existingUser } = await db
              .from('users')
              .select('*')
              .eq('username', savedUserid)
              .maybeSingle();

            if (existingUser) {
              const decryptedPassword = atob(savedPassword);
              // Validar contrase√±a contra la base de datos
              if (existingUser.password === decryptedPassword) {
                userid = savedUserid;
                displayName = savedDisplayName;
                userPassword = decryptedPassword;

                // Auto-login exitoso - NO mostrar pantalla de login
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('container').style.display = 'flex';

                // Asegurar que el chat est√© completamente inicializado
                setTimeout(() => {
                  initChat();
                }, 100);
                return true;
              } else {
                // Contrase√±a incorrecta - limpiar datos inv√°lidos
                localStorage.removeItem('userid');
                localStorage.removeItem('display_name');
                localStorage.removeItem('user_password');
                localStorage.removeItem('remember_session');
              }
            } else {
              // Usuario no existe en BD - limpiar datos
              localStorage.removeItem('userid');
              localStorage.removeItem('display_name');
              localStorage.removeItem('user_password');
              localStorage.removeItem('remember_session');
            }
          } catch (error) {
            console.error('Error al verificar sesi√≥n:', error);
            // Limpiar datos inv√°lidos
            localStorage.removeItem('userid');
            localStorage.removeItem('display_name');
            localStorage.removeItem('user_password');
            localStorage.removeItem('remember_session');
          }
        }
      }
      return false;
    }

    function initChat() {
      console.log('üöÄ === INICIANDO CHAT ===');
      console.log('Usuario:', userid);
      console.log('Nombre:', displayName);
      console.log('Elemento #chat existe:', document.getElementById('chat') ? 'S√≠' : 'No');
      console.log('Elemento #sidebar existe:', document.getElementById('sidebar') ? 'S√≠' : 'No');
      console.log('Elemento .sidebar-toggle existe:', document.querySelector('.sidebar-toggle') ? 'S√≠' : 'No');

      // Verificar si es administrador
      const isAdmin = userid === '@proyectoja';

      // Mostrar nombre de usuario con indicador de administrador si corresponde
      let usernameHTML = `<div style="display: flex; align-items: center; white-space: nowrap; max-width: 300px;">
        <span style="overflow: hidden; text-overflow: ellipsis;">${displayName}</span>`;
      if (isAdmin) {
        usernameHTML += ' <span style="color: gold; font-size: 14px; flex-shrink: 0;" title="Administrador">Admin</span>';
      }
      usernameHTML += `</div><small style="opacity:0.7">${userid}</small>`;

      document.getElementById('usernameDisplay').innerHTML = usernameHTML;

      // Mostrar avatar en el top bar con indicador de administrador
      const avatarTop = document.getElementById('userAvatarTop');
      if (avatarTop && displayName) {
        avatarTop.textContent = displayName.charAt(0).toUpperCase();

        // Agregar estilo especial para administrador
        if (isAdmin) {
          avatarTop.style.background = 'linear-gradient(135deg, #DAA520 0%, #FFD700 100%)';
          avatarTop.style.boxShadow = '0 3px 6px rgba(218, 165, 32, 0.4)';

          // Agregar badge de administrador
          const adminBadge = document.createElement('div');
          adminBadge.style.cssText = 'position: absolute; bottom: -3px; right: -3px; background: gold; color: #8B4513; width: 14px; height: 14px; border-radius: 50%; font-size: 9px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 1px solid #8B4513;';
          adminBadge.textContent = 'A';
          adminBadge.title = 'Administrador';
          avatarTop.style.position = 'relative';
          avatarTop.appendChild(adminBadge);
        }
      }

      connectUser();
      loadMessages();
      loadOnlineUsers();

      // Inicializar suscripci√≥n a typing
      initTypingSubscription();

      // Inicializar suscripci√≥n a mensajes en tiempo real
      initMessagesSubscription();

      // Inicializar sistema anti-spam
      if (messageTimer) {
        clearInterval(messageTimer);
      }
      messageTimer = setInterval(() => {
        messageCount = 0;
        updateSpamCounter();
      }, 1000);

      // Crear contador de spam si no existe
      let counter = document.getElementById('spamCounter');
      if (!counter) {
        counter = document.createElement('div');
        counter.id = 'spamCounter';
        counter.style.cssText = 'padding: 10px 15px; background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.25) 100%); border-radius: 10px; font-size: 14px; font-weight: bold; margin-bottom: 12px; text-align: center; display: none; border: 1px solid rgba(239, 68, 68, 0.3);';
        document.getElementById('inputArea').insertBefore(counter, document.getElementById('inputArea').firstChild);
      }
      updateSpamCounter();

      // Inicializar contador de caracteres
      updateCharCounter();

      // Inicializar sistema anti-spam
      if (messageTimer) {
        clearInterval(messageTimer);
      }
      messageTimer = setInterval(() => {
        messageCount = 0;
        updateSpamCounter();
      }, 1000);

      // INICIALIZAR SIDEBAR - ESTO ES LO QUE FALTABA
      initSidebar();

      // Agregar mensaje de prueba para verificar estilos
      setTimeout(() => {
        const testMessage = {
          username: 'Sistema',
          content: '¬°Bienvenido al chat! Puedes dejar tus pedidos de oraci√≥n, agradecimientos, saludos y consultas aqu√≠.',
          created_at: new Date().toISOString()
        };
        addMessage(testMessage);
      }, 500);

      // Enfocar input de mensaje
      document.getElementById('messageInput').focus();
    }

    // Funci√≥n para inicializar la suscripci√≥n a typing
    function initTypingSubscription() {
      console.log('Inicializando suscripci√≥n a typing...');

      try {
        // Cancelar suscripci√≥n anterior si existe
        if (window.typingChannel) {
          db.removeChannel(window.typingChannel);
        }

        // Crear nueva suscripci√≥n
        window.typingChannel = db.channel('typing_updates_' + userid);

        window.typingChannel
          .on(
            'postgres_changes',
            {
              event: '*',
              schema: 'public',
              table: 'typing'
            },
            (payload) => {
              console.log('üì¢ EVENTO TYPING RECIBIDO:', payload);

              // Ignorar nuestros propios eventos
              if (payload.new && payload.new.userid === userid) {
                console.log('Ignorando evento propio');
                return;
              }

              // Mostrar qui√©n est√° escribiendo
              if (payload.new && payload.new.typing) {
                const nombre = payload.new.username || payload.new.userid || 'Alguien';
                console.log(`${nombre} est√° escribiendo‚Ä¶`);
                document.getElementById('typing').textContent =
                  `${nombre} est√° escribiendo‚Ä¶`;

                // Limpiar despu√©s de 3 segundos
                setTimeout(() => {
                  document.getElementById('typing').textContent = '';
                }, 3000);
              } else {
                console.log('Typing detenido');
                document.getElementById('typing').textContent = '';
              }
            }
          )
          .subscribe((status) => {
            console.log('Estado de suscripci√≥n typing:', status);
          });

        console.log('‚úÖ Suscripci√≥n a typing inicializada');
      } catch (error) {
        console.error('‚ùå Error al inicializar suscripci√≥n a typing:', error);
      }
    }

    // Funci√≥n para inicializar la suscripci√≥n a mensajes en tiempo real
    function initMessagesSubscription() {
      console.log('üîî Inicializando suscripci√≥n a mensajes en tiempo real...');

      try {
        // Cancelar suscripci√≥n anterior si existe
        if (window.messageSubscription) {
          db.removeChannel(window.messageSubscription);
        }

        // Crear nuevo canal
        window.messageSubscription = db.channel('realtime_messages_' + userid + '_' + Date.now());

        window.messageSubscription
          .on("postgres_changes", {
            event: "INSERT",
            schema: "public",
            table: "messages"
          }, (payload) => {
            console.log('üì® NUEVO MENSAJE RECIBIDO (INSERT):', payload);
            console.log('Contenido:', payload.new.content);
            console.log('Usuario:', payload.new.username);

            // Verificar que no sea nuestro propio mensaje reci√©n enviado
            const isOwnMessage = displayName && payload.new.username === displayName;
            console.log('¬øEs nuestro mensaje?', isOwnMessage);

            // Siempre agregar el mensaje
            addMessage(payload.new);
          })
          .on("postgres_changes", {
            event: "UPDATE",
            schema: "public",
            table: "messages"
          }, (payload) => {
            console.log('Mensaje actualizado:', payload);
            // Actualizar el mensaje en la interfaz si existe
            const messageElement = document.querySelector(`.msg[data-message-id="${payload.new.id}"]`);
            if (messageElement) {
              // Si el mensaje fue eliminado, actualizar la interfaz
              if (payload.new.deleted || payload.new.content === '[Mensaje eliminado]') {
                const textElement = messageElement.querySelector('.msg-text');
                if (textElement) {
                  textElement.textContent = '[Mensaje eliminado]';
                }

                // Agregar informaci√≥n de eliminaci√≥n por administrador si corresponde
                if (payload.new.deleted_by_admin && payload.new.deleted_by === '@proyectoja') {
                  // Verificar si ya existe la informaci√≥n de eliminaci√≥n
                  let deleteInfo = messageElement.querySelector('.delete-info');
                  if (!deleteInfo) {
                    deleteInfo = document.createElement('div');
                    deleteInfo.className = 'delete-info';
                    deleteInfo.style.cssText = 'font-size: 10px; opacity: 0.8; margin-top: 2px; font-style: italic; color: rgba(255, 215, 0, 0.9);';
                    deleteInfo.textContent = 'Eliminado por administrador';

                    // Insertar en el msg-bubble
                    const msgBubble = messageElement.querySelector('.msg-bubble');
                    if (msgBubble) {
                      msgBubble.appendChild(deleteInfo);
                    }
                  }

                  // Agregar clase especial para mensajes eliminados por administrador
                  messageElement.classList.add('deleted-by-admin');
                }

                // Remover el bot√≥n de eliminar
                const deleteBtn = messageElement.querySelector('.delete-btn');
                if (deleteBtn) {
                  deleteBtn.remove();
                }

                // Remover el bot√≥n de responder
                const replyBtn = messageElement.querySelector('.reply-btn');
                if (replyBtn) {
                  replyBtn.remove();
                }

                // Agregar clase para estilo de mensaje eliminado
                messageElement.classList.add('deleted');
              }
            } else {
              // Si el elemento no existe, agregarlo (podr√≠a ser un mensaje antiguo que se actualiz√≥)
              addMessage(payload.new);
            }
          })
          .subscribe((status) => {
            console.log('Estado de suscripci√≥n a mensajes:', status);
            if (status === 'SUBSCRIBED') {
              console.log('‚úÖ Suscrito correctamente a mensajes en tiempo real');
            } else if (status === 'CHANNEL_ERROR') {
              console.error('‚ùå Error en la suscripci√≥n a mensajes');
            }
          });

        console.log('‚úÖ Suscripci√≥n a mensajes inicializada');
      } catch (error) {
        console.error('‚ùå Error al inicializar suscripci√≥n a mensajes:', error);
      }
    }

    // Configurar l√≥gica para mostrar/ocultar campo de nombre
    document.addEventListener('DOMContentLoaded', async () => {
      const usernameInput = document.getElementById('loginUsername');
      const displayNameGroup = document.getElementById('displayNameGroup');
      const passwordInput = document.getElementById('loginPassword');

      // Verificar si hay datos en localStorage al cargar la p√°gina
      const rememberSession = localStorage.getItem('remember_session');
      const savedUserid = localStorage.getItem('userid');
      const savedDisplayName = localStorage.getItem('display_name');

      if (rememberSession === 'true' && savedUserid && savedDisplayName) {
        // Autocompletar username si hay datos guardados
        usernameInput.value = savedUserid;
        // Tambi√©n autocompletar display name pero mantener oculto
        document.getElementById('loginDisplayName').value = savedDisplayName;
        // El campo de nombre debe permanecer OCULTO
        displayNameGroup.style.display = 'none';
      }

      // Funci√≥n para verificar si el usuario existe
      async function checkUserExists(username) {
        if (!username) return null;

        let formattedUsername = username.toLowerCase().replace(/\s+/g, '');
        if (!formattedUsername.startsWith('@')) {
          formattedUsername = '@' + formattedUsername;
        }

        try {
          const { data: existingUser } = await db
            .from('users')
            .select('display_name, password')
            .eq('username', formattedUsername)
            .maybeSingle();

          return existingUser;
        } catch (error) {
          console.error('Error al verificar usuario:', error);
          return null;
        }
      }

      // Evento cuando el usuario escribe en el campo de username
      usernameInput.addEventListener('input', async () => {
        const username = usernameInput.value.trim();

        if (!username) {
          // Si no hay username, ocultar campo de nombre
          displayNameGroup.style.display = 'none';
          document.getElementById('loginDisplayName').value = '';
          document.getElementById('passwordRequirements').style.display = 'none';
          return;
        }

        // Verificar primero si hay datos en localStorage para este usuario
        const rememberSession = localStorage.getItem('remember_session');
        const savedUserid = localStorage.getItem('userid');

        // Si hay sesi√≥n recordada y el usuario coincide con el ingresado
        if (rememberSession === 'true' && savedUserid) {
          let formattedInput = username.toLowerCase().replace(/\s+/g, '');
          if (!formattedInput.startsWith('@')) {
            formattedInput = '@' + formattedInput;
          }

          let formattedSaved = savedUserid.toLowerCase().replace(/\s+/g, '');
          if (!formattedSaved.startsWith('@')) {
            formattedSaved = '@' + formattedSaved;
          }

          if (formattedInput === formattedSaved) {
            // Es el mismo usuario guardado en localStorage - NO mostrar campo de nombre
            displayNameGroup.style.display = 'none';
            document.getElementById('loginDisplayName').value = localStorage.getItem('display_name') || '';
            document.getElementById('passwordRequirements').style.display = 'none';
            return; // Salir, ya sabemos que es usuario existente
          }
        }

        // Si llegamos aqu√≠, el usuario NO coincide con localStorage
        // Verificar en la base de datos
        setTimeout(async () => {
          const existingUser = await checkUserExists(username);

          if (existingUser) {
            // Usuario existe en BD - usar nombre almacenado, NO pedirlo
            displayNameGroup.style.display = 'none';
            document.getElementById('loginDisplayName').value = existingUser.display_name || '';

            // Para usuarios existentes, NO mostrar requisitos de contrase√±a
            document.getElementById('passwordRequirements').style.display = 'none';
          } else {
            // Usuario NO existe en BD - mostrar campo de nombre (obligatorio para nuevo usuario)
            displayNameGroup.style.display = 'block';
            document.getElementById('loginDisplayName').value = '';

            // Para nuevos usuarios, mostrar requisitos si hay contrase√±a
            if (passwordInput.value.length > 0) {
              updatePasswordRequirements(passwordInput.value);
            }
          }
        }, 300);
      });

      // Evento para contrase√±a
      passwordInput.addEventListener('input', async (e) => {
        const username = usernameInput.value.trim();

        if (!username) {
          // Si no hay username, mostrar requisitos (asumimos nuevo usuario)
          updatePasswordRequirements(e.target.value);
          return;
        }

        const existingUser = await checkUserExists(username);

        if (!existingUser) {
          // Solo mostrar requisitos para NUEVOS usuarios
          updatePasswordRequirements(e.target.value);
        } else {
          // Ocultar requisitos para usuarios EXISTENTES
          document.getElementById('passwordRequirements').style.display = 'none';
        }
      });

      // Verificar sesi√≥n guardada al cargar
      const hasValidSession = await checkSavedSession();
      if (!hasValidSession) {
        // NO hay sesi√≥n v√°lida - mostrar pantalla de login
        document.getElementById('loginContainer').style.display = 'flex';
        document.getElementById('container').style.display = 'none';
      } else {
        // Hay sesi√≥n v√°lida - asegurar que el chat est√© visible
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('container').style.display = 'flex';
        // Inicializar el chat (checkSavedSession ya llam√≥ a initChat dentro del setTimeout)
        // Pero llamamos de nuevo para asegurar que todo se inicialice correctamente
        setTimeout(() => {
          if (userid && displayName) {
            initChat();
          }
        }, 200);
      }
    });

    /* ============================================================
       NOTA: Sistema de tema claro/oscuro removido seg√∫n solicitud
    ============================================================ */

    /* ============================================================
       CAMBIAR NOMBRE Y CERRAR SESI√ìN
    ============================================================ */
    function changeName() {
      const nuevo = prompt("Nuevo nombre:");
      if (!nuevo) return;

      displayName = nuevo.trim();

      // Actualizar en la base de datos
      db.from('users')
        .update({ display_name: displayName })
        .eq('username', userid)
        .then(() => {
          console.log('Nombre actualizado en la base de datos');
        })
        .catch(error => {
          console.error('Error al actualizar nombre:', error);
        });

      // Actualizar seg√∫n el tipo de sesi√≥n
      if (localStorage.getItem('remember_session') === 'true') {
        localStorage.setItem('display_name', displayName);
      } else {
        sessionStorage.setItem('display_name', displayName);
      }

      document.getElementById('usernameDisplay').innerHTML =
        `${displayName}<br><small style="opacity:0.7">${userid}</small>`;

      // Actualizar avatar en el top bar
      const avatarTop = document.getElementById('userAvatarTop');
      if (avatarTop && displayName) {
        avatarTop.textContent = displayName.charAt(0).toUpperCase();
      }

      connectUser();
    }

    async function logout() {
      const confirmed = await showConfirm('Cerrar sesi√≥n', '¬øEst√°s seguro de que deseas cerrar sesi√≥n?', {
        confirmText: 'Cerrar sesi√≥n',
        cancelText: 'Cancelar',
        type: 'warning'
      });

      if (confirmed) {
        // Limpiar localStorage y sessionStorage
        localStorage.removeItem('userid');
        localStorage.removeItem('display_name');
        localStorage.removeItem('user_password');
        localStorage.removeItem('remember_session');
        sessionStorage.clear();

        // Desconectar usuario
        if (userid) {
          db.from('online_users').delete().eq('userid', userid);
        }

        // Mostrar solo usuario y contrase√±a (limpiar nombre y ocultar campo)
        document.getElementById('loginUsername').value = userid || '';
        document.getElementById('loginPassword').value = '';
        document.getElementById('loginDisplayName').value = '';
        document.getElementById('displayNameGroup').style.display = 'block';
        document.getElementById('rememberMe').checked = false;
        document.getElementById('passwordRequirements').style.display = 'none';

        // Mostrar login y ocultar chat
        document.getElementById('loginContainer').style.display = 'flex';
        document.getElementById('container').style.display = 'none';

        // Resetear variables
        userid = null;
        displayName = null;
        userPassword = null;
      }
    }

    /* ============================================================
       ONLINE USERS - MEJORADO
    ============================================================ */
    async function connectUser() {
      try {
        console.log("Conectando usuario:", { userid, displayName });

        // Primero, verificar si el usuario ya existe
        const { data: existingUser, error: checkError } = await db
          .from("online_users")
          .select("*")
          .eq("userid", userid)
          .maybeSingle();

        if (checkError) {
          console.error("Error al verificar usuario existente:", checkError);
        }

        console.log("Usuario existente:", existingUser);

        // Asegurar que displayName tenga un valor v√°lido
        const safeDisplayName = displayName || userid || 'Usuario';

        if (existingUser) {
          // Actualizar usuario existente
          const updateData = {
            username: userid,
            display_name: safeDisplayName,
            last_seen: new Date().toISOString()
          };
          console.log("Actualizando usuario con:", updateData);

          const { error: updateError } = await db
            .from("online_users")
            .update(updateData)
            .eq("userid", userid);

          if (updateError) {
            console.error("Error al actualizar usuario:", updateError);
          } else {
            console.log("Usuario actualizado correctamente");
          }
        } else {
          // Insertar nuevo usuario
          const insertData = {
            userid,
            username: userid,
            display_name: safeDisplayName,
            last_seen: new Date().toISOString(),
            connected_at: new Date().toISOString()
          };
          console.log("Insertando nuevo usuario con:", insertData);

          const { error: insertError } = await db
            .from("online_users")
            .insert(insertData);

          if (insertError) {
            console.error("Error al insertar usuario:", insertError);
          } else {
            console.log("Usuario insertado correctamente");
          }
        }
      } catch (error) {
        console.error("Error al conectar usuario:", error);
      }
    }

    // actualizar cada 10s
    setInterval(connectUser, 10000);

    function renderAvatar(name) {
      if (!name) return "?";
      // Si el nombre comienza con @, tomar el segundo car√°cter
      if (name.startsWith('@') && name.length > 1) {
        return name.charAt(1).toUpperCase();
      }
      return name.charAt(0).toUpperCase();
    }

    async function loadOnlineUsers() {
      try {
        console.log("Cargando usuarios conectados...");
        const now = Date.now();

        // Intentar cargar usuarios, pero continuar incluso si hay error
        let data = [];
        let error = null;

        try {
          const result = await db.from("online_users").select("*");
          data = result.data || [];
          error = result.error;
        } catch (fetchError) {
          console.warn("No se pudo cargar usuarios (tabla puede no existir):", fetchError.message);
          data = [];
        }

        if (error) {
          console.warn("Error al cargar usuarios (continuando):", error.message);
        }

        console.log("Usuarios en la base de datos:", data);

        // Intentar borrar inactivos (m√°s de 30 segundos)
        try {
          const expired = data.filter(u => u.last_seen && (now - new Date(u.last_seen)) > 30000);
          for (const u of expired) {
            if (u.userid) {
              await db.from("online_users").delete().eq("userid", u.userid);
            }
          }
        } catch (deleteError) {
          console.warn("No se pudieron eliminar usuarios inactivos:", deleteError.message);
        }

        const active = data.filter(u => (now - new Date(u.last_seen)) <= 30000);
        const list = document.getElementById("usersList");
        list.innerHTML = "";

        // Mostrar mensaje si no hay usuarios
        if (active.length === 0) {
          list.innerHTML = '<div style="padding: 10px; text-align: center; opacity: 0.7;">No hay usuarios conectados</div>';
          return;
        }

        // Ordenar alfab√©ticamente por display_name
        active.sort((a, b) => a.display_name?.localeCompare(b.display_name || ""));

        // Mostrar contador
        const title = document.querySelector("#sidebar h3");
        if (title) {
          title.textContent = `Conectados (${active.length})`;
        }

        active.forEach(u => {
          const div = document.createElement("div");
          div.className = "userItem";

          // Resaltar al usuario actual
          if (u.userid === userid) {
            div.style.backgroundColor = "rgba(100, 30, 30, 0.7)";
            div.style.borderLeft = "3px solid rgba(100,30,30)";
          }

          // Determinar si es administrador
          const isAdminUser = u.userid === '@proyectoja';
          const isCurrentUserAdmin = userid === '@proyectoja';

          // Color de fondo diferente para administrador
          let avatarBackground = '#5f9ea0';
          if (u.userid === userid) {
            avatarBackground = '#4682b4';
          } else if (isAdminUser) {
            avatarBackground = '#DAA520';
          }

          div.innerHTML = `
        <div class="avatar" style="background: ${avatarBackground};">
          ${renderAvatar(u.display_name)}
          ${isAdminUser ? '<div style="position: absolute; bottom: -2px; right: -2px; background: gold; color: #8B4513; width: 12px; height: 12px; border-radius: 50%; font-size: 8px; display: flex; align-items: center; justify-content: center;">A</div>' : ''}
                </div>
        <div style="flex: 1; min-width: 0;">
          <b style="color:white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px; display: inline-block;">${u.display_name || u.userid || "Usuario"}</b>
          ${isAdminUser ? ' <span style="color: gold; font-size: 10px; flex-shrink: 0; white-space: nowrap;">Admin</span>' : ''}
          ${u.userid === userid ? ' <small style="color: steelblue; flex-shrink: 0; white-space: nowrap;">(T√∫)</small>' : ''}<br>
          <small style="opacity: 0.7; color: white;">${u.userid}</small>
        </div>
      `;

          list.appendChild(div);
        });
      } catch (error) {
        console.error("Error en loadOnlineUsers:", error);
      }
    }

    // Funci√≥n para limpiar usuarios sin nombre en la tabla online_users
    async function cleanupUsersWithoutName() {
      try {
        console.log("üîß Limpiando usuarios sin nombre...");

        // Obtener todos los usuarios online
        const { data: allUsers, error } = await db.from("online_users").select("*");

        if (error) {
          console.warn("No se pudo obtener usuarios para limpieza:", error.message);
          return;
        }

        // Encontrar usuarios sin display_name o con display_name vac√≠o/nulo
        const usersWithoutName = allUsers.filter(u =>
          !u.display_name ||
          u.display_name.trim() === '' ||
          u.display_name === 'Sin nombre' ||
          u.display_name === 'Usuario'
        );

        if (usersWithoutName.length > 0) {
          console.log(`Encontrados ${usersWithoutName.length} usuarios sin nombre v√°lido`);

          // Para cada usuario sin nombre, intentar obtenerlo de la tabla users
          for (const user of usersWithoutName) {
            if (user.userid) {
              try {
                // Intentar obtener el display_name de la tabla users
                const { data: userData } = await db
                  .from("users")
                  .select("display_name")
                  .eq("username", user.userid)
                  .maybeSingle();

                if (userData && userData.display_name) {
                  // Actualizar con el nombre correcto
                  await db
                    .from("online_users")
                    .update({
                      display_name: userData.display_name,
                      last_seen: new Date().toISOString()
                    })
                    .eq("userid", user.userid);

                  console.log(`‚úÖ Usuario ${user.userid} actualizado: ${userData.display_name}`);
                } else {
                  // Si no existe en users, usar el userid como display_name
                  await db
                    .from("online_users")
                    .update({
                      display_name: user.userid,
                      last_seen: new Date().toISOString()
                    })
                    .eq("userid", user.userid);

                  console.log(`‚úÖ Usuario ${user.userid} actualizado con userid como nombre`);
                }
              } catch (updateError) {
                console.warn(`Error al actualizar usuario ${user.userid}:`, updateError.message);
              }
            }
          }

          console.log("‚úÖ Limpieza de usuarios sin nombre completada");
        } else {
          console.log("‚úÖ No hay usuarios sin nombre que limpiar");
        }
      } catch (error) {
        console.error("Error en cleanupUsersWithoutName:", error);
      }
    }

    // Cargar usuarios al inicio y cada 5 segundos
    loadOnlineUsers();
    setInterval(loadOnlineUsers, 5000);

    // Ejecutar limpieza de usuarios sin nombre cada 30 segundos
    setTimeout(() => {
      cleanupUsersWithoutName();
      // Ejecutar peri√≥dicamente cada 30 segundos
      setInterval(cleanupUsersWithoutName, 30000);
    }, 10000);

    // Funci√≥n para que el administrador pueda ejecutar limpieza manualmente
    window.cleanupUsersManually = function () {
      if (userid === '@proyectoja') {
        console.log("üßπ Ejecutando limpieza manual de usuarios...");
        cleanupUsersWithoutName();
        showChatNotification("Limpieza de usuarios ejecutada", false);
      } else {
        console.log("Solo el administrador puede ejecutar limpieza manual");
        showChatNotification("Solo el administrador puede ejecutar esta acci√≥n", true);
      }
    };

    // Suscribirse a cambios en tiempo real
    try {
      db.channel("online_users_changes")
        .on(
          "postgres_changes",
          {
            event: "*",
            schema: "public",
            table: "online_users"
          },
          () => {
            loadOnlineUsers();
          }
        )
        .subscribe();
    } catch (error) {
      console.error("Error al suscribirse a online_users:", error);
    }

    /* ============================================================
       CHAT CON L√çMITE DE MENSAJES
    ============================================================ */
    // VARIABLE CONFIGURABLE: N√∫mero m√°ximo de mensajes a mostrar/guardar
    const MAX_MESSAGES = 20;

    function formatTime(t) {
      return new Date(t).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    function formatTimeAMPM(t) {
      const date = new Date(t);
      let hours = date.getHours();
      let minutes = date.getMinutes();
      const ampm = hours >= 12 ? 'PM' : 'AM';

      hours = hours % 12;
      hours = hours ? hours : 12; // La hora 0 debe ser 12
      minutes = minutes < 10 ? '0' + minutes : minutes;

      return `${hours}:${minutes} ${ampm}`;
    }

    function addMessage(msg) {
      console.log('A√±adiendo mensaje:', msg);

      // Validar que el mensaje tenga los datos necesarios
      if (!msg || !msg.username) {
        console.error('Mensaje inv√°lido:', msg);
        return;
      }

      const div = document.createElement("div");

      // Determinar si es nuestro mensaje o de otro usuario
      const isOwnMessage = displayName && msg.username === displayName;
      div.className = isOwnMessage ? "msg own" : "msg other";

      // Verificar si el usuario actual es administrador
      const isAdmin = userid === '@proyectoja';
      // Verificar si el autor del mensaje es administrador
      const isMessageAuthorAdmin = msg.username === 'proyectoja' || msg.username === '@proyectoja' || msg.userid === '@proyectoja';

      // Agregar ID del mensaje como atributo data
      if (msg.id) {
        div.dataset.messageId = msg.id;
      }

      // Verificar si el mensaje est√° eliminado
      const isDeleted = msg.deleted || msg.content === '[Mensaje eliminado]';

      // Verificar si fue eliminado por administrador
      const deletedByAdmin = msg.deleted_by_admin || false;
      const deletedBy = msg.deleted_by || '';

      let messageContent = msg.content || '';
      let deleteInfo = '';

      if (isDeleted) {
        messageContent = '[Mensaje eliminado]';
        div.classList.add('deleted');

        // Agregar informaci√≥n adicional si fue eliminado por administrador
        if (deletedByAdmin && deletedBy === '@proyectoja') {
          deleteInfo = '<div class="delete-info" style="font-size: 10px; opacity: 0.8; margin-top: 2px; font-style: italic;">Eliminado por administrador</div>';
          div.classList.add('deleted-by-admin');
        }
      }

      // Determinar si mostrar bot√≥n de eliminar:
      // - Para mensajes propios no eliminados
      // - Para administrador en cualquier mensaje no eliminado
      const showDeleteButton = !isDeleted && msg.id && (isOwnMessage || isAdmin);

      // Estilo especial para bot√≥n de administrador
      const deleteButtonClass = isAdmin && !isOwnMessage ? 'delete-btn admin-delete-btn' : 'delete-btn';

      // Obtener inicial para el avatar (evitar 'P' de 'proyectoja')
      let userInitial = '?';
      if (msg.username) {
        // Si el username comienza con '@', tomar el segundo car√°cter
        if (msg.username.startsWith('@')) {
          userInitial = msg.username.length > 1 ? msg.username.charAt(1).toUpperCase() : '?';
        } else {
          userInitial = msg.username.charAt(0).toUpperCase();
        }
        // Si es 'P' de 'proyectoja', usar 'A' para administrador
        if (userInitial === 'P' && (msg.username.toLowerCase().includes('proyecto') || isMessageAuthorAdmin)) {
          userInitial = 'A';
        }
      }

      // Crear HTML con avatar estilo WhatsApp (SOLO para mensajes de otros)
      div.innerHTML = `
    <div class="msg-container">
      ${!isOwnMessage ? `<div class="msg-avatar">${userInitial}</div>` : '<div class="msg-avatar" style="visibility: hidden;"></div>'}
      <div class="msg-content-wrapper">
                ${!isOwnMessage ? `<div class="msg-user"><div style="display: flex; align-items: center; white-space: nowrap; max-width: 200px;">
          <span style="overflow: hidden; text-overflow: ellipsis;">${msg.username || 'Usuario desconocido'}</span>
          ${isMessageAuthorAdmin ? ' <span class="admin-badge" title="Administrador" style="flex-shrink: 0;">üëë</span>' : ''}
        </div></div>` : ''}
        <div class="msg-bubble">
                                        ${msg.reply_to && msg.reply_content && msg.reply_username ? `
            <div class="msg-reply">
              <span class="msg-reply-author">${msg.reply_username.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}:</span>
              <span class="msg-reply-content">${msg.reply_content === '[Mensaje eliminado]' ? '[Mensaje eliminado]' : (msg.reply_content.length > 50 ? msg.reply_content.substring(0, 50) + '...' : msg.reply_content).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span>
            </div>
          ` : ''}
          <div class="msg-text">${messageContent}</div>
          ${deleteInfo}
          <div class="msg-footer">
            <div class="msg-time">${msg.created_at ? formatTimeAMPM(msg.created_at) : '--:-- --'}</div>
          </div>
        </div>
      </div>
      <div class="msg-actions">
        ${!isDeleted && msg.id ? `<button class="reply-btn" onclick="startReply(${msg.id}, encodeURIComponent('${msg.username.replace(/'/g, "\\'").replace(/\n/g, ' ')}'), encodeURIComponent('${messageContent.replace(/'/g, "\\'").replace(/\n/g, ' ')}'))" title="Responder">‚Ü©Ô∏è</button>` : ''}
        ${showDeleteButton ? '<button class="' + deleteButtonClass + '" onclick="deleteMessage(' + msg.id + ', this, ' + isAdmin + ')" title="Eliminar">üóëÔ∏è</button>' : ''}
      </div>
    </div>
  `;

      const chatDiv = document.getElementById("chat");
      if (chatDiv) {
        chatDiv.appendChild(div);

        // Mantener solo los √∫ltimos MAX_MESSAGES mensajes en la interfaz
        const allMessages = chatDiv.querySelectorAll('.msg');
        if (allMessages.length > MAX_MESSAGES) {
          // Eliminar el mensaje m√°s antiguo (el primero)
          allMessages[0].remove();
        }

        chatDiv.scrollTo({
          top: chatDiv.scrollHeight,
          behavior: "smooth"
        });

        console.log('Mensaje a√±adido correctamente');
      } else {
        console.error('No se encontr√≥ el elemento #chat');
      }
    }

    // Funci√≥n para eliminar un mensaje
    async function deleteMessage(messageId, buttonElement, isAdmin = false) {
      if (!messageId) {
        console.error('ID de mensaje no v√°lido');
        return;
      }

      let confirmTitle = 'Eliminar mensaje';
      let confirmMessage = '¬øEst√°s seguro de que quieres eliminar este mensaje?';
      let confirmType = 'warning';

      if (isAdmin && userid === '@proyectoja') {
        confirmTitle = 'Eliminar como administrador';
        confirmMessage = '¬øEst√°s seguro de que quieres eliminar este mensaje como administrador?\n\n‚ö†Ô∏è Esta acci√≥n eliminar√° el mensaje para todos los usuarios.';
        confirmType = 'danger';
      }

      const confirmed = await showConfirm(confirmTitle, confirmMessage, {
        confirmText: 'Eliminar',
        cancelText: 'Cancelar',
        type: confirmType
      });

      if (!confirmed) {
        return;
      }

      try {
        // Preparar datos de actualizaci√≥n
        const updateData = {
          content: '[Mensaje eliminado]',
          deleted: true,
          deleted_at: new Date().toISOString()
        };

        // Si es administrador, agregar informaci√≥n adicional
        if (isAdmin && userid === '@proyectoja') {
          updateData.deleted_by_admin = true;
          updateData.deleted_by = userid;
        }

        // Actualizar el mensaje en la base de datos
        const { error } = await db
          .from('messages')
          .update(updateData)
          .eq('id', messageId);

        if (error) {
          console.error('Error al eliminar mensaje:', error);
          showError('Error al eliminar el mensaje');
          return;
        }

        // Encontrar el elemento del mensaje y actualizarlo localmente
        const messageElement = buttonElement.closest('.msg');
        if (messageElement) {
          // Actualizar el contenido del mensaje
          const textElement = messageElement.querySelector('.msg-text');
          if (textElement) {
            textElement.textContent = '[Mensaje eliminado]';
          }

          // Agregar informaci√≥n de eliminaci√≥n por administrador si corresponde
          if (isAdmin && userid === '@proyectoja') {
            const deleteInfo = document.createElement('div');
            deleteInfo.className = 'delete-info';
            deleteInfo.style.cssText = 'font-size: 10px; opacity: 0.8; margin-top: 2px; font-style: italic; color: rgba(255, 215, 0, 0.9);';
            deleteInfo.textContent = 'Eliminado por administrador';

            const msgBubble = messageElement.querySelector('.msg-bubble');
            if (msgBubble) {
              msgBubble.appendChild(deleteInfo);
            }

            messageElement.classList.add('deleted-by-admin');
          }

          // Remover el bot√≥n de eliminar
          const deleteBtn = messageElement.querySelector('.delete-btn');
          if (deleteBtn) {
            deleteBtn.remove();
          }

          // Remover el bot√≥n de responder
          const replyBtn = messageElement.querySelector('.reply-btn');
          if (replyBtn) {
            replyBtn.remove();
          }

          // Agregar clase para estilo de mensaje eliminado
          messageElement.classList.add('deleted');

          console.log('Mensaje eliminado localmente');
        }

        // Mostrar mensaje de √©xito diferente para administrador
        if (isAdmin && userid === '@proyectoja') {
          showError('‚úÖ Mensaje eliminado por administrador');
        } else {
          showError('Mensaje eliminado correctamente');
        }
      } catch (error) {
        console.error('Error en deleteMessage:', error);

        // Mensaje de error m√°s espec√≠fico
        if (error.message && error.message.includes('column')) {
          showError('Error: La base de datos no est√° configurada correctamente. Ejecuta configurar_bd.sql en Supabase.');
        } else {
          showError('Error al eliminar el mensaje');
        }
      }
    }

    async function loadMessages() {
      console.log('üì• Cargando mensajes...');

      try {
        // Cargar solo los √∫ltimos MAX_MESSAGES mensajes
        console.log('Consultando mensajes...');
        const { data, error } = await db
          .from("messages")
          .select("*")
          .order("id", { ascending: false })
          .limit(MAX_MESSAGES);

        if (error) {
          console.error('‚ùå Error al cargar mensajes:', error);
          console.error('Detalles:', error.message);
          showError('Error al cargar mensajes: ' + error.message);
          return;
        }

        console.log(`‚úÖ ${data ? data.length : 0} mensajes cargados`);
        if (data && data.length > 0) {
          console.log('Ejemplo de mensaje:', data[0]);
        }

        if (data && data.length > 0) {
          // Mostrar en orden inverso (m√°s recientes primero) o en orden normal
          const chatDiv = document.getElementById("chat");
          if (chatDiv) {
            console.log('Elemento #chat encontrado, limpiando...');
            chatDiv.innerHTML = ''; // Limpiar antes de cargar

            // Ordenar por ID ascendente para mostrar del m√°s antiguo al m√°s nuevo
            data.sort((a, b) => a.id - b.id).forEach(addMessage);
            console.log('Mensajes mostrados en el chat');
          } else {
            console.error('No se encontr√≥ el elemento #chat');
          }
        } else {
          console.log('No hay mensajes para mostrar');
          const chatDiv = document.getElementById("chat");
          if (chatDiv) {
            chatDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #666; font-style: italic;">No hay mensajes a√∫n. ¬°S√© el primero en escribir!</div>';
          }
        }
      } catch (error) {
        console.error('Error en loadMessages:', error);
      }
    }

    // Funci√≥n para limpiar mensajes antiguos de la base de datos
    async function cleanOldMessages() {
      try {
        // Obtener todos los mensajes ordenados por ID descendente
        const { data: allMessages } = await db
          .from("messages")
          .select("id")
          .order("id", { ascending: false });

        if (allMessages && allMessages.length > MAX_MESSAGES) {
          // Encontrar el ID que est√° en la posici√≥n MAX_MESSAGES
          const lastIdToKeep = allMessages[MAX_MESSAGES - 1].id;

          // Eliminar todos los mensajes con ID menor al que queremos mantener
          const { error } = await db
            .from("messages")
            .delete()
            .lt("id", lastIdToKeep);

          if (error) {
            console.error("Error al eliminar mensajes antiguos:", error);
          } else {
            console.log(`Mensajes antiguos limpiados (manteniendo √∫ltimos ${MAX_MESSAGES})`);
          }
        }
      } catch (error) {
        console.error("Error en cleanOldMessages:", error);
      }
    }

    // Cancelar suscripci√≥n anterior si existe
    if (window.messageSubscription) {
      db.removeChannel(window.messageSubscription);
    }

    // Crear nuevo canal
    // window.messageSubscription = db.channel('realtime_messages_' + Date.now()); // COMENTADO: Suscripci√≥n duplicada

    window.messageSubscription
      .on("postgres_changes", {
        event: "INSERT",
        schema: "public",
        table: "messages"
      }, (payload) => {
        console.log('üì® NUEVO MENSAJE RECIBIDO (INSERT):', payload);
        console.log('Contenido:', payload.new.content);
        console.log('Usuario:', payload.new.username);

        // Verificar que no sea nuestro propio mensaje reci√©n enviado
        const isOwnMessage = displayName && payload.new.username === displayName;
        console.log('¬øEs nuestro mensaje?', isOwnMessage);

        // Siempre agregar el mensaje
        addMessage(payload.new);
      })
      .on("postgres_changes", {
        event: "UPDATE",
        schema: "public",
        table: "messages"
      }, (payload) => {
        console.log('Mensaje actualizado:', payload);
        // Actualizar el mensaje en la interfaz si existe
        const messageElement = document.querySelector(`.msg[data-message-id="${payload.new.id}"]`);
        if (messageElement) {
          // Si el mensaje fue eliminado, actualizar la interfaz
          if (payload.new.deleted || payload.new.content === '[Mensaje eliminado]') {
            const textElement = messageElement.querySelector('.msg-text');
            if (textElement) {
              textElement.textContent = '[Mensaje eliminado]';
            }

            // Agregar informaci√≥n de eliminaci√≥n por administrador si corresponde
            if (payload.new.deleted_by_admin && payload.new.deleted_by === '@proyectoja') {
              // Verificar si ya existe la informaci√≥n de eliminaci√≥n
              let deleteInfo = messageElement.querySelector('.delete-info');
              if (!deleteInfo) {
                deleteInfo = document.createElement('div');
                deleteInfo.className = 'delete-info';
                deleteInfo.style.cssText = 'font-size: 10px; opacity: 0.8; margin-top: 2px; font-style: italic; color: rgba(255, 215, 0, 0.9);';
                deleteInfo.textContent = 'Eliminado por administrador';

                // Insertar en el msg-bubble
                const msgBubble = messageElement.querySelector('.msg-bubble');
                if (msgBubble) {
                  msgBubble.appendChild(deleteInfo);
                }
              }

              // Agregar clase especial para mensajes eliminados por administrador
              messageElement.classList.add('deleted-by-admin');
            }

            // Remover el bot√≥n de eliminar
            const deleteBtn = messageElement.querySelector('.delete-btn');
            if (deleteBtn) {
              deleteBtn.remove();
            }

            // Remover el bot√≥n de responder
            const replyBtn = messageElement.querySelector('.reply-btn');
            if (replyBtn) {
              replyBtn.remove();
            }

            // Agregar clase para estilo de mensaje eliminado
            messageElement.classList.add('deleted');
          }
        } else {
          // Si el elemento no existe, agregarlo (podr√≠a ser un mensaje antiguo que se actualiz√≥)
          addMessage(payload.new);
        }
      })
      .subscribe((status) => {
        console.log('Estado de suscripci√≥n a mensajes:', status);
        if (status === 'SUBSCRIBED') {
          console.log('‚úÖ Suscrito correctamente a mensajes en tiempo real');
        }
      });

    /* ============================================================
       SISTEMA ANTI-SPAM
    ============================================================ */
    // NOTA: Las variables ya est√°n declaradas al principio del script
    // para evitar errores de referencia

    function updateSpamCounter() {
      const counter = document.getElementById('spamCounter');
      if (counter) {
        if (spamBlocked) {
          const timeLeft = Math.ceil((spamTimer - Date.now()) / 1000);
          counter.textContent = `Bloqueado por spam: ${timeLeft}s`;
          counter.style.color = '#ef4444';

          if (timeLeft <= 0) {
            spamBlocked = false;
            counter.style.display = 'none';
            document.getElementById('messageInput').disabled = false;
            document.querySelector('#inputArea button').disabled = false;
            clearInterval(window.spamInterval);
          }
        } else {
          counter.textContent = `Mensajes: ${messageCount}/${MAX_MESSAGES_PER_SECOND}`;
          counter.style.color = messageCount >= MAX_MESSAGES_PER_SECOND ? '#f59e0b' : '#10b981';
        }
      }
    }

    function checkSpam() {
      messageCount++;

      if (messageCount >= MAX_MESSAGES_PER_SECOND && !spamBlocked) {
        // Bloquear por spam
        spamBlocked = true;
        spamTimer = Date.now() + (SPAM_BLOCK_TIME * 1000);

        // Crear contador si no existe
        let counter = document.getElementById('spamCounter');
        if (!counter) {
          counter = document.createElement('div');
          counter.id = 'spamCounter';
          counter.style.cssText = 'padding: 8px 15px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; font-size: 14px; font-weight: bold; margin-bottom: 10px; text-align: center;';
          document.getElementById('inputArea').insertBefore(counter, document.getElementById('inputArea').firstChild);
        }

        // Deshabilitar input y bot√≥n
        document.getElementById('messageInput').disabled = true;
        document.querySelector('#inputArea button').disabled = true;

        // Iniciar contador regresivo
        updateSpamCounter();
        window.spamInterval = setInterval(updateSpamCounter, 1000);

        // Mostrar alerta
        showError(`¬°Demasiados mensajes! Bloqueado por ${SPAM_BLOCK_TIME} segundos.`);
        return true;
      }

      updateSpamCounter();
      return false;
    }

    /* ============================================================
       FUNCIONES PARA MANEJAR RESPUESTAS
    ============================================================ */
    // Funci√≥n para escapar texto para uso en HTML/JavaScript
    function escapeText(text) {
      if (!text) return '';
      return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;')
        .replace(/\n/g, ' ')
        .replace(/\r/g, ' ');
    }

    // Funci√≥n para iniciar una respuesta a un mensaje
    function startReply(messageId, encodedUsername, encodedContent) {
      // Decodificar los par√°metros
      const username = decodeURIComponent(encodedUsername);
      const content = decodeURIComponent(encodedContent);

      console.log('Iniciando respuesta al mensaje:', messageId, 'de', username, 'contenido:', content);

      // Verificar si el mensaje est√° eliminado por el contenido
      if (content === '[Mensaje eliminado]') {
        console.log('‚ùå No se puede responder a un mensaje eliminado (contenido)');
        showChatNotification('No se puede responder a un mensaje eliminado', true);
        return;
      }

      // Verificar si el mensaje est√° eliminado en el DOM
      const messageElement = document.querySelector(`.msg[data-message-id="${messageId}"]`);
      if (messageElement) {
        // Verificar si el mensaje est√° marcado como eliminado
        if (messageElement.classList.contains('deleted')) {
          console.log('‚ùå No se puede responder a un mensaje eliminado (DOM - clase deleted)');
          showChatNotification('No se puede responder a un mensaje eliminado', true);
          return;
        }

        // Verificar si el bot√≥n de responder todav√≠a existe (podr√≠a haber sido removido por una actualizaci√≥n en tiempo real)
        const replyBtn = messageElement.querySelector('.reply-btn');
        if (!replyBtn) {
          console.log('‚ùå No se puede responder - el bot√≥n de responder fue removido');
          showChatNotification('No se puede responder a este mensaje', true);
          return;
        }
      } else {
        // El mensaje no existe en el DOM (podr√≠a haber sido removido)
        console.log('‚ùå No se puede responder - el mensaje no existe en el DOM');
        showChatNotification('No se puede responder a este mensaje', true);
        return;
      }

      replyingTo = messageId;
      replyMessageData = {
        id: messageId,
        username: username,
        content: content
      };

      // Mostrar el √°rea de respuesta
      const replyArea = document.getElementById('replyArea');
      const replyAuthor = document.getElementById('replyAuthor');
      const replyText = document.getElementById('replyText');

      if (replyArea && replyAuthor && replyText) {
        replyAuthor.textContent = username + ': ';

        // Limitar el texto a mostrar (m√°ximo 100 caracteres)
        let displayContent = content;
        if (displayContent.length > 100) {
          displayContent = displayContent.substring(0, 100) + '...';
        }

        replyText.textContent = displayContent;
        replyArea.style.display = 'block';

        // Enfocar el input de mensaje
        document.getElementById('messageInput').focus();

        // Mostrar notificaci√≥n
        showChatNotification(`Respondiendo a ${username}`);
      }
    }

    // Funci√≥n para cancelar una respuesta
    function cancelReply() {
      console.log('Cancelando respuesta');

      replyingTo = null;
      replyMessageData = null;

      // Ocultar el √°rea de respuesta
      const replyArea = document.getElementById('replyArea');
      if (replyArea) {
        replyArea.style.display = 'none';
      }

      // Enfocar el input de mensaje
      document.getElementById('messageInput').focus();
    }

    // Funci√≥n para agregar informaci√≥n de respuesta al mensaje
    function addReplyInfo(messageData) {
      if (messageData.reply_to && messageData.reply_content && messageData.reply_username) {
        return `
      <div class="msg-reply">
        <span class="msg-reply-author">${messageData.reply_username}:</span>
        <span class="msg-reply-content">${messageData.reply_content}</span>
      </div>
    `;
      }
      return '';
    }

    /* ============================================================
       FUNCIONES PARA SELECTOR DE EMOJIS
    ============================================================ */
    // Funci√≥n para mostrar/ocultar el selector de emojis
    function toggleEmojiPicker() {
      const picker = document.getElementById('emojiPicker');
      if (!picker) {
        console.error('No se encontr√≥ el selector de emojis');
        return;
      }

      if (picker.classList.contains('show')) {
        picker.classList.remove('show');
      } else {
        picker.classList.add('show');
        // Inicializar emojis si es la primera vez
        if (!window.emojisInitialized) {
          initEmojis();
          window.emojisInitialized = true;
        }
        // Enfocar el input despu√©s de mostrar el selector
        setTimeout(() => {
          document.getElementById('messageInput').focus();
        }, 100);
      }
    }

    // Funci√≥n para inicializar los emojis
    function initEmojis() {
      console.log('Inicializando emojis...');

      // Emojis de caritas (populares)
      const faceEmojis = [
        'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£',
        'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞',
        'üòò', 'üòó', 'üòô', 'üòö', 'üòã', 'üòõ', 'üòù', 'üòú',
        'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©', 'ü•≥', 'üòè',
        'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£',
        'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†',
        'üò°', 'ü§¨', 'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®',
        'üò∞', 'üò•', 'üòì', 'ü§ó', 'ü§î', 'ü§≠', 'ü§´', 'ü§•',
        'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ', 'üò¶', 'üòß',
        'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê',
        'ü•¥', 'ü§¢', 'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï', 'ü§ë',
        'ü§†', 'üòà', 'üëø', 'üëπ', 'üë∫', 'ü§°', 'üí©', 'üëª',
        'üíÄ', '‚ò†Ô∏è', 'üëΩ', 'üëæ', 'ü§ñ', 'üéÉ', 'üò∫', 'üò∏',
        'üòπ', 'üòª', 'üòº', 'üòΩ', 'üôÄ', 'üòø', 'üòæ'
      ];

      // Emojis de manos
      const handEmojis = [
        'üëã', 'ü§ö', 'üñêÔ∏è', '‚úã', 'üññ', 'üëå', 'ü§å', 'ü§è',
        '‚úåÔ∏è', 'ü§û', 'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ',
        'üñï', 'üëá', '‚òùÔ∏è', 'üëç', 'üëé', '‚úä', 'üëä', 'ü§õ',
        'ü§ú', 'üëè', 'üôå', 'üëê', 'ü§≤', 'ü§ù', 'üôè', '‚úçÔ∏è',
        'üíÖ', 'ü§≥', 'üí™', 'ü¶æ', 'ü¶µ', 'ü¶ø', 'ü¶∂', 'üë£',
        'üëÇ', 'ü¶ª', 'üëÉ', 'üß†', 'ü¶∑', 'ü¶¥', 'üëÄ', 'üëÅÔ∏è',
        'üëÖ', 'üëÑ', 'üíã', 'ü©∏'
      ];

      // Emojis de objetos
      const objectEmojis = [
        'üíò', 'üíù', 'üíñ', 'üíó', 'üíì', 'üíû', 'üíï', 'üíü',
        '‚ù£Ô∏è', 'üíî', '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú',
        'ü§é', 'üñ§', 'ü§ç', 'üíØ', 'üí¢', 'üí•', 'üí´', 'üí¶',
        'üí®', 'üï≥Ô∏è', 'üí£', 'üí¨', 'üëÅÔ∏è‚Äçüó®Ô∏è', 'üó®Ô∏è', 'üóØÔ∏è', 'üí≠',
        'üí§', 'üëã', 'ü§ö', 'üñêÔ∏è', '‚úã', 'üññ', 'üëå', 'ü§å',
        'ü§è', '‚úåÔ∏è', 'ü§û', 'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ',
        'üëÜ', 'üñï', 'üëá', '‚òùÔ∏è', 'üëç', 'üëé', '‚úä', 'üëä',
        'ü§õ', 'ü§ú', 'üëè', 'üôå', 'üëê', 'ü§≤', 'ü§ù', 'üôè',
        '‚úçÔ∏è', 'üíÖ', 'ü§≥', 'üí™', 'ü¶æ', 'ü¶µ', 'ü¶ø', 'ü¶∂',
        'üë£', 'üëÇ', 'ü¶ª', 'üëÉ', 'üß†', 'ü¶∑', 'ü¶¥', 'üëÄ',
        'üëÅÔ∏è', 'üëÖ', 'üëÑ', 'üíã', 'ü©∏'
      ];

      // Emojis de s√≠mbolos
      const symbolEmojis = [
        '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç',
        'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ',
        'üíò', 'üíù', 'üíü', '‚òÆÔ∏è', '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâ', '‚ò∏Ô∏è',
        '‚ú°Ô∏è', 'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê', '‚õé', '‚ôà',
        '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê',
        '‚ôë', '‚ôí', '‚ôì', 'üÜî', '‚öõÔ∏è', 'üâë', '‚ò¢Ô∏è', '‚ò£Ô∏è',
        'üì¥', 'üì≥', 'üà∂', 'üàö', 'üà∏', 'üà∫', 'üà∑Ô∏è', '‚ú¥Ô∏è',
        'üÜö', 'üíÆ', 'üâê', '„äôÔ∏è', '„äóÔ∏è', 'üà¥', 'üàµ', 'üàπ',
        'üà≤', 'üÖ∞Ô∏è', 'üÖ±Ô∏è', 'üÜé', 'üÜë', 'üÖæÔ∏è', 'üÜò', '‚ùå',
        '‚≠ï', 'üõë', '‚õî', 'üìõ', 'üö´', 'üíØ', 'üí¢', '‚ô®Ô∏è',
        'üö∑', 'üöØ', 'üö≥', 'üö±', 'üîû', 'üìµ', 'üö≠', '‚ùó',
        '‚ùï', '‚ùì', '‚ùî', '‚ÄºÔ∏è', '‚ÅâÔ∏è', 'üîÖ', 'üîÜ', '„ÄΩÔ∏è',
        '‚ö†Ô∏è', 'üö∏', 'üî±', '‚öúÔ∏è', 'üî∞', '‚ôªÔ∏è', '‚úÖ', 'üàØ',
        'üíπ', '‚ùáÔ∏è', '‚ú≥Ô∏è', '‚ùé', 'üåê', 'üí†', '‚ìÇÔ∏è', 'üåÄ',
        'üí§', 'üèß', 'üöæ', '‚ôø', 'üÖøÔ∏è', 'üà≥', 'üàÇÔ∏è', 'üõÇ',
        'üõÉ', 'üõÑ', 'üõÖ', 'üöπ', 'üö∫', 'üöº', 'üöª', 'üöÆ',
        'üé¶', 'üì∂', 'üàÅ', 'üî£', '‚ÑπÔ∏è', 'üî§', 'üî°', 'üî†',
        'üÜñ', 'üÜó', 'üÜô', 'üÜí', 'üÜï', 'üÜì', '0Ô∏è‚É£', '1Ô∏è‚É£',
        '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£',
        'üîü', 'üî¢', '#Ô∏è‚É£', '*Ô∏è‚É£', '‚èèÔ∏è', '‚ñ∂Ô∏è', '‚è∏', '‚èØ',
        '‚èπ', '‚è∫', '‚è≠', '‚èÆ', '‚è©', '‚è™', '‚è´', '‚è¨',
        '‚óÄÔ∏è', 'üîº', 'üîΩ', '‚û°Ô∏è', '‚¨ÖÔ∏è', '‚¨ÜÔ∏è', '‚¨áÔ∏è', '‚ÜóÔ∏è',
        '‚ÜòÔ∏è', '‚ÜôÔ∏è', '‚ÜñÔ∏è', '‚ÜïÔ∏è', '‚ÜîÔ∏è', '‚Ü™Ô∏è', '‚Ü©Ô∏è', '‚§¥Ô∏è',
        '‚§µÔ∏è', 'üîÄ', 'üîÅ', 'üîÇ', 'üîÑ', 'üîÉ', 'üéµ', 'üé∂',
        '‚ûï', '‚ûñ', '‚ûó', '‚úñÔ∏è', '‚ôæ', 'üí≤', 'üí±', '‚Ñ¢',
        '¬©', '¬Æ', '„Ä∞Ô∏è', '‚û∞', '‚ûø', 'üîö', 'üîô', 'üîõ',
        'üîù', 'üîú', '‚úîÔ∏è', '‚òëÔ∏è', 'üîò', 'üî¥', 'üü†', 'üü°',
        'üü¢', 'üîµ', 'üü£', 'üü§', '‚ö´', '‚ö™', 'üü•', 'üüß',
        'üü®', 'üü©', 'üü¶', 'üü™', 'üü´', '‚¨õ', '‚¨ú', '‚óº',
        '‚óª', '‚óæ', '‚óΩ', '‚ñ™', '‚ñ´', 'üî∂', 'üî∑', 'üî∏',
        'üîπ', 'üî∫', 'üîª', 'üí†', 'üî≥', 'üî≤', 'üîà', 'üîá',
        'üîâ', 'üîä', 'üîî', 'üîï', 'üì£', 'üì¢', 'üëÅ‚Äçüó®', 'üí¨',
        'üí≠', 'üóØ', '‚ô†', '‚ô£', '‚ô•', '‚ô¶', 'üÉè', 'üé¥',
        'üÄÑ', 'üïê', 'üïë', 'üïí', 'üïì', 'üïî', 'üïï', 'üïñ',
        'üïó', 'üïò', 'üïô', 'üïö', 'üïõ', 'üïú', 'üïù', 'üïû',
        'üïü', 'üï†', 'üï°', 'üï¢', 'üï£', 'üï§', 'üï•', 'üï¶',
        'üïß'
      ];

      // Funci√≥n para renderizar emojis en un contenedor
      function renderEmojis(containerId, emojis) {
        const container = document.getElementById(containerId);
        if (!container) return;

        container.innerHTML = '';
        emojis.forEach(emoji => {
          const emojiElement = document.createElement('div');
          emojiElement.className = 'emoji-item';
          emojiElement.textContent = emoji;
          emojiElement.title = `Emoji: ${emoji}`;
          emojiElement.onclick = () => insertEmoji(emoji);
          container.appendChild(emojiElement);
        });
      }

      // Renderizar todas las categor√≠as
      renderEmojis('emojiFaces', faceEmojis);
      renderEmojis('emojiHands', handEmojis);
      renderEmojis('emojiObjects', objectEmojis);
      renderEmojis('emojiSymbols', symbolEmojis);

      console.log(`‚úÖ Emojis inicializados: ${faceEmojis.length + handEmojis.length + objectEmojis.length + symbolEmojis.length} emojis cargados`);
    }

    // Funci√≥n para insertar un emoji en el input
    function insertEmoji(emoji) {
      const input = document.getElementById('messageInput');
      if (!input) return;

      // Obtener posici√≥n actual del cursor
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const text = input.value;

      // Insertar el emoji en la posici√≥n del cursor
      input.value = text.substring(0, start) + emoji + text.substring(end);

      // Mover el cursor despu√©s del emoji insertado
      input.selectionStart = input.selectionEnd = start + emoji.length;

      // Enfocar el input y activar eventos
      input.focus();
      input.dispatchEvent(new Event('input', { bubbles: true }));

      // Mostrar notificaci√≥n breve
      showChatNotification(`Emoji ${emoji} insertado`, false);

      // Cerrar el selector de emojis despu√©s de insertar
      setTimeout(() => {
        const picker = document.getElementById('emojiPicker');
        if (picker && picker.classList.contains('show')) {
          picker.classList.remove('show');
        }
      }, 300);
    }

    // Cerrar el selector de emojis al hacer clic fuera de √©l
    document.addEventListener('click', function (event) {
      const picker = document.getElementById('emojiPicker');
      const emojiBtn = document.querySelector('.emoji-btn');

      if (picker && picker.classList.contains('show') &&
        !picker.contains(event.target) &&
        !emojiBtn.contains(event.target)) {
        picker.classList.remove('show');
      }
    });

    // Cerrar con la tecla Escape
    document.addEventListener('keydown', function (event) {
      if (event.key === 'Escape') {
        const picker = document.getElementById('emojiPicker');
        if (picker && picker.classList.contains('show')) {
          picker.classList.remove('show');
        }
      }
    });

    async function sendMessage() {
      console.log('üöÄ Funci√≥n sendMessage() llamada');
      console.log('Variables globales:', { userid, displayName, userPassword });

      if (spamBlocked) {
        console.log('‚ùå Bloqueado por spam');
        showChatNotification('Espera a que termine el bloqueo por spam', true);
        return;
      }

      const inp = document.getElementById("messageInput");
      console.log('Input encontrado:', inp ? 'S√≠' : 'No');
      if (!inp) {
        console.error('‚ùå No se encontr√≥ el input de mensaje');
        showChatNotification('Error: No se encontr√≥ el campo de mensaje', true);
        return;
      }

      const text = inp.value.trim();
      console.log('Texto a enviar:', text);
      if (!text) {
        console.log('‚ö†Ô∏è Texto vac√≠o, no se env√≠a');
        return;
      }

      // Verificar l√≠mite de caracteres
      if (text.length > 1000) {
        console.log('‚ùå Texto demasiado largo:', text.length);
        showChatNotification('El mensaje no puede tener m√°s de 1000 caracteres', true);
        inp.value = text.substring(0, 1000);
        return;
      }

      // Eliminar enlaces del texto
      const cleanText = text.replace(/https?:\/\/[^\s]+/g, '[enlace eliminado]').replace(/www\.[^\s]+/g, '[enlace eliminado]');
      console.log('Texto limpio:', cleanText);

      // Verificar spam
      if (checkSpam()) {
        console.log('‚ùå Bloqueado por sistema anti-spam');
        return;
      }

      try {
        console.log('üì§ Intentando enviar mensaje a Supabase...');
        console.log('Usuario (displayName):', displayName);
        console.log('UserID:', userid);

        // Verificar que displayName no sea null o undefined
        if (!displayName) {
          console.error('‚ùå ERROR: displayName es null o undefined');
          showChatNotification('Error: No se ha configurado el nombre de usuario', true);
          return;
        }

        // Intentar insertar con estructura m√≠nima primero
        const messageData = {
          username: displayName,
          content: cleanText,
          created_at: new Date().toISOString()
        };

        // Si estamos respondiendo a un mensaje, agregar informaci√≥n de respuesta
        if (replyingTo && replyMessageData) {
          console.log('Enviando respuesta al mensaje:', replyingTo);

          // Verificar si el mensaje al que se responde est√° eliminado
          if (replyMessageData.content === '[Mensaje eliminado]') {
            console.log('‚ö†Ô∏è El mensaje al que se responde est√° eliminado');
            showChatNotification('No se puede responder a un mensaje eliminado', true);
            return;
          }

          messageData.reply_to = replyingTo;
          messageData.reply_username = replyMessageData.username;

          // Limitar el contenido de respuesta a 200 caracteres
          let replyContent = replyMessageData.content;
          if (replyContent.length > 200) {
            replyContent = replyContent.substring(0, 200) + '...';
          }
          messageData.reply_content = replyContent;
        }

        console.log('Datos a insertar:', messageData);

        const { data, error } = await db.from("messages")
          .insert(messageData)
          .select();

        if (error) {
          console.error('‚ùå Error al insertar mensaje:', error);
          console.error('Detalles:', error.message);

          // Intentar sin el campo deleted si falla
          if (error.message.includes('column') && error.message.includes('deleted')) {
            console.log('‚ö†Ô∏è Intentando sin campo deleted...');
            delete messageData.deleted;

            const { data: data2, error: error2 } = await db.from("messages")
              .insert(messageData)
              .select();

            if (error2) {
              showChatNotification("Error al enviar: " + error2.message, true);
              return;
            }

            console.log('‚úÖ Mensaje insertado (sin campo deleted):', data2);
            showChatNotification('‚úÖ Mensaje enviado (modo compatible)');
          } else {
            showChatNotification("Error al enviar: " + error.message, true);
            return;
          }
        } else {
          console.log('‚úÖ Mensaje insertado correctamente:', data);
          showChatNotification('‚úÖ Mensaje enviado');
        }

        inp.value = "";
        sendTyping(false);

        // Limpiar el √°rea de respuesta si se estaba respondiendo a un mensaje
        if (replyingTo) {
          cancelReply();
        }

        // Limpiar mensajes antiguos despu√©s de enviar uno nuevo
        setTimeout(cleanOldMessages, 500);

        // Enfocar el input despu√©s de enviar
        inp.focus();
      } catch (error) {
        console.error("‚ùå Error en sendMessage:", error);
        console.error("Stack:", error.stack);
        showChatNotification("Error al enviar el mensaje. Intenta nuevamente.", true);
      }
    }

    /* ============================================================
       TYPING - MEJORADO COMO WHATSAPP
    ============================================================ */
    // NOTA: Las variables ya est√°n declaradas al principio del script
    // para evitar errores de referencia

    async function sendTyping(state = true) {
      try {
        const now = Date.now();

        // Debounce: evitar enviar muchas actualizaciones en poco tiempo
        if (state && (now - lastTypingSent) < TYPING_DEBOUNCE_TIME) {
          clearTimeout(typingDebounceTimer);
          typingDebounceTimer = setTimeout(() => sendTyping(true), TYPING_DEBOUNCE_TIME);
          return;
        }

        clearTimeout(typingTimeout);
        clearTimeout(typingDebounceTimer);

        if (!userid || !displayName) {
          return;
        }

        // Solo actualizar si el estado cambi√≥
        const typingData = {
          userid: userid,
          username: displayName,
          typing: state,
          updated_at: new Date().toISOString()
        };

        // Upsert usando userid como primary key
        const { error } = await db
          .from('typing')
          .upsert(typingData, { onConflict: 'userid' });

        if (!error) {
          lastTypingSent = now;
        }

        // Configurar timeout para establecer typing a false despu√©s de dejar de escribir
        if (state) {
          typingTimeout = setTimeout(async () => {
            const falseData = {
              userid: userid,
              username: displayName,
              typing: false,
              updated_at: new Date().toISOString()
            };

            await db
              .from('typing')
              .upsert(falseData, { onConflict: 'userid' })
              .catch(err => console.error("Error al establecer typing false:", err));
          }, TYPING_STOP_TIME);
        }
      } catch (error) {
        console.error("Error en sendTyping:", error);
      }
    }

    // NOTA: La suscripci√≥n a typing ahora se maneja en initTypingSubscription()
    // que se llama desde initChat() cuando el usuario hace login


    /* ============================================================
       LIMPIAR TYPING ANTIGUO
    ============================================================ */
    // Funci√≥n para limpiar registros de typing donde typing = false
    async function cleanOldTyping() {
      try {
        await db
          .from("typing")
          .delete()
          .eq("typing", false);
      } catch (error) {
        console.error("Error al limpiar typing:", error);
      }
    }

    // Limpiar cada 30 segundos
    setInterval(cleanOldTyping, 30000);

    // Limpiar al iniciar
    cleanOldTyping();

    // NOTA: Botones de depuraci√≥n removidos seg√∫n solicitud del usuario

    // Funci√≥n para probar la funcionalidad del chat
    async function testChatFunctionality() {
      console.log('üß™ Iniciando prueba de funcionalidad del chat...');

      // 1. Probar conexi√≥n a Supabase
      console.log('1. Probando conexi√≥n a Supabase...');
      try {
        const { data, error } = await db.from('messages').select('count').limit(1);
        if (error) {
          console.error('‚ùå Error de conexi√≥n:', error.message);
          showAlert('‚ùå Error de conexi√≥n', 'Error de conexi√≥n a Supabase:\n' + error.message, 'error');
          return;
        }
        console.log('‚úÖ Conexi√≥n exitosa');
      } catch (error) {
        console.error('‚ùå Error:', error);
        showAlert('‚ùå Error', 'Error: ' + error.message, 'error');
        return;
      }

      // 2. Probar inserci√≥n de mensaje
      console.log('2. Probando inserci√≥n de mensaje...');
      try {
        const testMessage = {
          username: 'usuario_prueba',
          content: 'Este es un mensaje de prueba ' + new Date().toLocaleTimeString(),
          created_at: new Date().toISOString()
        };

        const { data, error } = await db.from('messages').insert(testMessage).select();

        if (error) {
          console.error('‚ùå Error al insertar:', error.message);
          showAlert('‚ùå Error al insertar', 'Error al insertar mensaje:\n' + error.message + '\n\nPosible soluci√≥n: Ejecuta configurar_bd.sql en Supabase', 'error');
          return;
        }

        console.log('‚úÖ Mensaje insertado:', data);
        showAlert('‚úÖ Prueba exitosa', 'Mensaje de prueba insertado correctamente.\nID: ' + (data[0]?.id || 'N/A'), 'success');

        // 3. Probar carga de mensajes
        console.log('3. Probando carga de mensajes...');
        setTimeout(async () => {
          const { data: messages, error: loadError } = await db.from('messages')
            .select('*')
            .order('id', { ascending: false })
            .limit(5);

          if (loadError) {
            console.error('‚ùå Error al cargar:', loadError.message);
          } else {
            console.log('‚úÖ Mensajes cargados:', messages.length);

            // Limpiar mensaje de prueba
            if (data[0]?.id) {
              await db.from('messages').delete().eq('id', data[0].id);
              console.log('‚úÖ Mensaje de prueba eliminado');
            }
          }
        }, 1000);

      } catch (error) {
        console.error('‚ùå Error en prueba:', error);
        showAlert('‚ùå Error', 'Error: ' + error.message, 'error');
      }
    }



    /* ============================================================
       EVENT LISTENER SIMPLE Y DIRECTO PARA ENTER
    ============================================================ */
    // Soluci√≥n simple y directa para enviar con Enter
    document.addEventListener('DOMContentLoaded', function () {
      console.log('üîß Configurando event listener SIMPLE para Enter...');

      // Funci√≥n que se ejecuta cada vez que se presiona una tecla en cualquier input
      document.addEventListener('keydown', function (e) {
        // Solo procesar si la tecla es Enter
        if (e.key !== 'Enter') return;

        // Verificar si el elemento activo es el input de mensaje
        const activeElement = document.activeElement;
        if (activeElement && activeElement.id === 'messageInput') {
          console.log('üéØ Enter presionado en el input de mensaje');
          e.preventDefault(); // Prevenir comportamiento por defecto

          // Peque√±o delay para asegurar que el texto est√© capturado
          setTimeout(function () {
            sendMessage();
          }, 10);
        }
      });

      console.log('‚úÖ Event listener SIMPLE configurado');
    });

    // Tambi√©n agregar event listener cuando se muestra el chat
    const originalInitChat = window.initChat;
    if (originalInitChat) {
      window.initChat = function () {
        originalInitChat.apply(this, arguments);

        // Agregar event listener directo al input cuando est√© disponible
        setTimeout(function () {
          const messageInput = document.getElementById('messageInput');
          if (messageInput) {
            console.log('üîß Agregando event listener directo al input');

            // Event listener para keypress
            messageInput.addEventListener('keypress', function (e) {
              if (e.key === 'Enter') {
                console.log('Enter presionado (keypress directo)');
                e.preventDefault();
                sendMessage();
              }
            });

            // Event listener para keydown como respaldo
            messageInput.addEventListener('keydown', function (e) {
              if (e.key === 'Enter') {
                console.log('Enter presionado (keydown directo)');
                e.preventDefault();
                setTimeout(function () {
                  sendMessage();
                }, 10);
              }
            });

            console.log('‚úÖ Event listeners DIRECTOS agregados al input');
          }
        }, 200);

        // Inicializar sidebar despu√©s de un breve delay
        setTimeout(initSidebar, 100);
      };
    }

    /* ============================================================
SIDEBAR OCULTABLE - FUNCIONALIDAD CORREGIDA
============================================================ */

    // Funci√≥n para alternar (mostrar/ocultar) el sidebar
    function toggleSidebar() {
      console.log('üîÑ TOGGLE SIDEBAR llamado');

      const sidebar = document.getElementById('sidebar');
      const toggleBtn = document.querySelector('.sidebar-toggle');

      if (!sidebar || !toggleBtn) {
        console.error('‚ùå No se encontraron elementos del sidebar');
        return;
      }

      // Determinar el estado actual basado en las clases CSS
      const isCurrentlyHidden = sidebar.classList.contains('sidebar-hidden');

      // Alternar entre mostrar y ocultar
      if (isCurrentlyHidden) {
        sidebar.classList.remove('sidebar-hidden');
        // Mover bot√≥n a la derecha (sidebar visible)
        toggleBtn.style.left = '230px';
        console.log('‚úÖ Sidebar ahora VISIBLE');
      } else {
        sidebar.classList.add('sidebar-hidden');
        // Mover bot√≥n a la izquierda (sidebar oculto)
        toggleBtn.style.left = '0';
        console.log('‚úÖ Sidebar ahora OCULTO');
      }

      // Actualizar √≠cono
      updateToggleIcon();
      console.log('‚úÖ √çcono actualizado');

      // Mostrar informaci√≥n de depuraci√≥n
      console.log('üìä Estado despu√©s del toggle:');
      console.log('- Posici√≥n bot√≥n:', getComputedStyle(toggleBtn).left);
      console.log('- Tiene clase sidebar-hidden:', sidebar.classList.contains('sidebar-hidden'));
    }

    // Funci√≥n para actualizar el √≠cono
    function updateToggleIcon() {
      const toggleIcon = document.querySelector('.toggle-icon');
      if (toggleIcon) {
        // Determinar el estado actual basado en las clases CSS
        const sidebar = document.getElementById('sidebar');
        let currentVisible = true; // Valor por defecto

        if (sidebar) {
          currentVisible = !sidebar.classList.contains('sidebar-hidden');
        }

        const newIcon = currentVisible ? '‚óÄ' : '‚ñ∂';
        console.log(`üîÑ Actualizando √≠cono: '${toggleIcon.textContent}' ‚Üí '${newIcon}' (visible: ${currentVisible})`);
        toggleIcon.textContent = newIcon;
      } else {
        console.warn('‚ö†Ô∏è No se encontr√≥ el elemento .toggle-icon');
      }
    }

    // Funci√≥n para inicializar el sidebar
    function initSidebar() {
      console.log('üîß INICIALIZANDO SIDEBAR...');

      const sidebar = document.getElementById('sidebar');
      const toggleBtn = document.querySelector('.sidebar-toggle');

      console.log('Elementos encontrados:');
      console.log('- Sidebar:', sidebar ? '‚úÖ' : '‚ùå');
      console.log('- Bot√≥n toggle:', toggleBtn ? '‚úÖ' : '‚ùå');

      if (!sidebar || !toggleBtn) {
        console.error('‚ùå No se encontraron elementos del sidebar');
        return;
      }

      // Configurar event listener para el bot√≥n toggle (solo una vez)
      if (!toggleBtn._sidebarListenerAdded) {
        toggleBtn.addEventListener('click', toggleSidebar);
        toggleBtn._sidebarListenerAdded = true;
        console.log('‚úÖ Event listener configurado para el bot√≥n');
      } else {
        console.log('‚ÑπÔ∏è Event listener ya estaba configurado');
      }

      // Configuraci√≥n por defecto seg√∫n el dispositivo
      const isMobile = window.innerWidth <= 768;
      console.log(`üì± Es m√≥vil/tableta (‚â§768px): ${isMobile ? 'S√≠' : 'No'} (ancho: ${window.innerWidth}px)`);

      if (isMobile) {
        // En m√≥viles/tabletas: oculto por defecto
        sidebar.classList.add('sidebar-hidden');
        // Posicionar bot√≥n a la izquierda
        toggleBtn.style.left = '0';
        console.log('‚úÖ Sidebar configurado como OCULTO (m√≥vil/tableta)');
      } else {
        // En computadoras/pantallas grandes: visible por defecto
        sidebar.classList.remove('sidebar-hidden');
        // Posicionar bot√≥n a la derecha
        toggleBtn.style.left = '230px';
        console.log('‚úÖ Sidebar configurado como VISIBLE (escritorio)');
      }

      // Actualizar √≠cono
      updateToggleIcon();
      console.log('‚úÖ √çcono actualizado');

      // Mostrar informaci√≥n de depuraci√≥n
      console.log('üìä Estado final:');
      console.log('- Tiene clase sidebar-hidden:', sidebar.classList.contains('sidebar-hidden'));
      console.log('- Posici√≥n bot√≥n:', getComputedStyle(toggleBtn).left);
      console.log('- Display bot√≥n:', getComputedStyle(toggleBtn).display);

      // Escuchar cambios de tama√±o de ventana
      let currentIsMobile = isMobile;
      window.addEventListener('resize', function () {
        const newIsMobile = window.innerWidth <= 768;

        // Solo actualizar si cambia entre m√≥vil/escritorio
        if ((newIsMobile && !currentIsMobile) || (!newIsMobile && currentIsMobile)) {
          console.log(`üîÑ Cambio de dispositivo detectado: ${currentIsMobile ? 'M√≥vil' : 'Escritorio'} ‚Üí ${newIsMobile ? 'M√≥vil' : 'Escritorio'}`);
          currentIsMobile = newIsMobile;

          // Actualizar din√°micamente sin recargar
          const sidebar = document.getElementById('sidebar');
          const toggleBtn = document.querySelector('.sidebar-toggle');
          if (sidebar && toggleBtn) {
            if (newIsMobile) {
              // Cambi√≥ a m√≥vil: ocultar sidebar
              sidebar.classList.add('sidebar-hidden');
              // Posicionar bot√≥n a la izquierda
              toggleBtn.style.left = '0';
              console.log('‚úÖ Sidebar actualizado a OCULTO (cambio a m√≥vil)');
            } else {
              // Cambi√≥ a escritorio: mostrar sidebar
              sidebar.classList.remove('sidebar-hidden');
              // Posicionar bot√≥n a la derecha
              toggleBtn.style.left = '230px';
              console.log('‚úÖ Sidebar actualizado a VISIBLE (cambio a escritorio)');
            }
            // Actualizar √≠cono
            updateToggleIcon();
          }
        }
      });

      console.log('‚úÖ Sidebar inicializado correctamente');
    }

    // initSidebar se llamar√° desde la funci√≥n initChat modificada

    /* ============================================================
       FUNCI√ìN DE PRUEBA PARA VERIFICAR QUE TODO FUNCIONE
    ============================================================ */
    // Esta funci√≥n se puede llamar desde la consola del navegador para probar
    window.testChat = function () {
      console.log('=== PRUEBA DEL CHAT ===');
      console.log('1. Verificando variables globales:');
      console.log('- userid:', userid);
      console.log('- displayName:', displayName);
      console.log('- userPassword:', userPassword ? 'Definida' : 'No definida');

      console.log('\n2. Verificando elementos del DOM:');
      console.log('- #messageInput:', document.getElementById('messageInput') ? '‚úÖ Existe' : '‚ùå No existe');
      console.log('- Bot√≥n de enviar:', document.querySelector('#inputArea button') ? '‚úÖ Existe' : '‚ùå No existe');
      console.log('- #chat:', document.getElementById('chat') ? '‚úÖ Existe' : '‚ùå No existe');

      console.log('\n3. Verificando funciones:');
      console.log('- sendMessage:', typeof sendMessage === 'function' ? '‚úÖ Existe' : '‚ùå No existe');
      console.log('- showChatNotification:', typeof showChatNotification === 'function' ? '‚úÖ Existe' : '‚ùå No existe');
      console.log('- db:', db ? '‚úÖ Inicializado' : '‚ùå No inicializado');

      console.log('\n4. Probando notificaci√≥n:');
      if (typeof showChatNotification === 'function') {
        showChatNotification('‚úÖ Prueba exitosa - El sistema de notificaciones funciona');
      } else {
        console.error('‚ùå showChatNotification no es una funci√≥n');
      }

      console.log('\n=== FIN DE LA PRUEBA ===');
      console.log('Para probar el env√≠o de mensajes, escribe en el input y presiona Enter o haz clic en el bot√≥n Enviar.');
    };

    console.log('‚úÖ Chat configurado. Para probar, ejecuta testChat() en la consola.');

    // Funci√≥n para probar el sistema de respuestas
    window.testReplySystem = function () {
      console.log('=== PRUEBA DEL SISTEMA DE RESPUESTAS ===');

      // Verificar que las funciones de respuesta existan
      console.log('1. Verificando funciones:');
      console.log('- startReply:', typeof startReply === 'function' ? '‚úÖ Existe' : '‚ùå No existe');
      console.log('- cancelReply:', typeof cancelReply === 'function' ? '‚úÖ Existe' : '‚ùå No existe');

      // Verificar variables
      console.log('2. Verificando variables:');
      console.log('- replyingTo:', replyingTo);
      console.log('- replyMessageData:', replyMessageData);

      // Verificar elementos del DOM
      console.log('3. Verificando elementos del DOM:');
      console.log('- #replyArea:', document.getElementById('replyArea') ? '‚úÖ Existe' : '‚ùå No existe');
      console.log('- #replyAuthor:', document.getElementById('replyAuthor') ? '‚úÖ Existe' : '‚ùå No existe');
      console.log('- #replyText:', document.getElementById('replyText') ? '‚úÖ Existe' : '‚ùå No existe');

      // Probar simulaci√≥n de respuesta
      console.log('4. Probando simulaci√≥n de respuesta...');
      if (typeof startReply === 'function') {
        // Simular respuesta a un mensaje
        startReply(999, 'UsuarioPrueba', 'Este es un mensaje de prueba para responder');

        setTimeout(() => {
          console.log('‚úÖ Sistema de respuestas funcionando correctamente');
          showChatNotification('‚úÖ Sistema de respuestas probado exitosamente');

          // Cancelar despu√©s de 3 segundos
          setTimeout(() => {
            if (typeof cancelReply === 'function') {
              cancelReply();
              console.log('‚úÖ Cancelaci√≥n de respuesta funcionando');
            }
          }, 3000);
        }, 1000);
      } else {
        console.error('‚ùå La funci√≥n startReply no existe');
      }

      console.log('=== FIN DE LA PRUEBA ===');
    };

    console.log('Para probar respuestas, ejecuta testReplySystem() en la consola.');

    // Funci√≥n para probar el sistema de emojis
    window.testEmojiSystem = function () {
      console.log('=== PRUEBA DEL SISTEMA DE EMOJIS ===');

      // Verificar que las funciones de emojis existan
      console.log('1. Verificando funciones:');
      console.log('- toggleEmojiPicker:', typeof toggleEmojiPicker === 'function' ? '‚úÖ Existe' : '‚ùå No existe');
      console.log('- initEmojis:', typeof initEmojis === 'function' ? '‚úÖ Existe' : '‚ùå No existe');
      console.log('- insertEmoji:', typeof insertEmoji === 'function' ? '‚úÖ Existe' : '‚ùå No existe');

      // Verificar elementos del DOM
      console.log('2. Verificando elementos del DOM:');
      console.log('- .emoji-btn:', document.querySelector('.emoji-btn') ? '‚úÖ Existe' : '‚ùå No existe');
      console.log('- #emojiPicker:', document.getElementById('emojiPicker') ? '‚úÖ Existe' : '‚ùå No existe');
      console.log('- #emojiFaces:', document.getElementById('emojiFaces') ? '‚úÖ Existe' : '‚ùå No existe');
      console.log('- #emojiHands:', document.getElementById('emojiHands') ? '‚úÖ Existe' : '‚ùå No existe');
      console.log('- #emojiObjects:', document.getElementById('emojiObjects') ? '‚úÖ Existe' : '‚ùå No existe');
      console.log('- #emojiSymbols:', document.getElementById('emojiSymbols') ? '‚úÖ Existe' : '‚ùå No existe');

      // Probar apertura del selector
      console.log('3. Probando apertura del selector...');
      if (typeof toggleEmojiPicker === 'function') {
        toggleEmojiPicker();

        setTimeout(() => {
          const picker = document.getElementById('emojiPicker');
          if (picker && picker.classList.contains('show')) {
            console.log('‚úÖ Selector de emojis se abre correctamente');

            // Probar inserci√≥n de emoji
            console.log('4. Probando inserci√≥n de emoji...');
            if (typeof insertEmoji === 'function') {
              // Simular inserci√≥n de un emoji
              const originalInputValue = document.getElementById('messageInput').value;
              insertEmoji('üòä');

              setTimeout(() => {
                const newInputValue = document.getElementById('messageInput').value;
                if (newInputValue.includes('üòä')) {
                  console.log('‚úÖ Emoji insertado correctamente');
                  showChatNotification('‚úÖ Sistema de emojis probado exitosamente');

                  // Restaurar valor original
                  document.getElementById('messageInput').value = originalInputValue;

                  // Cerrar selector despu√©s de 2 segundos
                  setTimeout(() => {
                    if (picker.classList.contains('show')) {
                      toggleEmojiPicker();
                      console.log('‚úÖ Selector de emojis se cierra correctamente');
                    }
                  }, 2000);
                } else {
                  console.error('‚ùå El emoji no se insert√≥ correctamente');
                }
              }, 500);
            } else {
              console.error('‚ùå La funci√≥n insertEmoji no existe');
            }
          } else {
            console.error('‚ùå El selector de emojis no se abri√≥');
          }
        }, 500);
      } else {
        console.error('‚ùå La funci√≥n toggleEmojiPicker no existe');
      }

      console.log('=== FIN DE LA PRUEBA ===');
    };

    console.log('Para probar emojis, ejecuta testEmojiSystem() en la consola.');

    // Funci√≥n para probar la l√≥gica de mostrar/ocultar campo de nombre
    window.testDisplayNameLogic = function () {
      console.log('=== PRUEBA DE L√ìGICA DE CAMPO DE NOMBRE ===');

      // Limpiar primero
      localStorage.removeItem('remember_session');
      localStorage.removeItem('userid');
      localStorage.removeItem('display_name');

      // Escenario 1: Usuario vac√≠o
      console.log('\n1. ESCENARIO: Usuario vac√≠o');
      document.getElementById('loginUsername').value = '';
      document.getElementById('loginUsername').dispatchEvent(new Event('input'));
      setTimeout(() => {
        console.log('- Campo visible:', document.getElementById('displayNameGroup').style.display !== 'none' ? 'S√ç (ERROR)' : 'NO (CORRECTO)');

        // Escenario 2: Usuario que coincide con localStorage
        console.log('\n2. ESCENARIO: Usuario en localStorage');
        localStorage.setItem('remember_session', 'true');
        localStorage.setItem('userid', '@usuariotest');
        localStorage.setItem('display_name', 'Usuario Test');

        document.getElementById('loginUsername').value = '@usuariotest';
        document.getElementById('loginUsername').dispatchEvent(new Event('input'));

        setTimeout(() => {
          console.log('- Campo visible:', document.getElementById('displayNameGroup').style.display !== 'none' ? 'S√ç (ERROR)' : 'NO (CORRECTO)');
          console.log('- Display name autocompletado:', document.getElementById('loginDisplayName').value);

          // Escenario 3: Usuario nuevo (no en localStorage, no en BD)
          console.log('\n3. ESCENARIO: Usuario nuevo');
          document.getElementById('loginUsername').value = '@usuariocompletamentenuevo';
          document.getElementById('loginUsername').dispatchEvent(new Event('input'));

          setTimeout(() => {
            console.log('- Campo visible:', document.getElementById('displayNameGroup').style.display !== 'none' ? 'S√ç (CORRECTO)' : 'NO (ERROR)');

            // Limpiar
            localStorage.removeItem('remember_session');
            localStorage.removeItem('userid');
            localStorage.removeItem('display_name');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginDisplayName').value = '';

            console.log('\n=== FIN DE LA PRUEBA ===');
            console.log('Resumen:');
            console.log('1. Usuario vac√≠o ‚Üí Campo OCULTO (correcto)');
            console.log('2. Usuario en localStorage ‚Üí Campo OCULTO (correcto)');
            console.log('3. Usuario nuevo ‚Üí Campo VISIBLE (correcto)');
          }, 350);
        }, 350);
      }, 100);
    };

    // Funci√≥n para simular usuario existente en BD (para pruebas)
    window.simulateExistingUserInDB = function (username, displayName) {
      console.log(`Simulando usuario existente en BD: ${username} (${displayName})`);
      console.log('Nota: Esta funci√≥n solo simula el comportamiento, no crea usuarios reales en la BD.');
      console.log('Para probar realmente, necesitas crear el usuario en la base de datos Supabase.');

      // Mostrar instrucciones
      console.log('\nPara probar usuario existente en BD:');
      console.log('1. Ve a Supabase y crea un usuario de prueba');
      console.log('2. Usa ese username en el formulario de login');
      console.log('3. El campo de nombre deber√≠a permanecer OCULTO');
    };

    console.log('Para probar la l√≥gica de campo de nombre, ejecuta testDisplayNameLogic() en la consola.');

    /* ============================================================
FUNCI√ìN DE PRUEBA PARA EL SIDEBAR
============================================================ */
    window.testSidebar = function () {
      console.log('üîç === PRUEBA DEL SIDEBAR ===');

      const sidebar = document.getElementById('sidebar');
      const isVisible = sidebar ? !sidebar.classList.contains('sidebar-hidden') : false;

      console.log('Estado actual del sidebar:', isVisible ? 'Visible' : 'Oculto');
      console.log('Ancho de pantalla:', window.innerWidth, 'px');
      console.log('Es m√≥vil/tableta (‚â§768px):', window.innerWidth <= 768 ? 'S√≠' : 'No');
      console.log('Clase sidebar-hidden presente:', sidebar ? sidebar.classList.contains('sidebar-hidden') : 'N/A');

      if (sidebar) {
        console.log('‚úÖ Sidebar encontrado');
        console.log('Clases del sidebar:', sidebar.className);
        console.log('Tiene clase sidebar-hidden:', sidebar.classList.contains('sidebar-hidden'));
        console.log('Estilos del sidebar:');
        console.log('- transform:', getComputedStyle(sidebar).transform);
        console.log('- width:', getComputedStyle(sidebar).width);
        console.log('- display:', getComputedStyle(sidebar).display);
        console.log('- position:', getComputedStyle(sidebar).position);
      } else {
        console.error('‚ùå Sidebar NO encontrado');
      }

      const toggleBtn = document.querySelector('.sidebar-toggle');
      if (toggleBtn) {
        console.log('‚úÖ Bot√≥n toggle encontrado');
        console.log('Estilos del bot√≥n:');
        console.log('- display:', getComputedStyle(toggleBtn).display);
        console.log('- visibility:', getComputedStyle(toggleBtn).visibility);
        console.log('- opacity:', getComputedStyle(toggleBtn).opacity);
        console.log('- position:', getComputedStyle(toggleBtn).position);
        console.log('- left:', getComputedStyle(toggleBtn).left);
        console.log('- top:', getComputedStyle(toggleBtn).top);
        console.log('- z-index:', getComputedStyle(toggleBtn).zIndex);
        console.log('- width:', getComputedStyle(toggleBtn).width);
        console.log('- height:', getComputedStyle(toggleBtn).height);
      } else {
        console.error('‚ùå Bot√≥n toggle NO encontrado');
      }

      const toggleIcon = document.querySelector('.toggle-icon');
      if (toggleIcon) {
        console.log('‚úÖ √çcono encontrado:', toggleIcon.textContent);
      } else {
        console.error('‚ùå √çcono NO encontrado');
      }

      console.log('\nüîß Comandos disponibles:');
      console.log('- toggleSidebar(): Alternar entre mostrar/ocultar');
      console.log('- updateToggleIcon(): Actualizar √≠cono del bot√≥n');
      console.log('- initSidebar(): Reinicializar sidebar');
      console.log('- testSidebar(): Ejecutar esta prueba');
      console.log('=== FIN DE LA PRUEBA ===');
    };

    console.log('Para probar el sidebar, ejecuta testSidebar() en la consola.');

  </script>
</body>

</html>